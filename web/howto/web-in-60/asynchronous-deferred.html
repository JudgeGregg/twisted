<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asynchronous Responses (via Deferred) &mdash; Twisted 22.8.0.post0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Interrupted Responses" href="interrupted.html" />
    <link rel="prev" title="Asynchronous Responses" href="asynchronous.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Twisted
          </a>
              <div class="version">
                22.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Twisted Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Twisted Web</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../web-overview.html">Overview of Twisted Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="../using-twistedweb.html">Configuring and Using the Twisted Web Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web-development.html">Web Application Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../twisted-templates.html">HTML Templating with twisted.web.template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xmlrpc.html">Creating XML-RPC Servers and Clients with Twisted</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Twisted Web In 60 Seconds</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="static-content.html">Serving Static Content From a Directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-content.html">Generating a Page Dynamically</a></li>
<li class="toctree-l4"><a class="reference internal" href="static-dispatch.html">Static URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-dispatch.html">Dynamic URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom-codes.html">Custom Response Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="handling-posts.html">Handling POSTs</a></li>
<li class="toctree-l4"><a class="reference internal" href="other-request-bodies.html">Other Request Bodies</a></li>
<li class="toctree-l4"><a class="reference internal" href="rpy-scripts.html">rpy scripts (or, how to save yourself some typing)</a></li>
<li class="toctree-l4"><a class="reference internal" href="asynchronous.html">Asynchronous Responses</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Asynchronous Responses (via Deferred)</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupted.html">Interrupted Responses</a></li>
<li class="toctree-l4"><a class="reference internal" href="logging-errors.html">Logging Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="access-logging.html">Access Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="wsgi.html">WSGI</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-auth.html">HTTP Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-basics.html">Session Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-store.html">Storing Objects in the Session</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-endings.html">Session Endings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../resource-templates.html">Light Weight Templating With Resource Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client.html">Using the Twisted Web Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development of Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sponsors/index.html">Sponsors of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Twisted</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Twisted Web</a> &raquo;</li>
          <li><a href="../index.html">Developer Guides</a> &raquo;</li>
          <li><a href="index.html">Twisted Web In 60 Seconds</a> &raquo;</li>
      <li>Asynchronous Responses (via Deferred)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/web/howto/web-in-60/asynchronous-deferred.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="asynchronous-responses-via-deferred">
<h1>Asynchronous Responses (via Deferred)<a class="headerlink" href="#asynchronous-responses-via-deferred" title="Permalink to this headline"></a></h1>
<p>The previous example had a <code class="xref py py-class docutils literal notranslate"><span class="pre">Resource</span></code> that generates its response
asynchronously rather than immediately upon the call to its render
method. Though it was a useful demonstration of the <code class="docutils literal notranslate"><span class="pre">NOT_DONE_YET</span></code>
feature of Twisted Web, the example didn’t reflect what a realistic application
might want to do. This example introduces <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code> , the Twisted class which is used
to provide a uniform interface to many asynchronous events, and shows you an
example of using a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> -returning API to generate an
asynchronous response to a request in Twisted Web.</p>
<p><code class="docutils literal notranslate"><span class="pre">Deferred</span></code> is the result of two consequences of the
asynchronous programming approach. First, asynchronous code is
frequently (if not always) concerned with some data (in Python, an
object) which is not yet available but which probably will be
soon. Asynchronous code needs a way to define what will be done to the
object once it does exist. It also needs a way to define how to handle
errors in the creation or acquisition of that object. These two needs
are satisfied by the <em>callbacks</em> and <em>errbacks</em> of
a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> . Callbacks are added to
a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> with <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.addCallback</span></code> ; errbacks
are added with <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.addErrback</span></code> . When the
object finally does exist, it is passed to <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.callback</span></code> which passes it
on to the callback added with <code class="docutils literal notranslate"><span class="pre">addCallback</span></code> . Similarly, if
an error occurs, <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.errback</span></code> is called and
the error is passed along to the errback added
with <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> . Second, the events that make
asynchronous code actually work often take many different,
incompatible forms. <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> acts as the uniform
interface which lets different parts of an asynchronous application
interact and isolates them from implementation details they shouldn’t
be concerned with.</p>
<p>That’s almost all there is to <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> . To solidify your new
understanding, now consider this rewritten version
of <code class="docutils literal notranslate"><span class="pre">DelayedResource</span></code> which uses a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> -based delay
API. It does exactly the same thing as the <a class="reference internal" href="asynchronous.html"><span class="doc">previous example</span></a> . Only the implementation is different.</p>
<p>First, the example must import that new API that was just mentioned, <code class="xref py py-func docutils literal notranslate"><span class="pre">deferLater</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">deferLater</span>
</pre></div>
</div>
<p>Next, all the other imports (these are the same as last time):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
</pre></div>
</div>
<p>With the imports done, here’s the first part of
the <code class="docutils literal notranslate"><span class="pre">DelayedResource</span></code> implementation. Again, this part of
the code is identical to the previous version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
<p>Next we need to define the render method. Here’s where things
change a bit. Instead of using <code class="xref py py-meth docutils literal notranslate"><span class="pre">callLater</span></code> ,
We’re going to use <code class="xref py py-func docutils literal notranslate"><span class="pre">deferLater</span></code> this
time. <code class="docutils literal notranslate"><span class="pre">deferLater</span></code> accepts a reactor, delay (in seconds, as
with <code class="docutils literal notranslate"><span class="pre">callLater</span></code> ), and a function to call after the delay
to produce that elusive object discussed in the description
of <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> s. We’re also going to
use <code class="docutils literal notranslate"><span class="pre">_delayedRender</span></code> as the callback to add to
the <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> returned by <code class="docutils literal notranslate"><span class="pre">deferLater</span></code> . Since
it expects the request object as an argument, we’re going to set up
the <code class="docutils literal notranslate"><span class="pre">deferLater</span></code> call to return a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code>
which has the request object as its result.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">deferLater</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> referenced by <code class="docutils literal notranslate"><span class="pre">d</span></code> now needs to
have the <code class="docutils literal notranslate"><span class="pre">_delayedRender</span></code> callback added to it. Once this
is done, <code class="docutils literal notranslate"><span class="pre">_delayedRender</span></code> will be called with the result
of <code class="docutils literal notranslate"><span class="pre">d</span></code> (which will be <code class="docutils literal notranslate"><span class="pre">request</span></code> , of course — the
result of <code class="docutils literal notranslate"><span class="pre">(lambda:</span> <span class="pre">request)()</span></code> ).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, the render method still needs to return <code class="docutils literal notranslate"><span class="pre">NOT_DONE_YET</span></code> ,
for exactly the same reasons as it did in the previous version of the
example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>
</pre></div>
</div>
<p>And with that, <code class="docutils literal notranslate"><span class="pre">DelayedResource</span></code> is now implemented
based on a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> . The example still isn’t very
realistic, but remember that since <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> s offer a
uniform interface to many different asynchronous event sources, this
code now resembles a real application even more closely; you could
easily replace <code class="docutils literal notranslate"><span class="pre">deferLater</span></code> with
another <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> -returning API and suddenly you might
have a resource that does something useful.</p>
<p>Finally, here’s the complete, uninterrupted example source, as an rpy script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">deferLater</span>
<span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">deferLater</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>

<span class="n">resource</span> <span class="o">=</span> <span class="n">DelayedResource</span><span class="p">()</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="asynchronous.html" class="btn btn-neutral float-left" title="Asynchronous Responses" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="interrupted.html" class="btn btn-neutral float-right" title="Interrupted Responses" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Twisted Matrix Labs. Ver 22.8.0.post0. Built on 2022-09-16.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>