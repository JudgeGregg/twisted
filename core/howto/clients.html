<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing Clients &mdash; Twisted 22.8.0.post0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Test-driven development with Twisted" href="trial.html" />
    <link rel="prev" title="Writing Servers" href="servers.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Twisted
          </a>
              <div class="version">
                22.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="servers.html">Writing Servers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing Clients</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#protocol">Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-single-use-clients">Simple, single-use clients</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clientfactory">ClientFactory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-higher-level-example-irclogbot">A Higher-Level Example: ircLogBot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="process.html">Using Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3"><a class="reference internal" href="logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sponsors/index.html">Sponsors of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
      <li>Writing Clients</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/core/howto/clients.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-clients">
<h1>Writing Clients<a class="headerlink" href="#writing-clients" title="Permalink to this headline"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>Twisted is a framework designed to be very flexible, and let you write
powerful clients. The cost of this flexibility is a few layers in the way
to writing your client. This document covers creating clients that can be
used for TCP, SSL and Unix sockets. UDP is covered <a class="reference internal" href="udp.html"><span class="doc">in a different document</span></a> .</p>
<p>At the base, the place where you actually implement the protocol parsing
and handling, is the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> class. This class will usually be
descended
from <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.Protocol</span></code> . Most
protocol handlers inherit either from this class or from one of its
convenience children. An instance of the protocol class will be instantiated
when you connect to the server and will go away when the connection is
finished.  This means that persistent configuration is not saved in the
<code class="docutils literal notranslate"><span class="pre">Protocol</span></code> .</p>
<p>The persistent configuration is kept in a <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class,
which usually inherits from <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.Factory</span></code>
(or <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.ClientFactory</span></code> : see below).
The default factory class just instantiates the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> and then sets the protocol’s <code class="docutils literal notranslate"><span class="pre">factory</span></code> attribute to point to itself (the factory).
This lets the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> access, and possibly modify, the persistent configuration.</p>
</section>
<section id="protocol">
<h2>Protocol<a class="headerlink" href="#protocol" title="Permalink to this headline"></a></h2>
<p>As mentioned above, this and auxiliary classes and functions are where
most of the code is. A Twisted protocol handles data in an asynchronous
manner. This means that the protocol never waits for an event, but rather
responds to events as they arrive from the network.</p>
<p>Here is a simple example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>

<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>This is one of the simplest protocols.  It just writes whatever it reads
from the connection to standard output. There are many events it does not
respond to. Here is an example of a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> responding to
another event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">WelcomeMessage</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Hello server, I am the client!</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
</pre></div>
</div>
<p>This protocol connects to the server, sends it a welcome message, and
then terminates the connection.</p>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">connectionMade</span></code> event is
usually where set up of the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> object happens, as well as
any initial greetings (as in the
<code class="docutils literal notranslate"><span class="pre">WelcomeMessage</span></code> protocol above). Any tearing down of
<code class="docutils literal notranslate"><span class="pre">Protocol</span></code> -specific objects is done in <code class="xref py py-meth docutils literal notranslate"><span class="pre">connectionLost</span></code> .</p>
</section>
<section id="simple-single-use-clients">
<h2>Simple, single-use clients<a class="headerlink" href="#simple-single-use-clients" title="Permalink to this headline"></a></h2>
<p>In many cases, the protocol only needs to connect to the server once,
and the code just wants to get a connected instance of the protocol. In
those cases <code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.internet.endpoints</span></code> provides
the appropriate API, and in particular <code class="xref py py-func docutils literal notranslate"><span class="pre">connectProtocol</span></code> which takes a
protocol instance rather than a factory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ClientEndpoint</span><span class="p">,</span> <span class="n">connectProtocol</span>

<span class="k">class</span> <span class="nc">Greeter</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;MESSAGE </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gotProtocol</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">,</span> <span class="s2">&quot;This is sent in a second&quot;</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">)</span>

<span class="n">point</span> <span class="o">=</span> <span class="n">TCP4ClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">connectProtocol</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">Greeter</span><span class="p">())</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">gotProtocol</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Regardless of the type of client endpoint, the way to set up a new
connection is simply pass it to <code class="xref py py-func docutils literal notranslate"><span class="pre">connectProtocol</span></code> along with a
protocol instance.  This means it’s easy to change the mechanism you’re
using to connect, without changing the rest of your program.  For example,
to run the greeter example over SSL, the only change required is to
instantiate an
<code class="xref py py-class docutils literal notranslate"><span class="pre">SSL4ClientEndpoint</span></code> instead of a
<code class="docutils literal notranslate"><span class="pre">TCP4ClientEndpoint</span></code> .  To take advantage of this, functions and
methods which initiates a new connection should generally accept an
endpoint as an argument and let the caller construct it, rather than taking
arguments like ‘host’ and ‘port’ and constructing its own.</p>
<p>For more information on different ways you can make outgoing connections
to different types of endpoints, as well as parsing strings into endpoints,
see <a class="reference internal" href="endpoints.html"><span class="doc">the documentation for the endpoints API</span></a> .</p>
<p>You may come across code using <code class="xref py py-class docutils literal notranslate"><span class="pre">ClientCreator</span></code> , an older API which is not as flexible as
the endpoint API.  Rather than calling <code class="docutils literal notranslate"><span class="pre">connect</span></code> on an endpoint,
such code will look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">ClientCreator</span>

<span class="o">...</span>

<span class="n">creator</span> <span class="o">=</span> <span class="n">ClientCreator</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">Greeter</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">creator</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">gotProtocol</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>In general, the endpoint API should be preferred in new code, as it lets
the caller select the method of connecting.</p>
</section>
<section id="clientfactory">
<h2>ClientFactory<a class="headerlink" href="#clientfactory" title="Permalink to this headline"></a></h2>
<p>Still, there’s plenty of code out there that uses lower-level APIs, and
a few features (such as automatic reconnection) have not been
re-implemented with endpoints yet, so in some cases they may be more
convenient to use.</p>
<p>To use the lower-level connection APIs, you will need to call one of the <em>reactor.connect*</em> methods directly.
For these cases, you need a <code class="xref py py-class docutils literal notranslate"><span class="pre">ClientFactory</span></code> .
The <code class="docutils literal notranslate"><span class="pre">ClientFactory</span></code> is in charge of creating the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> and also receives events relating to the connection state.
This allows it to do things like reconnect in the event of a connection error.
Here is an example of a simple <code class="docutils literal notranslate"><span class="pre">ClientFactory</span></code> that uses the <code class="docutils literal notranslate"><span class="pre">Echo</span></code> protocol (above) and also prints what state the connection is in.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">ClientFactory</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>

<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EchoClientFactory</span><span class="p">(</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">startedConnecting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started to connect.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Echo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lost connection.  Reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection failed. Reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</pre></div>
</div>
<p>To connect this <code class="docutils literal notranslate"><span class="pre">EchoClientFactory</span></code> to a server, you could use
this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">EchoClientFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that <code class="xref py py-meth docutils literal notranslate"><span class="pre">clientConnectionFailed</span></code> is called when a connection could not be established,
and that <code class="xref py py-meth docutils literal notranslate"><span class="pre">clientConnectionLost</span></code> is called when a connection was made and then disconnected.</p>
<section id="reactor-client-apis">
<h3>Reactor Client APIs<a class="headerlink" href="#reactor-client-apis" title="Permalink to this headline"></a></h3>
<section id="connecttcp">
<h4>connectTCP<a class="headerlink" href="#connecttcp" title="Permalink to this headline"></a></h4>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">IReactorTCP.connectTCP</span></code> provides support for IPv4 and IPv6 TCP clients.
The <code class="docutils literal notranslate"><span class="pre">host</span></code> argument it accepts can be either a hostname or an IP address literal.
In the case of a hostname, the reactor will automatically resolve the name to an IP address before attempting the connection.
This means that for a hostname with multiple address records, reconnection attempts may not always go to the same server (see below).
It also means that there is name resolution overhead for each connection attempt.
If you are creating many short-lived connections (typically around hundreds or thousands per second) then you may want to resolve the hostname to an address first and then pass the address to <code class="docutils literal notranslate"><span class="pre">connectTCP</span></code> instead.</p>
</section>
</section>
<section id="reconnection">
<h3>Reconnection<a class="headerlink" href="#reconnection" title="Permalink to this headline"></a></h3>
<p>Often, the connection of a client will be lost unintentionally due to
network problems. One way to reconnect after a disconnection would be to
call <code class="docutils literal notranslate"><span class="pre">connector.connect()</span></code> when the connection is lost:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">ClientFactory</span>

<span class="k">class</span> <span class="nc">EchoClientFactory</span><span class="p">(</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
<p>The connector passed as the first argument is the interface between a
connection and a protocol. When the connection fails and the factory
receives the <code class="docutils literal notranslate"><span class="pre">clientConnectionLost</span></code> event, the factory can
call <code class="docutils literal notranslate"><span class="pre">connector.connect()</span></code> to start the connection over again
from scratch.</p>
<p>However, most programs that want this functionality should
implement <code class="xref py py-class docutils literal notranslate"><span class="pre">ReconnectingClientFactory</span></code> instead,
which tries to reconnect if a connection is lost or fails and which
exponentially delays repeated reconnect attempts.</p>
<p>Here is the <code class="docutils literal notranslate"><span class="pre">Echo</span></code> protocol implemented with
a <code class="docutils literal notranslate"><span class="pre">ReconnectingClientFactory</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">ReconnectingClientFactory</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>

<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EchoClientFactory</span><span class="p">(</span><span class="n">ReconnectingClientFactory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">startedConnecting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started to connect.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resetting reconnection delay&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resetDelay</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Echo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lost connection.  Reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="n">ReconnectingClientFactory</span><span class="o">.</span><span class="n">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connection failed. Reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="n">ReconnectingClientFactory</span><span class="o">.</span><span class="n">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span>
                                                         <span class="n">reason</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="a-higher-level-example-irclogbot">
<h2>A Higher-Level Example: ircLogBot<a class="headerlink" href="#a-higher-level-example-irclogbot" title="Permalink to this headline"></a></h2>
<section id="overview-of-irclogbot">
<h3>Overview of ircLogBot<a class="headerlink" href="#overview-of-irclogbot" title="Permalink to this headline"></a></h3>
<p>The clients so far have been fairly simple.
A more complicated example comes with Twisted Words in the <code class="docutils literal notranslate"><span class="pre">doc/words/examples</span></code> directory.</p>
<p><a class="reference download internal" download="" href="../../_downloads/18a8015a7e1bd8f856b2997b093731f1/ircLogBot.py"><code class="xref download docutils literal notranslate"><span class="pre">ircLogBot.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="c1"># See LICENSE for details.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">An example IRC log bot - logs a channel&#39;s events to a file.</span>

<span class="sd">If someone says the bot&#39;s name in the channel followed by a &#39;:&#39;,</span>
<span class="sd">e.g.</span>

<span class="sd">    &lt;foo&gt; logbot: hello!</span>

<span class="sd">the bot will reply:</span>

<span class="sd">    &lt;logbot&gt; foo: I am a log bot</span>

<span class="sd">Run this script with two arguments, the channel name the bot should</span>
<span class="sd">connect to, and file to log to, e.g.:</span>

<span class="sd">    $ python ircLogBot.py test test.log</span>

<span class="sd">will log channel #test to the file &#39;test.log&#39;.</span>

<span class="sd">To run the script:</span>

<span class="sd">    $ python ircLogBot.py &lt;channel&gt; &lt;file&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span>

<span class="c1"># twisted imports</span>
<span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>


<span class="k">class</span> <span class="nc">MessageLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An independent logger class (because separation of application</span>
<span class="sd">    and protocol logic is a good thing).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a message to the file.&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;[%H:%M:%S]&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">LogBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A logging IRC bot.&quot;&quot;&quot;</span>

    <span class="n">nickname</span> <span class="o">=</span> <span class="s2">&quot;twistedbot&quot;</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">MessageLogger</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[connected at </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;[disconnected at </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># callbacks for events</span>

    <span class="k">def</span> <span class="nf">signedOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when bot has successfully signed on to server.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">joined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will get called when the bot joins the channel.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[I have joined </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will get called when the bot receives a message.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check to see if they&#39;re sending me a private message</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;It isn&#39;t nice to whisper!  Play nice with the group.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Otherwise check to see if it is a message directed at me</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: I am a log bot&quot;</span> <span class="o">%</span> <span class="n">user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will get called when the bot sees someone do an action.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># irc callbacks</span>

    <span class="k">def</span> <span class="nf">irc_NICK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when an IRC user changes their nickname.&quot;&quot;&quot;</span>
        <span class="n">old_nick</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_nick</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old_nick</span><span class="si">}</span><span class="s2"> is now known as </span><span class="si">{</span><span class="n">new_nick</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># For fun, override the method that determines how a nickname is changed on</span>
    <span class="c1"># collisions. The default method appends an underscore.</span>
    <span class="k">def</span> <span class="nf">alterCollidedNick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nickname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an altered version of a nickname that caused a collision in an</span>
<span class="sd">        effort to create an unused related name for subsequent registration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">nickname</span> <span class="o">+</span> <span class="s2">&quot;^&quot;</span>


<span class="k">class</span> <span class="nc">LogBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A factory for LogBots.</span>

<span class="sd">    A new protocol instance will be created each time we connect to the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">LogBot</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">clientConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If we get disconnected, reconnect to server.&quot;&quot;&quot;</span>
        <span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clientConnectionFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connection failed:&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># initialize logging</span>
    <span class="n">log</span><span class="o">.</span><span class="n">startLogging</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    <span class="c1"># create factory protocol and application</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">LogBotFactory</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># connect factory to this host and port</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s2">&quot;irc.freenode.net&quot;</span><span class="p">,</span> <span class="mi">6667</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="c1"># run bot</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ircLogBot.py</span></code> connects to an IRC server, joins a channel, and
logs all traffic on it to a file. It demonstrates some of the
connection-level logic of reconnecting on a lost connection, as well as
storing persistent data in the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> .</p>
</section>
<section id="persistent-data-in-the-factory">
<h3>Persistent Data in the Factory<a class="headerlink" href="#persistent-data-in-the-factory" title="Permalink to this headline"></a></h3>
<p>Since the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> instance is recreated each time the
connection is made, the client needs some way to keep track of data that
should be persisted. In the case of the logging bot, it needs to know which
channel it is logging, and where to log it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>

<span class="k">class</span> <span class="nc">LogBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">MessageLogger</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[connected at </span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())))</span>

    <span class="k">def</span> <span class="nf">signedOn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LogBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">LogBot</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
<p>When the protocol is created, it gets a reference to the factory as
<code class="docutils literal notranslate"><span class="pre">self.factory</span></code> . It can then access attributes of the factory in
its logic. In the case of <code class="docutils literal notranslate"><span class="pre">LogBot</span></code> , it opens the file and
connects to the channel stored in the factory.</p>
<p>Factories have a default implementation of <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code>.
It does the same thing the example above does using the <code class="docutils literal notranslate"><span class="pre">protocol</span></code> attribute of the factory to create the protocol instance.
In the example above, the factory could be rewritten to look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LogBotFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">LogBot</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</pre></div>
</div>
</section>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline"></a></h2>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">Protocol</span></code> class used throughout this document is a base implementation of <code class="xref py py-class docutils literal notranslate"><span class="pre">IProtocol</span></code> used in most Twisted applications for convenience.
To learn about the complete <code class="docutils literal notranslate"><span class="pre">IProtocol</span></code> interface, see the API documentation for <code class="xref py py-class docutils literal notranslate"><span class="pre">IProtocol</span></code> .</p>
<p>The <code class="docutils literal notranslate"><span class="pre">transport</span></code> attribute used in some examples in this
document provides the <code class="xref py py-class docutils literal notranslate"><span class="pre">ITCPTransport</span></code> interface. To learn
about the complete interface, see the API documentation
for <code class="xref py py-class docutils literal notranslate"><span class="pre">ITCPTransport</span></code> .</p>
<p>Interface classes are a way of specifying what methods and attributes an
object has and how they behave. See the <a class="reference internal" href="components.html"><span class="doc">Components: Interfaces and Adapters</span></a> document for more information on
using interfaces in Twisted.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="servers.html" class="btn btn-neutral float-left" title="Writing Servers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="trial.html" class="btn btn-neutral float-right" title="Test-driven development with Twisted" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Twisted Matrix Labs. Ver 22.8.0.post0. Built on 2022-09-16.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>