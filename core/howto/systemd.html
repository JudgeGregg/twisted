<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploying Twisted with systemd &mdash; Twisted 22.8.0.post0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Logging with twisted.logger" href="logger.html" />
    <link rel="prev" title="Writing a twistd Plugin" href="tap.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Twisted
          </a>
              <div class="version">
                22.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="servers.html">Writing Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="process.html">Using Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Deploying Twisted with systemd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="#basic-systemd-service-configuration">Basic Systemd Service Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#socket-activation">Socket Activation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations-and-known-issues">Limitations and Known Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sponsors/index.html">Sponsors of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
      <li>Deploying Twisted with systemd</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/core/howto/systemd.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deploying-twisted-with-systemd">
<h1>Deploying Twisted with systemd<a class="headerlink" href="#deploying-twisted-with-systemd" title="Permalink to this headline"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>In this tutorial you will learn how to start a Twisted service using <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.
You will also learn how to start the service using <code class="docutils literal notranslate"><span class="pre">socket</span> <span class="pre">activation</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples in this tutorial demonstrate how to launch a Twisted web server, but the same techniques apply to any Twisted service.</p>
</div>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<p>Twisted</p>
<blockquote>
<div><p>You will need a version of Twisted &gt;= 12.2 for the socket activation section of this tutorial.</p>
<p>This tutorial was written on a Fedora 18 Linux operating system with a system wide installation of Twisted and Twisted Web.</p>
<p>If you have installed Twisted locally eg in your home directory or in a virtualenv, you will need to modify the paths in some of the following examples.</p>
<p>Test your Twisted installation by starting a <code class="docutils literal notranslate"><span class="pre">twistd</span> <span class="pre">web</span></code> server on TCP port 8080 with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>twistd --nodaemon web --listen tcp:8080 --path /srv/www/www.example.com/static
<span class="go">2013-01-28 13:21:35+0000 [-] Log opened.</span>
<span class="go">2013-01-28 13:21:35+0000 [-] twistd 12.3.0 (/usr/bin/python 2.7.3) starting up.</span>
<span class="go">2013-01-28 13:21:35+0000 [-] reactor class: twisted.internet.epollreactor.EPollReactor.</span>
<span class="go">2013-01-28 13:21:35+0000 [-] Site starting on 8080</span>
<span class="go">2013-01-28 13:21:35+0000 [-] Starting factory &lt;twisted.web.server.Site instance at 0x7f57eb66efc8&gt;</span>
</pre></div>
</div>
<p>This assumes that you have the following static web page in the following directory structure:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>tree /srv/
<span class="go">/srv/</span>
<span class="go">└── www</span>
<span class="go">    └── www.example.com</span>
<span class="go">        └── static</span>
<span class="go">            └── index.html</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!doctype html&gt;
&lt;html lang=en&gt;
  &lt;head&gt;
    &lt;meta charset=utf-8&gt;
    &lt;title&gt;Example Site&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Example Site&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Now try connecting to <a class="reference external" href="http://localhost:8080">http://localhost:8080</a> in your web browser.</p>
<p>If you do not see your web page or if <code class="docutils literal notranslate"><span class="pre">twistd</span></code> didn’t start, you should investigate and fix the problem before continuing.</p>
</div></blockquote>
</section>
<section id="basic-systemd-service-configuration">
<h2>Basic Systemd Service Configuration<a class="headerlink" href="#basic-systemd-service-configuration" title="Permalink to this headline"></a></h2>
<p>The essential configuration file for a <code class="docutils literal notranslate"><span class="pre">systemd</span></code> service is the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">service</a> file.</p>
<p>Later in this tutorial, you will learn about some other types of configuration file, which are used to control when and how your service is started.</p>
<p>But we will begin by configuring <code class="docutils literal notranslate"><span class="pre">systemd</span></code> to start a Twisted web server immediately on system boot.</p>
<section id="create-a-systemd-service-file">
<h3>Create a systemd.service file<a class="headerlink" href="#create-a-systemd-service-file" title="Permalink to this headline"></a></h3>
<p>Create the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">service</a> file at <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/www.example.com.service</span></code> with the following content:</p>
<p><a class="reference download internal" download="" href="../../_downloads/72b9a2bc520f3178e6f3c7b62237da2d/www.example.com.static.service"><code class="xref download docutils literal notranslate"><span class="pre">/etc/systemd/system/www.example.com.service</span></code></a></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Example Web Server</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/twistd \</span><span class="w"></span>
<span class="w">    </span><span class="na">--nodaemon \</span><span class="w"></span>
<span class="w">    </span><span class="na">--pidfile</span><span class="o">=</span><span class="w"> </span><span class="s">\</span><span class="w"></span>
<span class="w">    </span><span class="na">web --listen tcp:8080 --path .</span><span class="w"></span>

<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/srv/www/www.example.com/static</span><span class="w"></span>

<span class="na">User</span><span class="o">=</span><span class="s">nobody</span><span class="w"></span>
<span class="na">Group</span><span class="o">=</span><span class="s">nobody</span><span class="w"></span>

<span class="na">Restart</span><span class="o">=</span><span class="s">always</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</pre></div>
</div>
<p>This configuration file contains the following note worthy directives:</p>
<p>ExecStart</p>
<blockquote>
<div><p>Always include the full path to <code class="docutils literal notranslate"><span class="pre">twistd</span></code> in case you have multiple versions installed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--nodaemon</span></code> flag makes <code class="docutils literal notranslate"><span class="pre">twistd</span></code> run in the foreground.
Systemd works best with child processes that remain in the foreground.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--pidfile=</span></code> flag prevents <code class="docutils literal notranslate"><span class="pre">twistd</span></code> from writing a pidfile.
A pidfile is not necessary when Twisted runs as a foreground process.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--path</span></code> flag specifies the location of the website files.
In this example we use “.” which makes <code class="docutils literal notranslate"><span class="pre">twistd</span></code> serve files from its current working directory (see below).</p>
</div></blockquote>
<p>WorkingDirectory</p>
<blockquote>
<div><p>Systemd can configure the working environment of its child processes.</p>
<p>In this example the working directory of <code class="docutils literal notranslate"><span class="pre">twistd</span></code> is set to that of the static website.</p>
</div></blockquote>
<p>User / Group</p>
<blockquote>
<div><p>Systemd can also control the effective user and group of its child processes.</p>
<p>This example uses an un-privileged user “nobody” and un-privileged group “nobody”.</p>
<p>This is an important security measure which ensures that the Twisted sub-process can not access restricted areas of the file system.</p>
</div></blockquote>
<p>Restart</p>
<blockquote>
<div><p>Systemd can automatically restart a child process if it exits or crashes unexpectedly.</p>
<p>In this example the <code class="docutils literal notranslate"><span class="pre">Restart</span></code> option is set to <code class="docutils literal notranslate"><span class="pre">always</span></code>, which ensures that <code class="docutils literal notranslate"><span class="pre">twistd</span></code> will be restarted under all circumstances.</p>
</div></blockquote>
<p>WantedBy</p>
<blockquote>
<div><p>Systemd service dependencies are controlled by <code class="docutils literal notranslate"><span class="pre">WantedBy</span></code> and <code class="docutils literal notranslate"><span class="pre">RequiredBy</span></code> directives in the <code class="docutils literal notranslate"><span class="pre">[Install]</span></code> section of configuration file.</p>
<p>The special <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.special.html#multi-user.target">multi-user.target</a> is used in this example so that <code class="docutils literal notranslate"><span class="pre">systemd</span></code> starts the <code class="docutils literal notranslate"><span class="pre">twistd</span> <span class="pre">web</span></code> service when it reaches the multi-user stage of the boot sequence.</p>
</div></blockquote>
<p>There are many more service directives which are documented in the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.directives.html">systemd.directives man page</a>.</p>
</section>
<section id="reload-systemd">
<h3>Reload <code class="docutils literal notranslate"><span class="pre">systemd</span></code><a class="headerlink" href="#reload-systemd" title="Permalink to this headline"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl daemon-reload
</pre></div>
</div>
<p>This forces <code class="docutils literal notranslate"><span class="pre">systemd</span></code> to read the new configuration file.</p>
<p>Always run <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">daemon-reload</span></code> after changing any of the <code class="docutils literal notranslate"><span class="pre">systemd</span></code> configuration files.</p>
</section>
<section id="start-the-service">
<h3>Start the service<a class="headerlink" href="#start-the-service" title="Permalink to this headline"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl start www.example.com
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">twistd</span></code> should now be running and listening on TCP port 8080. You can verify this using the <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span></code> command. eg</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl status www.example.com.service
<span class="go">www.example.com.service - Example Web Server</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.service; enabled)</span>
<span class="go">          Active: active (running) since Mon 2013-01-28 16:16:26 GMT; 1s ago</span>
<span class="go">        Main PID: 10695 (twistd)</span>
<span class="go">          CGroup: name=systemd:/system/www.example.com.service</span>
<span class="go">                  └─10695 /usr/bin/python /usr/bin/twistd --nodaemon --pidfile= web --listen tcp:8080 --path .</span>

<span class="go">Jan 28 16:16:26 zorin.lan systemd[1]: Starting Example Web Server...</span>
<span class="go">Jan 28 16:16:26 zorin.lan systemd[1]: Started Example Web Server.</span>
<span class="go">Jan 28 16:16:26 zorin.lan twistd[10695]: 2013-01-28 16:16:26+0000 [-] Log opened.</span>
<span class="go">Jan 28 16:16:26 zorin.lan twistd[10695]: 2013-01-28 16:16:26+0000 [-] twistd 12.1.0 (/usr/bin/python 2.7.3) starting up.</span>
<span class="go">Jan 28 16:16:26 zorin.lan twistd[10695]: 2013-01-28 16:16:26+0000 [-] reactor class: twisted.internet.epollreactor.EPollReactor.</span>
<span class="go">Jan 28 16:16:26 zorin.lan twistd[10695]: 2013-01-28 16:16:26+0000 [-] Site starting on 8080</span>
<span class="go">Jan 28 16:16:26 zorin.lan twistd[10695]: 2013-01-28 16:16:26+0000 [-] Starting factory &lt;twisted.web.server.Site instance at 0x159b758&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span></code> command is convenient because it shows you both the current status of the service and a short log of the service output.</p>
<p>This is especially useful for debugging and diagnosing service startup problems.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">twistd</span></code> subprocess will log messages to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> and <code class="docutils literal notranslate"><span class="pre">systemd</span></code> will log these messages to syslog.
You can verify this by monitoring the syslog messages or by using the new <code class="docutils literal notranslate"><span class="pre">journalctl</span></code> tool in Fedora.</p>
<p>See the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemctl.html">systemctl man page</a> for details of other <code class="docutils literal notranslate"><span class="pre">systemctl</span></code> command line options.</p>
</section>
<section id="enable-the-service">
<h3>Enable the service<a class="headerlink" href="#enable-the-service" title="Permalink to this headline"></a></h3>
<p>We’ve seen how to start the service manually, but now we need to “enable” it so that it starts automatically at boot time.</p>
<p>Enable the service with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl <span class="nb">enable</span> www.example.com.service
<span class="go">ln -s &#39;/etc/systemd/system/www.example.com.service&#39; &#39;/etc/systemd/system/multi-user.target.wants/www.example.com.service&#39;</span>
</pre></div>
</div>
<p>This creates a symlink to the service file in the <code class="docutils literal notranslate"><span class="pre">multi-user.target.wants</span></code> directory.</p>
<p>The Twisted web server will now be started automatically at boot time.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">multi-user.target</span></code> is an example of a <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.special.html">“special” systemd unit</a>.
Later in this tutorial you will learn how to use another special unit - the <code class="docutils literal notranslate"><span class="pre">sockets.target</span></code>.</p>
</section>
<section id="test-that-the-service-is-automatically-restarted">
<h3>Test that the service is automatically restarted<a class="headerlink" href="#test-that-the-service-is-automatically-restarted" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Restart=always</span></code> option in the <code class="docutils literal notranslate"><span class="pre">systemd.service</span></code> file ensures that <code class="docutils literal notranslate"><span class="pre">systemd</span></code> will restart the <code class="docutils literal notranslate"><span class="pre">twistd</span></code> process if and when it exits unexpectedly.</p>
<p>You can read about other <code class="docutils literal notranslate"><span class="pre">Restart</span></code> options in the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">systemd.service man page</a>.</p>
<p>Try killing the <code class="docutils literal notranslate"><span class="pre">twistd</span></code> process and then checking its status again:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo <span class="nb">kill</span> <span class="m">12543</span>

<span class="gp">$ </span>systemctl status www.example.com.service
<span class="go">www.example.com.service - Example Web Server</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.service; disabled)</span>
<span class="go">          Active: active (running) since Mon 2013-01-28 17:47:37 GMT; 1s ago</span>
<span class="go">        Main PID: 12611 (twistd)</span>
</pre></div>
</div>
<p>The “Active” time stamp shows that the <code class="docutils literal notranslate"><span class="pre">twistd</span></code> process was restarted within 1 second.</p>
<p>Now stop the service before you proceed to the next section.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl stop www.example.com.service

<span class="gp">$ </span>systemctl status www.example.com.service
<span class="go">www.example.com.service - Example Web Server</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.service; enabled)</span>
<span class="go">          Active: inactive (dead) since Mon 2013-01-28 16:51:12 GMT; 1s ago</span>
<span class="go">         Process: 10695 ExecStart=/usr/bin/twistd --nodaemon --pidfile= web --port 8080 --path . (code=exited, status=0/SUCCESS)</span>
</pre></div>
</div>
</section>
</section>
<section id="socket-activation">
<h2>Socket Activation<a class="headerlink" href="#socket-activation" title="Permalink to this headline"></a></h2>
<p>First you need to understand what “socket activation” is.
This extract from the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/daemon.html">systemd daemon man page</a> explains it quite clearly.</p>
<blockquote>
<div><p>In a socket-based activation scheme the creation and binding of the listening socket as primary communication channel of daemons to local (and sometimes remote) clients is moved out of the daemon code and into the init system.</p>
<p>Based on per-daemon configuration the init system installs the sockets and then hands them off to the spawned process as soon as the respective daemon is to be started.</p>
<p>Optionally activation of the service can be delayed until the first inbound traffic arrives at the socket, to implement on-demand activation of daemons.</p>
<p>However, the primary advantage of this scheme is that all providers and all consumers of the sockets can be started in parallel as soon as all sockets are established.</p>
<p>In addition to that daemons can be restarted with losing only a minimal number of client transactions or even any client request at all (the latter is particularly true for state-less protocols, such as DNS or syslog), because the socket stays bound and accessible during the restart, and all requests are queued while the daemon cannot process them.</p>
</div></blockquote>
<p>Another benefit of socket activation is that <code class="docutils literal notranslate"><span class="pre">systemd</span></code> can listen on privileged ports and start Twisted with privileges already dropped. This allows a Twisted service to be configured and restarted by a non-root user.</p>
<p>Twisted (since version 12.2) includes a <a class="reference external" href="endpoints">systemd endpoint API and a corresponding string ports syntax</a> which allows a Twisted service to inherit a listening socket from <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.</p>
<p>The following example builds on the previous example, demonstrating how to enable socket activation for a simple Twisted web server.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before continuing, stop the previous example service with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl stop www.example.com.service
</pre></div>
</div>
</div>
<section id="create-a-systemd-socket-file">
<h3>Create a systemd.socket file<a class="headerlink" href="#create-a-systemd-socket-file" title="Permalink to this headline"></a></h3>
<p>Create the <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.socket.html">systemd.socket</a> file at <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/www.example.com.socket</span></code> with the following content:</p>
<p><a class="reference download internal" download="" href="../../_downloads/15d3d1c9ef713d470f4c23b7a4a33a35/www.example.com.socket"><code class="xref download docutils literal notranslate"><span class="pre">/etc/systemd/system/www.example.com.socket</span></code></a></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Socket]</span><span class="w"></span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">0.0.0.0:80</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span><span class="w"></span>
</pre></div>
</div>
<p>This configuration file contains the following important directives:</p>
<p>ListenStream=0.0.0.0:80</p>
<blockquote>
<div><p>This option configures <code class="docutils literal notranslate"><span class="pre">systemd</span></code> to create a listening TCP socket bound to all local IPv4 addresses on port 80.</p>
</div></blockquote>
<p>WantedBy=sockets.target</p>
<blockquote>
<div><p>This is
a <a class="reference external" href="http://www.freedesktop.org/software/systemd/man/systemd.special.html#sockets.target">special target</a> used by all socket activated services. <code class="docutils literal notranslate"><span class="pre">systemd</span></code> will automatically bind to all such socket activation ports during boot up.</p>
</div></blockquote>
<p>You also need to modify the <code class="docutils literal notranslate"><span class="pre">systemd.service</span></code> file as follows:</p>
<p><a class="reference download internal" download="" href="../../_downloads/46e7ff42172684ab45760a325baabccb/www.example.com.socketactivated.service"><code class="xref download docutils literal notranslate"><span class="pre">/etc/systemd/system/www.example.com.service</span></code></a></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Example Web Server</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/twistd \</span><span class="w"></span>
<span class="w">    </span><span class="na">--nodaemon \</span><span class="w"></span>
<span class="w">    </span><span class="na">--pidfile</span><span class="o">=</span><span class="w"> </span><span class="s">\</span><span class="w"></span>
<span class="w">    </span><span class="na">web --listen systemd:domain</span><span class="o">=</span><span class="s">INET:index=0 --path .</span><span class="w"></span>

<span class="na">NonBlocking</span><span class="o">=</span><span class="s">true</span><span class="w"></span>

<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/srv/www/www.example.com/static</span><span class="w"></span>

<span class="na">User</span><span class="o">=</span><span class="s">nobody</span><span class="w"></span>
<span class="na">Group</span><span class="o">=</span><span class="s">nobody</span><span class="w"></span>

<span class="na">Restart</span><span class="o">=</span><span class="s">always</span><span class="w"></span>
</pre></div>
</div>
<p>Note the following important directives and changes:</p>
<p>ExecStart</p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">domain=INET</span></code> endpoint argument makes <code class="docutils literal notranslate"><span class="pre">twistd</span></code> treat the inherited file descriptor as an IPv4 socket.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">index=0</span></code> endpoint argument makes <code class="docutils literal notranslate"><span class="pre">twistd</span></code> adopt the first file descriptor inherited from <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.</p>
<p>Socket activation is also technically possible with other socket families and types, but Twisted currently only accepts IPv4 and IPv6 TCP sockets. See <a class="reference internal" href="#limitations"><span class="std std-ref">Limitations and Known Issues</span></a> below.</p>
</div></blockquote>
<p>NonBlocking</p>
<blockquote>
<div><p>This must be set to <code class="docutils literal notranslate"><span class="pre">true</span></code> to ensure that <code class="docutils literal notranslate"><span class="pre">systemd</span></code> passes non-blocking sockets to Twisted.</p>
</div></blockquote>
<p>[Install]</p>
<blockquote>
<div><p>In this example, the <code class="docutils literal notranslate"><span class="pre">[Install]</span></code> section has been moved to the socket configuration file.</p>
</div></blockquote>
<p>Reload <code class="docutils literal notranslate"><span class="pre">systemd</span></code> so that it reads the updated configuration files.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl daemon-reload
</pre></div>
</div>
</section>
<section id="start-and-enable-the-socket">
<h3>Start and enable the socket<a class="headerlink" href="#start-and-enable-the-socket" title="Permalink to this headline"></a></h3>
<p>You can now start <code class="docutils literal notranslate"><span class="pre">systemd</span></code> listening on the socket with the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl start www.example.com.socket
</pre></div>
</div>
<p>This command refers specifically to the socket configuration file, <strong>not</strong> the service file.</p>
<p><code class="docutils literal notranslate"><span class="pre">systemd</span></code> should now be listening on port 80</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl status www.example.com.socket
<span class="go">www.example.com.socket</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.socket; disabled)</span>
<span class="go">          Active: active (listening) since Tue 2013-01-29 14:53:17 GMT; 7s ago</span>

<span class="go">Jan 29 14:53:17 zorin.lan systemd[1]: Listening on www.example.com.socket.</span>
</pre></div>
</div>
<p>But <code class="docutils literal notranslate"><span class="pre">twistd</span></code> should not yet have started.
You can verify this using the <code class="docutils literal notranslate"><span class="pre">systemctl</span></code> command. eg</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl status www.example.com.service
<span class="go">www.example.com.service - Example Web Server</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.service; static)</span>
<span class="go">          Active: inactive (dead) since Tue 2013-01-29 14:48:42 GMT; 6min ago</span>
</pre></div>
</div>
<p>Enable the socket, so that it will be started automatically with the other socket activated services during boot up.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo systemctl <span class="nb">enable</span> www.example.com.socket
<span class="go">ln -s &#39;/etc/systemd/system/www.example.com.socket&#39; &#39;/etc/systemd/system/sockets.target.wants/www.example.com.socket&#39;</span>
</pre></div>
</div>
</section>
<section id="activate-the-port-to-start-the-service">
<h3>Activate the port to start the service<a class="headerlink" href="#activate-the-port-to-start-the-service" title="Permalink to this headline"></a></h3>
<p>Now try connecting to <a class="reference external" href="http://localhost:80">http://localhost:80</a> in your web browser.</p>
<p><code class="docutils literal notranslate"><span class="pre">systemd</span></code> will accept the connection and start <code class="docutils literal notranslate"><span class="pre">twistd</span></code>, passing it the listening socket.
You can verify this by using systemctl to report the status of the service. eg</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>systemctl status www.example.com.service
<span class="go">www.example.com.service - Example Web Server</span>
<span class="go">          Loaded: loaded (/etc/systemd/system/www.example.com.service; static)</span>
<span class="go">          Active: active (running) since Tue 2013-01-29 15:02:20 GMT; 3s ago</span>
<span class="go">        Main PID: 25605 (twistd)</span>
<span class="go">          CGroup: name=systemd:/system/www.example.com.service</span>
<span class="go">                  └─25605 /usr/bin/python /usr/bin/twistd --nodaemon --pidfile= web --port systemd:domain=INET:index=0 --path .</span>

<span class="go">Jan 29 15:02:20 zorin.lan systemd[1]: Started Example Web Server.</span>
<span class="go">Jan 29 15:02:20 zorin.lan twistd[25605]: 2013-01-29 15:02:20+0000 [-] Log opened.</span>
<span class="go">Jan 29 15:02:20 zorin.lan twistd[25605]: 2013-01-29 15:02:20+0000 [-] twistd 12.1.0 (/usr/bin/python 2.7.3) starting up.</span>
<span class="go">Jan 29 15:02:20 zorin.lan twistd[25605]: 2013-01-29 15:02:20+0000 [-] reactor class: twisted.internet.epollreactor.EPollReactor.</span>
<span class="go">Jan 29 15:02:20 zorin.lan twistd[25605]: 2013-01-29 15:02:20+0000 [-] Site starting on 80</span>
<span class="go">Jan 29 15:02:20 zorin.lan twistd[25605]: 2013-01-29 15:02:20+0000 [-] Starting factory &lt;twisted.web.server.Site instance at 0x24be758&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline"></a></h2>
<p>In this tutorial you have learned how to deploy a Twisted service using <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.
You have also learned how the service can be started on demand, using socket activation.</p>
</section>
<section id="limitations-and-known-issues">
<span id="limitations"></span><h2>Limitations and Known Issues<a class="headerlink" href="#limitations-and-known-issues" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>Twisted can not accept datagram sockets from <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.</p></li>
<li><p>Twisted does not support listening for SSL connections on sockets inherited from <code class="docutils literal notranslate"><span class="pre">systemd</span></code>.</p></li>
</ol>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.freedesktop.org/wiki/Software/systemd/">systemd Documentation</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tap.html" class="btn btn-neutral float-left" title="Writing a twistd Plugin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="logger.html" class="btn btn-neutral float-right" title="Logging with twisted.logger" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Twisted Matrix Labs. Ver 22.8.0.post0. Built on 2022-09-16.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>