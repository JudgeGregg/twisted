

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Logging with twisted.logger &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Twisted’s Legacy Logging System: twisted.python.log" href="logging.html" />
    <link rel="prev" title="Deploying Twisted with systemd" href="systemd.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="servers.html">Writing Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="process.html">Using Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Logging with twisted.logger</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-basics">The Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-for-emitting-applications">Usage for emitting applications</a></li>
<li class="toctree-l4"><a class="reference internal" href="#saving-events-for-later">Saving events for later</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementing-an-observer">Implementing an observer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-an-observer">Registering an observer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-global-log-publisher">The global log publisher</a></li>
<li class="toctree-l4"><a class="reference internal" href="#provided-log-observers">Provided log observers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compatibility-with-standard-library-logging">Compatibility with standard library logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compatibility-with-twisted-python-log">Compatibility with twisted.python.log</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Logging with twisted.logger</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/core/howto/logger.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="logging-with-twisted-logger">
<span id="core-howto-logger-main"></span><h1>Logging with twisted.logger<a class="headerlink" href="#logging-with-twisted-logger" title="Permalink to this heading">¶</a></h1>
<div class="section" id="the-basics">
<h2>The Basics<a class="headerlink" href="#the-basics" title="Permalink to this heading">¶</a></h2>
<p>Logging consists of two main endpoints: applications that emit events, and observers that receive and handle those events.
An event is simply a <code class="docutils literal notranslate"><span class="pre">dict</span></code> object containing the relevant data that describes something interesting that has occurred in the application.
For example: a web server might emit an event after handling each request that includes the URI of requested resource, the response’s status code, a count of bytes transferred, and so on.
All of that information might be contained in a pair of objects representing the request and response, so logging this event could be as simple as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>The above API would seem confusing to users of many logging systems, which are built around the idea of emitting strings to a file.
There is, after all, no string in the above call.
In such systems, one might expect the API to look like this instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">{uri}</span><span class="s2">: status=</span><span class="si">{status}</span><span class="s2">, bytes=</span><span class="si">{size}</span><span class="s2">, etc...&quot;</span>
    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here, a string is rendered by formatting data from our request and response objects.
The string can be easily appended to a log file, to be later read by an administrator, or perhaps teased out via some scripts or log gathering tools.</p>
<p>One disadvantage to this is that a strings meant to be human-readable are not necessarily easy (or even possible) for software to handle reliably.
While text files are a common medium for storing logs, one might want to write code that notices certain types of events and does something other than store the event.</p>
<p>In the web server example, if many requests from a given IP address are resulting in failed authentication, someone might be trying to break in to the server.
Perhaps blocking requests from that IP address would be useful.
An observer receiving the above event as a string would have to resort to parsing the string to extract the relevant information, which may perform poorly and, depending on how well events are formatted, it may also be difficult to avoid bugs.
Additionally, any information not encoded into the string is simply unavailable; if the IP address isn’t in the string, it cannot be obtained from the event.</p>
<p>However, if the <code class="docutils literal notranslate"><span class="pre">request</span></code> and <code class="docutils literal notranslate"><span class="pre">response</span></code> objects are available to the observer, as in the first example, it would be possible to write an observer that accessed any attributes of those objects.
It would also be a lot easier to write an observer that emitted structured information by serializing these objects into a format such as JSON, rows in a database, etc.</p>
<p>Events-as-strings do have the advantage that it’s obvious what an observer that writes strings, for example to a file, would emit.
We can solve this more flexibly by providing an optional format string in events that can be used for this purpose:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">{request.uri}</span><span class="s2">: status=</span><span class="si">{response.status}</span><span class="s2">, bytes=</span><span class="si">{response.size}</span><span class="s2">, etc...&quot;</span><span class="p">,</span>
    <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that this looks very much like the events-as-strings version of the API, except that the string is not rendered by the caller; we leave that to the observer, <em>if and when it is needed</em> .
The observer also has direct access to the request and response objects, as well as their attributes.
Now a text-based observer can format the text in a prescribed way, and an observer that wants to handle these events in some other manner can do so as well.</p>
</div>
<div class="section" id="usage-for-emitting-applications">
<h2>Usage for emitting applications<a class="headerlink" href="#usage-for-emitting-applications" title="Permalink to this heading">¶</a></h2>
<p>The first thing that an application that emits logging events needs to do is to instantiate a <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> object, which provides the API to emit events.
A <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> may be created globally for a module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">handleData</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got data: </span><span class="si">{data!r}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> can also be associated with a class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">oops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Oops! Invalid data from server: </span><span class="si">{data!r}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>When associated with a class in this manner, the <code class="docutils literal notranslate"><span class="pre">&quot;log_source&quot;</span></code> key is set in the event.
For example:</p>
<p><a class="reference download internal" download="" href="../../_downloads/32015e7a4a6f3f3d857a62edc189f06a/logsource.py"><code class="xref download docutils literal notranslate"><span class="pre">logsource.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>


<span class="k">class</span> <span class="nc">MyObject</span><span class="p">:</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">doSomething</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">something</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Object with value </span><span class="si">{log_source.value!r}</span><span class="s2"> doing </span><span class="si">{something}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="n">something</span><span class="o">=</span><span class="n">something</span><span class="p">,</span>
        <span class="p">)</span>


<span class="n">MyObject</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">doSomething</span><span class="p">(</span><span class="s2">&quot;a task&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This example will show the string “object with value 7 doing a task” because the <code class="docutils literal notranslate"><span class="pre">log_source</span></code> key is automatically set to the <code class="docutils literal notranslate"><span class="pre">MyObject</span></code> instance that the <code class="docutils literal notranslate"><span class="pre">Logger</span></code> is retrieved from.</p>
<div class="section" id="capturing-failures">
<h3>Capturing Failures<a class="headerlink" href="#capturing-failures" title="Permalink to this heading">¶</a></h3>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> provides a <code class="xref py py-meth docutils literal notranslate"><span class="pre">failure</span></code> method, which allows one to capture a <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> object conveniently:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&quot;Math is hard!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The emitted event will have the <code class="docutils literal notranslate"><span class="pre">&quot;log_failure&quot;</span></code> key set, which is a <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> that captures the exception.
This can be used by my observers to obtain a traceback.
For example, <code class="xref py py-class docutils literal notranslate"><span class="pre">FileLogObserver</span></code> will append the traceback to it’s output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Math is hard!

Traceback (most recent call last):
--- &lt;exception caught here&gt; ---
  File &quot;/tmp/test.py&quot;, line 8, in &lt;module&gt;
    1/0
exceptions.ZeroDivisionError: integer division or modulo by zero
</pre></div>
</div>
<p>Note that this API is meant to capture unexpected and unhandled errors (that is: bugs, which is why tracebacks are preserved).
As such, it defaults to logging at the <code class="xref py py-attr docutils literal notranslate"><span class="pre">critical</span></code> level.
It is generally more appropriate to instead use <cite>log.error()</cite> when logging an expected error condition that was appropriately handled by the software.</p>
</div>
<div class="section" id="namespaces">
<h3>Namespaces<a class="headerlink" href="#namespaces" title="Permalink to this heading">¶</a></h3>
<p>All <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> s have a namespace, which can be used to categorize events.
Namespaces may be specified by passing in a <code class="docutils literal notranslate"><span class="pre">namespace</span></code> argument to <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> ‘s initializer, but if none is given, the logger will derive its namespace from the module name of the callable that instantiated it, or, in the case of a class, from the fully qualified name of the class.
A <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> will add a <code class="docutils literal notranslate"><span class="pre">log_namespace</span></code> key to the events it emits.</p>
<p>In the first example above, the namespace would be <code class="docutils literal notranslate"><span class="pre">some.module</span></code> , and in the second example, it would be <code class="docutils literal notranslate"><span class="pre">some.module.Foo</span></code> .</p>
</div>
<div class="section" id="log-levels">
<h3>Log levels<a class="headerlink" href="#log-levels" title="Permalink to this heading">¶</a></h3>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> s provide a number of methods for emitting events.
These methods all have the same signature, but each will attach a specific <code class="docutils literal notranslate"><span class="pre">log_level</span></code> key to events.
Log levels are defined by the <code class="xref py py-class docutils literal notranslate"><span class="pre">LogLevel</span></code> constants container.
These are:</p>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">debug</span></code></p>
<blockquote>
<div><p>Debugging events: Information of use to a developer of the software, not generally of interest to someone running the software unless they are attempting to diagnose a software issue.</p>
</div></blockquote>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">info</span></code></p>
<blockquote>
<div><p>Informational events: Routine information about the status of an application, such as incoming connections, startup of a subsystem, etc.</p>
</div></blockquote>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">warn</span></code></p>
<blockquote>
<div><p>Warning events: Events that may require greater attention than informational events but are not a systemic failure condition, such as authorization failures, bad data from a network client, etc.
Such events are of potential interest to system administrators, and should ideally be phrased in such a way, or documented, so as to indicate an action that an administrator might take to mitigate the warning.</p>
</div></blockquote>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">error</span></code></p>
<blockquote>
<div><p>Error conditions: Events indicating a systemic failure.
For example, resource exhaustion, or the loss of connectivity to an external system, such as a database or API endpoint, without which no useful work can proceed.
Similar to warnings, errors related to operational parameters may be actionable to system administrators and should provide references to resources which an administrator might use to resolve them.</p>
</div></blockquote>
<p><code class="xref py py-attr docutils literal notranslate"><span class="pre">critical</span></code></p>
<blockquote>
<div><p>Critical failures: Errors indicating systemic failure (ie. service outage), data corruption, imminent data loss, etc. which must be handled immediately.
This includes errors unanticipated by the software, such as unhandled exceptions, wherein the cause and consequences are unknown.</p>
</div></blockquote>
<p>In the first example above, the call to <code class="docutils literal notranslate"><span class="pre">log.debug</span></code> will add a <code class="docutils literal notranslate"><span class="pre">log_level</span></code> key to the emitted event with a value of <code class="xref py py-attr docutils literal notranslate"><span class="pre">LogLevel.debug</span></code> .
In the second example, calling <code class="docutils literal notranslate"><span class="pre">self.log.error</span></code> would use a value of <code class="xref py py-attr docutils literal notranslate"><span class="pre">LogLevel.error</span></code> .</p>
<p>The above descriptions are simply guidance, but it is worth noting that log levels have a reduced value if they are used inconsistently.
If one module in an application considers a message informational, and another module considers a similar message an error, then filtering based on log levels becomes harder.
This is increasingly likely if the modules in question are developed by different parties, as will often be the case with externally source libraries and frameworks.
(If a module tends to use higher levels than another, namespaces may be used to calibrate the relative use of log levels, but that is obviously suboptimal.)
Sticking to the above guidelines will hopefully help here.</p>
</div>
<div class="section" id="emitter-method-signatures">
<h3>Emitter method signatures<a class="headerlink" href="#emitter-method-signatures" title="Permalink to this heading">¶</a></h3>
<p>The emitter methods (<code class="xref py py-meth docutils literal notranslate"><span class="pre">debug</span></code> , <code class="xref py py-meth docutils literal notranslate"><span class="pre">info</span></code> , <code class="xref py py-meth docutils literal notranslate"><span class="pre">warn</span></code> , etc.) all take an optional format string as a first argument, followed by keyword arguments that will be included in the emitted event.</p>
<p>Note that all three examples in the opening section of this HOWTO fit this signature.
The first omits the format, which doesn’t lend itself well to text logging.
The second omits the keyword arguments, which hostile to anything other than text logging, and is therefore ill-advised.
Finally, the third provides both, which is the recommended usage.</p>
<p>These methods are all convenience wrappers around the <code class="xref py py-meth docutils literal notranslate"><span class="pre">emit</span></code> method, which takes a <code class="xref py py-class docutils literal notranslate"><span class="pre">LogLevel</span></code> as its first argument.</p>
</div>
<div class="section" id="format-strings">
<h3>Format strings<a class="headerlink" href="#format-strings" title="Permalink to this heading">¶</a></h3>
<p>Format strings provide observers with a standard way to format an event as text suitable for a human being to read.  Formatting is accomplished using the function <code class="xref py py-func docutils literal notranslate"><span class="pre">eventAsText</span></code>.
When writing a format string, take care to present it in a manner which would make as much sense as possible to a human reader.
Particularly, format strings need not be written with an eye towards parseability or machine-readability.
If you want to save your log events along with their structure and then analyze them later, see the next section, on <a class="reference internal" href="#core-howto-logger-saving-events-for-later"><span class="std std-ref">“saving events for later”</span></a> .</p>
<p>Format strings should be</p>
<p><code class="docutils literal notranslate"><span class="pre">unicode</span></code> , and use <a class="reference external" href="http://www.python.org/dev/peps/pep-3101/">PEP 3101</a> syntax to describe how the event should be rendered as human-readable text.
For legacy support and convenience in python 2, UTF-8-encoded <code class="docutils literal notranslate"><span class="pre">bytes</span></code> are also accepted for format strings, but unicode is preferred.
There are two variations from PEP 3101 in the format strings used by this module:</p>
<ol class="arabic">
<li><p>Positional (numerical) field names (eg. <code class="docutils literal notranslate"><span class="pre">{0}</span></code> ) are not permitted.
Event keys are not ordered, which means positional field names do not make sense in this context.
However, this is not an accidental limitation, but an intentional design decision.
As software evolves, log messages often grow to include additional information, while still logging the same conceptual event.
By using meaningful names rather than opaque indexes for event keys, these identifiers are more robust against future changes in the format of messages and the information provided.</p></li>
<li><p>Field names ending in parentheses (eg. <code class="docutils literal notranslate"><span class="pre">{foo()}</span></code> ) will call the referenced object with no arguments, then call <code class="docutils literal notranslate"><span class="pre">str</span></code> on the result, rather than calling <code class="docutils literal notranslate"><span class="pre">str</span></code> on the referenced object directly.
This extension to PEP 3101 format syntax is provided to make it as easy as possible to defer potentially expensive work until a log message must be emitted.
For example, let’s say that we wanted to log a message with some useful, but potentially expensive information from the ‘request’ object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{request.uri}</span><span class="s2"> useful, but expensive: {request.usefulButExpensive()}&quot;</span><span class="p">,</span>
         <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
<p>In the case where this log message is filtered out as uninteresting and not saved, no formatting work is done <em>at all</em> ; and since we can use PEP3101 attribute-access syntax in conjunction with this parenthesis extension, the caller does not even need to build a function or bound method object to pass as a separate key.
There is no support for specifying arguments in the format string; the goal is to make it idiomatic to express that work be done later, not to implement a full Python expression evaluator.</p>
</li>
</ol>
</div>
<div class="section" id="event-keys-added-by-the-system">
<h3>Event keys added by the system<a class="headerlink" href="#event-keys-added-by-the-system" title="Permalink to this heading">¶</a></h3>
<p>The logging system will add keys to emitted events.
All event keys that are inserted by the logging system with have a <code class="docutils literal notranslate"><span class="pre">log_</span></code> prefix, to avoid namespace collisions with application-provided event keys.
Applications should therefore not insert event keys using the <code class="docutils literal notranslate"><span class="pre">log_</span></code> prefix, as that prefix is reserved for the logging system.
System-provided event keys include:</p>
<p><code class="docutils literal notranslate"><span class="pre">log_logger</span></code></p>
<blockquote>
<div><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> object that the event was emitted to.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_source</span></code></p>
<blockquote>
<div><p>The source object that emitted the event.
When a <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> is accessed as an attribute of a class, the class is the source.
When accessed as an attribute of an instance, the instance is the source.
In other cases, the source is <code class="docutils literal notranslate"><span class="pre">None</span></code> .</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_level</span></code></p>
<blockquote>
<div><p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">LogLevel</span></code> associated with the event.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_namespace</span></code></p>
<blockquote>
<div><p>The namespace associated with the event.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_format</span></code></p>
<blockquote>
<div><p>The format string provided for use by observers that wish to render the event as text.
This may be <code class="docutils literal notranslate"><span class="pre">None</span></code> , if no format string was provided.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_time</span></code></p>
<blockquote>
<div><p>The time that the event was emitted, as returned by <code class="xref py py-func docutils literal notranslate"><span class="pre">time</span></code> .</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">log_failure</span></code></p>
<blockquote>
<div><p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> object captured when the event was emitted.</p>
</div></blockquote>
</div>
<div class="section" id="avoid-mutable-event-keys">
<h3>Avoid mutable event keys<a class="headerlink" href="#avoid-mutable-event-keys" title="Permalink to this heading">¶</a></h3>
<p>Emitting applications should be cautious about inserting objects into events which may be mutated later.
While observers are called synchronously, it is possible that an observer will do something like queue up the event for later serialization, in which case the serialized object may be different than intended.</p>
</div>
<div class="section" id="capturing-log-events-for-testing">
<h3>Capturing log events for testing<a class="headerlink" href="#capturing-log-events-for-testing" title="Permalink to this heading">¶</a></h3>
<p>If you want to test that your code is logging the expected events, you can use the <code class="xref py py-func docutils literal notranslate"><span class="pre">LogCapture</span></code> context manager:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">LogLevel</span><span class="p">,</span> <span class="n">capturedLogs</span>
<span class="kn">from</span> <span class="nn">twisted.trial.unittest</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">SomeTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">capturedLogs</span><span class="p">()</span> <span class="k">as</span> <span class="n">captured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Capture this, please&quot;</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="n">foo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">captured</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;log_format&quot;</span><span class="p">],</span> <span class="s2">&quot;Capture this, please&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">],</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">captured</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;foo&quot;</span><span class="p">],</span> <span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-events-for-later">
<span id="core-howto-logger-saving-events-for-later"></span><h2>Saving events for later<a class="headerlink" href="#saving-events-for-later" title="Permalink to this heading">¶</a></h2>
<p>For compatibility reasons, <code class="docutils literal notranslate"><span class="pre">twistd</span></code> will log to a text-based format by default.
However, it’s much better to use a structured log file format which preserves information about the events being logged.
<code class="docutils literal notranslate"><span class="pre">twisted.logger</span></code> provides two APIs: <code class="xref py py-func docutils literal notranslate"><span class="pre">jsonFileLogObserver</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">eventsFromJSONLogFile</span></code>, which allow you to save and retrieve structured log events with a basic level of fidelity.
Log events are serialized as JSON dictionaries, with serialization rules that are as lenient as possible; any unknown values are replaced with simple placeholder values.</p>
<p><code class="docutils literal notranslate"><span class="pre">jsonFileLogObserver</span></code> will create a log observer that will save events as structured data, like so:</p>
<p><a class="reference download internal" download="" href="../../_downloads/743b3669d5f40ecd3e2f97e5da85cffb/saver.py"><code class="xref download docutils literal notranslate"><span class="pre">saver.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">jsonFileLogObserver</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">jsonFileLogObserver</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.json&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)),</span> <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;saver&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">loggit</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Some values: </span><span class="si">{values!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>


<span class="n">loggit</span><span class="p">([</span><span class="mi">1234</span><span class="p">,</span> <span class="mi">5678</span><span class="p">])</span>
<span class="n">loggit</span><span class="p">([</span><span class="mi">9876</span><span class="p">,</span> <span class="mi">5432</span><span class="p">])</span>
</pre></div>
</div>
<p>And <code class="docutils literal notranslate"><span class="pre">eventsFromJSONLogFile</span></code> can load those events again; here, you can see that the event has preserved enough information to be formatted as human-readable again:</p>
<p><a class="reference download internal" download="" href="../../_downloads/baa05fe8fb773a1509ec32d5e248968a/loader.py"><code class="xref download docutils literal notranslate"><span class="pre">loader.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">eventsFromJSONLogFile</span><span class="p">,</span> <span class="n">textFileLogObserver</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">textFileLogObserver</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">eventsFromJSONLogFile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.json&quot;</span><span class="p">)):</span>
    <span class="n">output</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also, of course, feel free to access any of the keys in the <code class="docutils literal notranslate"><span class="pre">event</span></code> object as you load them, as well; basic structures such as lists, numbers, dictionaries and strings (anything serializable with JSON) will be preserved:</p>
<p><a class="reference download internal" download="" href="../../_downloads/95acaf6813e1e62f12554fd4ee6c5e34/loader-math.py"><code class="xref download docutils literal notranslate"><span class="pre">loader-math.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">eventsFromJSONLogFile</span>

<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">eventsFromJSONLogFile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.json&quot;</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-an-observer">
<h2>Implementing an observer<a class="headerlink" href="#implementing-an-observer" title="Permalink to this heading">¶</a></h2>
<p>An observer must provide the <code class="xref py py-class docutils literal notranslate"><span class="pre">ILogObserver</span></code> interface.
That interface simply describes a 1-argument callable that takes a <code class="docutils literal notranslate"><span class="pre">dict</span></code> , so a simple implementation may simply use the handy <code class="xref py py-class docutils literal notranslate"><span class="pre">provider</span></code> decorator on a function that takes one argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">provider</span>
<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">ILogObserver</span><span class="p">,</span> <span class="n">eventAsText</span>

<span class="nd">@provider</span><span class="p">(</span><span class="n">ILogObserver</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">simpleObserver</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">eventAsText</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">eventAsText</span></code> function returns a textual (<code class="docutils literal notranslate"><span class="pre">unicode</span></code> ) representation of the event.</p>
<p>While it is recommended, in most cases it is not required that observers declare their compliance with <code class="xref py py-class docutils literal notranslate"><span class="pre">ILogObserver</span></code> .
This flexibility exists to allow for pre-existing callables and lambda expressions to be used as observers.
As an example, if one would like to accumulate events in a <code class="docutils literal notranslate"><span class="pre">list</span></code> , then <code class="docutils literal notranslate"><span class="pre">list.append</span></code> may be used as an observer.</p>
<p>When implementing your own log observer, however, you should always keep in mind that unlike most objects within Twisted, a log observer <em>must be thread safe</em> .</p>
<p>Specifically, a log observer:</p>
<ul class="simple">
<li><p>must be prepared to be called from threads other than the main thread (or I/O thread, or reactor thread)</p></li>
<li><p>must be prepared to be called from multiple threads concurrently</p></li>
<li><p>must not interact with other Twisted APIs that are not explicitly thread-safe without first taking precautions like using <code class="xref py py-meth docutils literal notranslate"><span class="pre">callFromThread</span></code></p></li>
</ul>
<p>Keep in mind that this is true even if you elect not to explicitly interact with any threads from your program.
Twisted itself may log messages from threads, and Twisted may internally use APIs like <code class="xref py py-meth docutils literal notranslate"><span class="pre">callInThread</span></code> ; for example, Twisted uses threads to look up hostnames when making an outgoing connection.</p>
<p>Given this extra wrinkle, it’s usually best to see if you can find an existing log observer implementation that does what you need before implementing your own; thread safety can be tricky to implement.
Luckily, <code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.logger</span></code> comes with several useful observers, which are documented below.</p>
<div class="section" id="writing-an-observer-for-event-analysis">
<h3>Writing an observer for event analysis<a class="headerlink" href="#writing-an-observer-for-event-analysis" title="Permalink to this heading">¶</a></h3>
<p>Twisted includes log observers which take care of most of the “normal” uses of logging, like writing messages to a file, saving them as text, filtering them, and so on.
There are two common reasons you might want to write a log observer of your own.
The first is to ship log messages over to a different kind of external system which Twisted itself does not support.
If you’ve read the above, you now know enough to do that; simply implement a function that converts the dictionary to something amenable to your external system or file format, and send it there or save it.
The second task is to do some kind of analysis, either real-time within your process or after the fact offline.</p>
<p>You’re probably going to have to aggregate information from your own code and from libraries you’re using, including Twisted itself, and you may not have much in the way of control over how those messages are organized.
You’re also probably trying to aggregate information from ad-hoc messages into some kind of structure.</p>
<p>One way to extract such semi-structured information is to feed your logs into an external system like <a class="reference external" href="http://logstash.net">logstash</a> , and process them there.
Such systems are quite powerful and <code class="docutils literal notranslate"><span class="pre">twisted.logger</span></code> does not try to replace them.
However, such systems are necessarily external, and therefore if you want to react to the log analysis <em>within</em> your application - for example, denying access in response to an abusive client - you would have to write some glue code to push messages from your log-analysis system back into your application.
For such cases, it’s useful to be able to write log analysis code as a log observer.</p>
<p>Assuming that the libraries whose log events you’re interested in analyzing are making use of <code class="docutils literal notranslate"><span class="pre">twisted.logger</span></code> , you can analyze log events either live as they’re being logged, or loaded from a saved log file.</p>
<p>If you’re writing code to log events directly for potential analysis, then you should simply structure your messages to include all necessary information as serialization-friendly values in events, and then simply pull them out, like the <code class="docutils literal notranslate"><span class="pre">loader-math.py</span></code> example above.</p>
<p>However, let’s say you’re trying to interact with a system that logs messages like so:</p>
<p><a class="reference download internal" download="" href="../../_downloads/def22b59e2e3d9f0b3c4af6ca7cdefab/ad_hoc.py"><code class="xref download docutils literal notranslate"><span class="pre">ad_hoc.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>


<span class="k">class</span> <span class="nc">AdHoc</span><span class="p">:</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;ad_hoc&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">logMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;message from </span><span class="si">{log_source}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;where a is </span><span class="si">{log_source.a}</span><span class="s2"> and b is </span><span class="si">{log_source.b}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">AdHoc</span></code> object is not itself serializable, but it has two relevant attributes, which the log message’s format string calls out as attributes of the <code class="docutils literal notranslate"><span class="pre">log_source</span></code> field, as described above: <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> .</p>
<p>To analyze this event, we can’t pursue the same strategy shown above in <code class="docutils literal notranslate"><span class="pre">loader-math.py</span></code> .
We don’t have any key/value pairs of the log event to examine directly; <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are not present as keys themselves.
We could look for the <code class="docutils literal notranslate"><span class="pre">log_source</span></code> key within the event and access its <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> attributes, but that wouldn’t work once the event had been serialized and loaded again, since an <code class="docutils literal notranslate"><span class="pre">AdHoc</span></code> instance isn’t a basic type that can be saved to JSON.</p>
<p>Luckily, <code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.logger</span></code> provides an API for doing just this: <code class="xref py py-func docutils literal notranslate"><span class="pre">extractField</span></code> .
You use it like so:</p>
<p><a class="reference download internal" download="" href="../../_downloads/014490a047c2ae2f94ca4fe277bd36de/analyze.py"><code class="xref download docutils literal notranslate"><span class="pre">analyze.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">extractField</span>

<span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;message from </span><span class="si">{log_source}</span><span class="s2"> &quot;</span> <span class="s2">&quot;where a is </span><span class="si">{log_source.a}</span><span class="s2"> and b is </span><span class="si">{log_source.b}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_format&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">extractField</span><span class="p">(</span><span class="s2">&quot;log_source.a&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">extractField</span><span class="p">(</span><span class="s2">&quot;log_source.b&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A + B = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">analyze</span></code> function can then be used in two ways.
First, you can analyze your application “live”, as it’s running.</p>
<p><a class="reference download internal" download="" href="../../_downloads/2d619f3fed5485dfb1eeece3163663d9/online_analyze.py"><code class="xref download docutils literal notranslate"><span class="pre">online_analyze.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ad_hoc</span> <span class="kn">import</span> <span class="n">AdHoc</span>
<span class="kn">from</span> <span class="nn">analyze</span> <span class="kn">import</span> <span class="n">analyze</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">globalLogPublisher</span>

<span class="n">globalLogPublisher</span><span class="o">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">analyze</span><span class="p">)</span>

<span class="n">AdHoc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">logMessage</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run this script, you will see that it extracts the values from the <code class="docutils literal notranslate"><span class="pre">AdHoc</span></code> object’s log message.</p>
<p>However, you can also analyze output from a saved log file, using the exact same code.
First, you’ll need to produce a log file with a message from an AdHoc object in it:</p>
<p><a class="reference download internal" download="" href="../../_downloads/bac564d80caccbd7494390d1dc5eadaf/ad_hoc_save.py"><code class="xref download docutils literal notranslate"><span class="pre">ad_hoc_save.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">ad_hoc</span> <span class="kn">import</span> <span class="n">AdHoc</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">globalLogPublisher</span><span class="p">,</span> <span class="n">jsonFileLogObserver</span>

<span class="n">globalLogPublisher</span><span class="o">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">jsonFileLogObserver</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.json&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)))</span>

<span class="n">AdHoc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">logMessage</span><span class="p">()</span>
</pre></div>
</div>
<p>If you run that script, it will produce a <code class="docutils literal notranslate"><span class="pre">log.json</span></code> file which can be analyzed in the same manner as the <code class="docutils literal notranslate"><span class="pre">loader.py</span></code> example above:</p>
<p><a class="reference download internal" download="" href="../../_downloads/644e10cc11ff8ff3bc3a4b46d60a4e40/offline_analyze.py"><code class="xref download docutils literal notranslate"><span class="pre">offline_analyze.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io</span>

<span class="kn">from</span> <span class="nn">analyze</span> <span class="kn">import</span> <span class="n">analyze</span>

<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">eventsFromJSONLogFile</span>

<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">eventsFromJSONLogFile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;log.json&quot;</span><span class="p">)):</span>
    <span class="n">analyze</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</pre></div>
</div>
<p>When doing analysis, it always seems like you should have saved more structured data for later.
However, log messages are often written early on in development, in an ad-hoc way, before a solid understanding has developed about what information will be useful and what will be redundant.
Log messages are therefore a stream-of-consciousness commentary on what is going on as a system is being developed.</p>
<p><code class="docutils literal notranslate"><span class="pre">extractField</span></code> lets you acknowledge the messy reality of how log messages are written, but still take advantage of structured analysis later on.
Just always be sure to use event format fields, not string concatenation, to reference information about a particular event, and you’ll be able to easily pull apart hastily-written ad-hoc messages from multiple versions of a system, either as it’s running or once you’ve saved a log file.</p>
</div>
</div>
<div class="section" id="registering-an-observer">
<h2>Registering an observer<a class="headerlink" href="#registering-an-observer" title="Permalink to this heading">¶</a></h2>
<p>One way to register an observer is to construct a <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> object with it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">myobservers</span> <span class="kn">import</span> <span class="n">PrintingObserver</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">PrintingObserver</span><span class="p">())</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will cause all of a logger’s events to be sent to the given observer.
In the above example, all events emitted by the logger (eg. <code class="docutils literal notranslate"><span class="pre">&quot;Hello&quot;</span></code> ) will be printed.
While that is useful in some cases, it is common to register multiple observers, and to do so globally for all (or most) loggers in an application.</p>
</div>
<div class="section" id="the-global-log-publisher">
<h2>The global log publisher<a class="headerlink" href="#the-global-log-publisher" title="Permalink to this heading">¶</a></h2>
<p>The global log publisher is a log observer whose purpose is to capture log events not directed to a specific observer.
In a typical application, the majority of log events will be emitted to the global log publisher.
Observers can register themselves with the global log publisher in order to be forwarded these events.</p>
<p>When a <code class="xref py py-class docutils literal notranslate"><span class="pre">Logger</span></code> is created without specifying an observer to send events to, the logger will send its events to the global log publisher, which is accessible via the name <code class="xref py py-attr docutils literal notranslate"><span class="pre">globalLogPublisher</span></code> .</p>
<p>The global log publisher is a singleton instance of a private subclass of <code class="xref py py-class docutils literal notranslate"><span class="pre">LogPublisher</span></code> , which is itself an <code class="xref py py-class docutils literal notranslate"><span class="pre">ILogObserver</span></code> .
What this means is that the global log publisher accepts events like any other observer, and that it forwards those events to other observers.
Observers can be registered to be forwarded events by calling the <code class="xref py py-class docutils literal notranslate"><span class="pre">LogPublisher</span></code> method <code class="xref py py-meth docutils literal notranslate"><span class="pre">addObserver</span></code> , and unregister by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">removeObserver</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">globalLogPublisher</span>
<span class="kn">from</span> <span class="nn">myobservers</span> <span class="kn">import</span> <span class="n">PrintingObserver</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="n">globalLogPublisher</span><span class="o">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">PrintingObserver</span><span class="p">())</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result here is the same as the previous example, except that additional observers can be (and may already have been) registered.
We know that <code class="docutils literal notranslate"><span class="pre">&quot;Hello&quot;</span></code> will be printed.
We don’t know, but it’s very possible, that the same event will also be handled by other observers.</p>
<p>There is no supported API to discover what other observers are registered with a <code class="xref py py-class docutils literal notranslate"><span class="pre">LogPublisher</span></code> ; in general, one doesn’t need to know.
If an application is running in <code class="docutils literal notranslate"><span class="pre">twistd</span></code> , for example, it’s likely that an observer is streaming events to a file by the time the application code is in play.
If it is running in a <code class="docutils literal notranslate"><span class="pre">twistd</span></code> web container, there will probably be another observer writing to the access log.</p>
<p>A caveat here is that events are <code class="docutils literal notranslate"><span class="pre">dict</span></code> objects, which are mutable, so it is possible for an observer to modify an event that it sees.
Because doing so will modify what other observers will see, modifying a received event can be problematic and should be strongly discouraged.
It can be particularly harmful to edit or remove the content of an existing event key.
Furthermore, no guarantees are made as to the order in which observers are called, so the effect of such modifications on other observers may be non-deterministic.</p>
<div class="section" id="starting-the-global-log-publisher">
<h3>Starting the global log publisher<a class="headerlink" href="#starting-the-global-log-publisher" title="Permalink to this heading">¶</a></h3>
<p>When the global log publisher is created, it uses a <code class="xref py py-class docutils literal notranslate"><span class="pre">LimitedHistoryLogObserver</span></code> (see below) to store events that are logged by the application in memory until logging is started.
Logging is started by registering the first set of observers with the global log publisher by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">beginLoggingTo</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">globalLogBeginner</span>
<span class="kn">from</span> <span class="nn">myobservers</span> <span class="kn">import</span> <span class="n">PrintingObserver</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>

<span class="n">observers</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrintingObserver</span><span class="p">()]</span>

<span class="n">globalLogBeginner</span><span class="o">.</span><span class="n">beginLoggingTo</span><span class="p">(</span><span class="n">observers</span><span class="p">)</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hello, again&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This:</p>
<ul class="simple">
<li><p>Adds the given observers (in this example, the <code class="docutils literal notranslate"><span class="pre">PrintingObserver</span></code> ) to the global log observer</p></li>
<li><p>Forwards all of the events that were stored in memory prior to calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">beginLoggingTo</span></code> to these observers</p></li>
<li><p>Gets rid of the <code class="xref py py-class docutils literal notranslate"><span class="pre">LimitedHistoryLogObserver</span></code> , as it is no longer needed.</p></li>
</ul>
<p>It is an error to call <code class="xref py py-meth docutils literal notranslate"><span class="pre">beginLoggingTo</span></code> more than once.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the global log publisher is never started, the in-memory event buffer holds (a bounded number of) log events indefinitely.
This may unexpectedly increase application memory or CPU usage.
It is highly recommended that the global log publisher be started as early as feasible.</p>
</div>
</div>
</div>
<div class="section" id="provided-log-observers">
<h2>Provided log observers<a class="headerlink" href="#provided-log-observers" title="Permalink to this heading">¶</a></h2>
<p>This module provides a number of pre-built observers for applications to use:</p>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">LogPublisher</span></code></p>
<blockquote>
<div><p>Forwards events to other publishers.
This allows one to create a graph of observers.</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">LimitedHistoryLogObserver</span></code></p>
<blockquote>
<div><p>Stores a limited number of received events, and can re-play those stored events to another observer later.
This is useful for keeping recent logging history in memory for inspection when other log outputs are not available.</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">FileLogObserver</span></code></p>
<blockquote>
<div><p>Formats events as text, prefixed with a time stamp and a “system identifier”, and writes them to a file.
The system identifier defaults to a combination of the event’s namespace and level.</p>
</div></blockquote>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">FilteringLogObserver</span></code></p>
<blockquote>
<div><p>Forwards events to another observer after applying a set of filter predicates (providers of <code class="xref py py-class docutils literal notranslate"><span class="pre">ILogFilterPredicate</span></code> ).
<code class="xref py py-class docutils literal notranslate"><span class="pre">LogLevelFilterPredicate</span></code> is a predicate that be configured to keep track of which log levels to filter for different namespaces, and will filter out events that are not at the appropriate level or higher.</p>
</div></blockquote>
</div>
<div class="section" id="compatibility-with-standard-library-logging">
<h2>Compatibility with standard library logging<a class="headerlink" href="#compatibility-with-standard-library-logging" title="Permalink to this heading">¶</a></h2>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">STDLibLogObserver</span></code> is provided for compatibility with the standard library’s <code class="xref py py-mod docutils literal notranslate"><span class="pre">logging</span></code> module.
Log levels are mapped between the two systems, and the various attributes of standard library log records are filled in properly.</p>
<p>Note that standard library logging is a blocking API, and logging can be configured to block for long periods (eg. it may write to the network).
No protection is provided to prevent blocking, so such configurations may cause Twisted applications to perform poorly.</p>
</div>
<div class="section" id="compatibility-with-twisted-python-log">
<h2>Compatibility with twisted.python.log<a class="headerlink" href="#compatibility-with-twisted-python-log" title="Permalink to this heading">¶</a></h2>
<p>This module provides some facilities to enable the existing <code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.python.log</span></code> module to compatibly forward it’s messages to this module.
As such, existing clients of <code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.python.log</span></code> will begin using this module indirectly, with no changes to the older module’s API.</p>
<div class="section" id="incrementally-porting-observers">
<h3>Incrementally porting observers<a class="headerlink" href="#incrementally-porting-observers" title="Permalink to this heading">¶</a></h3>
<p>Observers have an incremental path for porting to the new module.
<code class="xref py py-class docutils literal notranslate"><span class="pre">LegacyLogObserverWrapper</span></code> is an <code class="xref py py-class docutils literal notranslate"><span class="pre">ILogObserver</span></code> that wraps a log observer written for the older module.
This allows an old-style observer to be registered with a new-style logger or log publisher compatibly.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="logging.html" class="btn btn-neutral float-right" title="Twisted’s Legacy Logging System: twisted.python.log" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="systemd.html" class="btn btn-neutral float-left" title="Deploying Twisted with systemd" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>