

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Introduction to Deferreds &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Deferred Reference" href="defer.html" />
    <link rel="prev" title="Using Processes" href="process.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="servers.html">Writing Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="process.html">Using Processes</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction to Deferreds</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-joy-of-order">The joy of order</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-hypothetical-problem">A hypothetical problem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-components-of-a-solution">The components of a solution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#one-solution-deferred">One solution: Deferred</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-it-right-the-failure-cases">Getting it right: The failure cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3"><a class="reference internal" href="logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Introduction to Deferreds</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/core/howto/defer-intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction-to-deferreds">
<h1>Introduction to Deferreds<a class="headerlink" href="#introduction-to-deferreds" title="Permalink to this heading">¶</a></h1>
<p>This document introduces <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s, Twisted’s preferred mechanism for controlling the flow of asynchronous code.
Don’t worry if you don’t know what that means yet – that’s why you are here!</p>
<p>It is intended for newcomers to Twisted, and was written particularly to help people read and understand code that already uses <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s.</p>
<p>This document assumes you have a good working knowledge of Python.
It assumes no knowledge of Twisted.</p>
<p>By the end of the document, you should understand what <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s are and how they can be used to coordinate asynchronous code.
In particular, you should be able to:</p>
<ul class="simple">
<li><p>Read and understand code that uses <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s</p></li>
<li><p>Translate from synchronous code to asynchronous code and back again</p></li>
<li><p>Implement any sort of error-handling for asynchronous code that you wish</p></li>
</ul>
<div class="section" id="the-joy-of-order">
<h2>The joy of order<a class="headerlink" href="#the-joy-of-order" title="Permalink to this heading">¶</a></h2>
<p>When you write Python code, one prevailing, deep, unassailled assumption is that a line of code within a block is only ever executed after the preceding line is finished.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>The pod bay doors open, and only <em>then</em> does the pod launch.
That’s wonderful.
One-line-after-another is a built-in mechanism in the language for encoding the order of execution.
It’s clear, terse, and unambiguous.</p>
<p>Exceptions make things more complicated.
If <code class="docutils literal notranslate"><span class="pre">pod_bay_doors.open()</span></code> raises an exception, then we cannot know with certainty that it completed, and so it would be wrong to proceed blithely to the next line.
Thus, Python gives us <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">except</span></code>, <code class="docutils literal notranslate"><span class="pre">finally</span></code>, and <code class="docutils literal notranslate"><span class="pre">else</span></code>, which together model almost every conceivable way of handling a raised exception, and tend to work really well.</p>
<p>Function application is the other way we encode order of execution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()))</span>
</pre></div>
</div>
<p>First <code class="docutils literal notranslate"><span class="pre">x.get_names()</span></code> gets called, then <code class="docutils literal notranslate"><span class="pre">sorted</span></code> is called with its return value, and then <code class="docutils literal notranslate"><span class="pre">pprint</span></code> with whatever <code class="docutils literal notranslate"><span class="pre">sorted</span></code> returns.</p>
<p>It can also be written as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">sorted_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">sorted_names</span><span class="p">)</span>
</pre></div>
</div>
<p>Sometimes it leads us to encode the order when we don’t need to, as in this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">account</span> <span class="ow">in</span> <span class="n">accounts</span><span class="p">:</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_balance</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total balance $</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>
</pre></div>
</div>
<p>But that’s normally not such a big deal.</p>
<p>All in all, things are pretty good, and all of the explanation above is laboring familiar and obvious points.
One line comes after another and one thing happens after another, and both facts are inextricably tied.</p>
<p>But what if we had to do it differently?</p>
</div>
<div class="section" id="a-hypothetical-problem">
<h2>A hypothetical problem<a class="headerlink" href="#a-hypothetical-problem" title="Permalink to this heading">¶</a></h2>
<p>What if we could no longer rely on the previous line of code being finished (whatever that means) before we started to interpret &amp; execute the next line of code?
What if <code class="docutils literal notranslate"><span class="pre">pod_bay_doors.open()</span></code> returned immediately, triggering something somewhere else that would eventually open the pod bay doors, recklessly sending the Python interpreter plunging into <code class="docutils literal notranslate"><span class="pre">pod.launch()</span></code> ?</p>
<p>That is, what would we do if the order of execution did not match the order of lines of Python?
If “returning” no longer meant “finishing”?</p>
<p><em>Asynchronous operations</em>?</p>
<p>How would we prevent our pod from hurtling into the still-closed doors?
How could we respond to a potential failure to open the doors at all?
What if opening the doors gave us some crucial information that we needed in order to launch the pod?
How would we get access to that information?</p>
<p>And, crucially, since we are writing code, how can we write our code so that we can build <em>other</em> code on top of it?</p>
</div>
<div class="section" id="the-components-of-a-solution">
<h2>The components of a solution<a class="headerlink" href="#the-components-of-a-solution" title="Permalink to this heading">¶</a></h2>
<p>We would still need a way of saying “do <em>this</em> only when <em>that</em> has finished”.</p>
<p>We would need a way of distinguishing between successful completion and interrupted processing, normally modeled with <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">except</span></code>, <code class="docutils literal notranslate"><span class="pre">else</span></code>, and <code class="docutils literal notranslate"><span class="pre">finally</span></code>.</p>
<p>We need a mechanism for getting return failures and exception information from the thing that just executed to the thing that needs to happen next.</p>
<p>We need somehow to be able to operate on results that we don’t have yet.
Instead of acting, we need to make and encode plans for how we would act if we could.</p>
<p>Unless we hack the interpreter somehow, we would need to build this with the Python language constructs we are given: methods, functions, objects, and the like.</p>
<p>Perhaps we want something that looks a little like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">placeholder</span> <span class="o">=</span> <span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">placeholder</span><span class="o">.</span><span class="n">when_done</span><span class="p">(</span><span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="one-solution-deferred">
<h2>One solution: Deferred<a class="headerlink" href="#one-solution-deferred" title="Permalink to this heading">¶</a></h2>
<p>Twisted tackles this problem with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s, a type of object designed to do one thing, and one thing only: encode an order of execution separately from the order of lines in Python source code.</p>
<p>It doesn’t deal with threads, parallelism, signals, or subprocesses.
It doesn’t know anything about an event loop, greenlets, or scheduling.
All it knows about is what order to do things in.
How does it know that?
Because we explicitly tell it the order that we want.</p>
<p>Thus, instead of writing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>We write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pod_bay_doors</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ignored</span><span class="p">:</span> <span class="n">pod</span><span class="o">.</span><span class="n">launch</span><span class="p">())</span>
</pre></div>
</div>
<p>That introduced a dozen new concepts in a couple of lines of code, so let’s break it down.
If you think you’ve got it, you might want to skip to the next section.</p>
<p>Here, <code class="docutils literal notranslate"><span class="pre">pod_bay_doors.open()</span></code> is returning a <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>, which we assign to <code class="docutils literal notranslate"><span class="pre">d</span></code>.
We can think of <code class="docutils literal notranslate"><span class="pre">d</span></code> as a placeholder, representing the value that <code class="docutils literal notranslate"><span class="pre">open()</span></code> will eventually return when it finally gets around to finishing.</p>
<p>To “do this next”, we add a <em>callback</em> to <code class="docutils literal notranslate"><span class="pre">d</span></code>.
A callback is a function that will be called with whatever <code class="docutils literal notranslate"><span class="pre">open()</span></code> eventually returns.
In this case, we don’t care, so we make a function with a single, ignored parameter that just calls <code class="docutils literal notranslate"><span class="pre">pod.launch()</span></code>.</p>
<p>So, we’ve replaced the “order of lines is order of execution” with a deliberate, in-Python encoding of the order of execution, where <code class="docutils literal notranslate"><span class="pre">d</span></code> represents the particular flow and <code class="docutils literal notranslate"><span class="pre">d.addCallback</span></code> replaces “new line”.</p>
<p>Of course, programs generally consist of more than two lines, and we still don’t know how to deal with failure.</p>
</div>
<div class="section" id="getting-it-right-the-failure-cases">
<h2>Getting it right: The failure cases<a class="headerlink" href="#getting-it-right-the-failure-cases" title="Permalink to this heading">¶</a></h2>
<p>In what follows, we are going to take each way of expressing order of operations in normal Python (using lines of code and <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code>) and translate them into an equivalent code built with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code> objects.</p>
<p>This is going to be a bit painstaking, but if you want to really understand how to use <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s and maintain code that uses them, it is worth understanding each example below.</p>
<div class="section" id="one-thing-then-another-then-another">
<h3>One thing, then another, then another<a class="headerlink" href="#one-thing-then-another-then-another" title="Permalink to this heading">¶</a></h3>
<p>Recall our example from earlier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()))</span>
</pre></div>
</div>
<p>Also written as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">names</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">sorted_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">sorted_names</span><span class="p">)</span>
</pre></div>
</div>
<p>What if neither <code class="docutils literal notranslate"><span class="pre">get_names</span></code> nor <code class="docutils literal notranslate"><span class="pre">sorted</span></code> can be relied on to finish before they return?
That is, if both are asynchronous operations?</p>
<p>Well, in Twisted-speak they would return <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s and so we would write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">pprint</span><span class="p">)</span>
</pre></div>
</div>
<p>Eventually, <code class="docutils literal notranslate"><span class="pre">sorted</span></code> will get called with whatever <code class="docutils literal notranslate"><span class="pre">get_names</span></code> finally delivers.
When <code class="docutils literal notranslate"><span class="pre">sorted</span></code> finishes, <code class="docutils literal notranslate"><span class="pre">pprint</span></code> will be called with whatever it delivers.</p>
<p>We could also write this as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">pprint</span><span class="p">)</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">d.addCallback</span></code> returns <code class="docutils literal notranslate"><span class="pre">d</span></code>.</p>
</div>
<div class="section" id="simple-failure-handling">
<h3>Simple failure handling<a class="headerlink" href="#simple-failure-handling" title="Permalink to this heading">¶</a></h3>
<p>We often want to write code equivalent to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">report_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>How would we write this with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">get_names</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">report_error</span><span class="p">)</span>
</pre></div>
</div>
<p><em>errback</em> is the Twisted name for a callback that is called when an error is received.</p>
<p>This glosses over an important detail.
Instead of getting the exception object <code class="docutils literal notranslate"><span class="pre">e</span></code>, <code class="docutils literal notranslate"><span class="pre">report_error</span></code> would get a <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> object, which has all of the useful information that <code class="docutils literal notranslate"><span class="pre">e</span></code> does, but is optimized for use with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s.</p>
<p>We’ll dig into that a bit later, after we’ve dealt with all of the other combinations of exceptions.</p>
</div>
<div class="section" id="handle-an-error-but-do-something-else-on-success">
<h3>Handle an error, but do something else on success<a class="headerlink" href="#handle-an-error-but-do-something-else-on-success" title="Permalink to this heading">¶</a></h3>
<p>What if we want to do something after our <code class="docutils literal notranslate"><span class="pre">try</span></code> block if it actually worked?
Abandoning our contrived examples and reaching for generic variable names, we get:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>Well, we’d write it like this with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">addCallbacks</span></code> means “add a callback and an errback at the same time”.
<code class="docutils literal notranslate"><span class="pre">h</span></code> is the callback, <code class="docutils literal notranslate"><span class="pre">g</span></code> is the errback.</p>
<p>Now that we have <code class="docutils literal notranslate"><span class="pre">addCallbacks</span></code> along with <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> and <code class="docutils literal notranslate"><span class="pre">addCallback</span></code>, we can match any possible combination of <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">except</span></code>, <code class="docutils literal notranslate"><span class="pre">else</span></code>, and <code class="docutils literal notranslate"><span class="pre">finally</span></code> by varying the order in which we call them.
Explaining exactly how it works is tricky (although the <a class="reference internal" href="defer.html"><span class="doc">Deferred reference</span></a> does rather a good job), but once we’re through all of the examples it ought to be clearer.</p>
</div>
<div class="section" id="handle-an-error-then-proceed-anyway">
<h3>Handle an error, then proceed anyway<a class="headerlink" href="#handle-an-error-then-proceed-anyway" title="Permalink to this heading">¶</a></h3>
<p>What if we want to do something after our <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> block, regardless of whether or not there was an exception?
That is, what if we wanted to do the equivalent of this generic code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>And with <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> returns <code class="docutils literal notranslate"><span class="pre">d</span></code>, we can chain the calls like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
<p>The order of <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> and <code class="docutils literal notranslate"><span class="pre">addCallback</span></code> matters.
In the next section, we can see what would happen when we swap them around.</p>
</div>
<div class="section" id="handle-an-error-for-the-entire-operation">
<h3>Handle an error for the entire operation<a class="headerlink" href="#handle-an-error-for-the-entire-operation" title="Permalink to this heading">¶</a></h3>
<p>What if we want to wrap up a multi-step operation in one exception handler?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">g</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>With <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s, it would look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Or, more succinctly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="do-something-regardless">
<h3>Do something regardless<a class="headerlink" href="#do-something-regardless" title="Permalink to this heading">¶</a></h3>
<p>What about <code class="docutils literal notranslate"><span class="pre">finally</span></code>?
How do we do something regardless of whether or not there was an exception?
How do we translate this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Well, roughly we do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addBoth</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>This adds <code class="docutils literal notranslate"><span class="pre">g</span></code> as both the callback and the errback.
It is equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>Why “roughly”?
Because if <code class="docutils literal notranslate"><span class="pre">f</span></code> raises, <code class="docutils literal notranslate"><span class="pre">g</span></code> will be passed a <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> object representing the exception.
Otherwise, <code class="docutils literal notranslate"><span class="pre">g</span></code> will be passed the asynchronous equivalent of the return value of <code class="docutils literal notranslate"><span class="pre">f()</span></code> (i.e. <code class="docutils literal notranslate"><span class="pre">y</span></code>).</p>
</div>
<div class="section" id="coroutines-with-async-await">
<h3>Coroutines with async/await<a class="headerlink" href="#coroutines-with-async-await" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 16.4.</span></p>
</div>
</div>
<p>Python 3.5 introduced <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0492/"><strong>PEP 492</strong></a> (“Coroutines with async and await syntax”) and native coroutines.
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> allows you to write coroutines with the <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code> syntax and <code class="docutils literal notranslate"><span class="pre">await</span></code> on Deferreds, similar to <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>.
Rather than decorating every function that may <code class="docutils literal notranslate"><span class="pre">await</span></code> a Deferred (as you would with functions that <code class="docutils literal notranslate"><span class="pre">yield</span></code> Deferreds with <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>), you only need to call <code class="docutils literal notranslate"><span class="pre">fromCoroutine</span></code> with the outer-most coroutine object to schedule it for execution.
Coroutines can <code class="docutils literal notranslate"><span class="pre">await</span></code> other coroutines once running without needing to use this function themselves.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">ensureDeferred</span></code> function also provides a way to convert a coroutine to a Deferred, but it’s interface is more type-ambiguous; <code class="docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> is meant to replace it.</p>
</div>
<p>Awaiting on a Deferred which fires with a Failure will raise the exception inside your coroutine as if it were regular Python.
If your coroutine raises an exception, it will be translated into a Failure fired on the Deferred that <code class="docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> returns for you.
Calling <code class="docutils literal notranslate"><span class="pre">return</span></code> will cause the Deferred that <code class="docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> returned for you to fire with a result.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>
<span class="kn">from</span> <span class="nn">twisted.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">getUsers</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="k">await</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/users&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&quot;makeRequest failed due to connection error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">do</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="o">.</span><span class="n">fromCoroutine</span><span class="p">(</span><span class="n">getUsers</span><span class="p">())</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="nb">print</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>When writing coroutines, you do not need to use <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> when you are writing a coroutine which calls other coroutines which await on Deferreds; you can just <code class="docutils literal notranslate"><span class="pre">await</span></code> on it directly.
For example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">someFunctionThatReturnsADeferred</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="n">baz</span> <span class="o">=</span> <span class="k">await</span> <span class="n">someOtherDeferredFunction</span><span class="p">()</span>
    <span class="n">fooResult</span> <span class="o">=</span> <span class="k">await</span> <span class="n">foo</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">baz</span> <span class="o">+</span> <span class="n">fooResult</span>

<span class="k">def</span> <span class="nf">myDeferredReturningFunction</span><span class="p">():</span>
    <span class="n">coro</span> <span class="o">=</span> <span class="n">bar</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Deferred</span><span class="o">.</span><span class="n">fromCoroutine</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
</pre></div>
</div>
<p>Even though Deferreds were used in both coroutines, only <code class="docutils literal notranslate"><span class="pre">bar</span></code> had to be wrapped in <code class="xref py py-meth docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code> to return a Deferred.</p>
</div>
<div class="section" id="inline-callbacks-using-yield">
<h3>Inline callbacks - using ‘yield’<a class="headerlink" href="#inline-callbacks-using-yield" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless your code supports Python 2 (and therefore needs compatibility with older versions of Twisted), writing coroutines with the functionality described in “Coroutines with async/await” is preferred over <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>.
Coroutines are supported by dedicated Python syntax, are compatible with <code class="docutils literal notranslate"><span class="pre">asyncio</span></code>, and provide higher performance.</p>
</div>
<p>Twisted features a decorator named <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> which allows you to work with Deferreds without writing callback functions.</p>
<p>This is done by writing your code as generators, which <em>yield</em> <code class="docutils literal notranslate"><span class="pre">Deferred</span></code>s instead of attaching callbacks.</p>
<p>Consider the following function written in the traditional <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> style:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getUsers</span><span class="p">():</span>
   <span class="n">d</span> <span class="o">=</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/users&quot;</span><span class="p">)</span>
   <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>using <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>, we can write this as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">inlineCallbacks</span><span class="p">,</span> <span class="n">returnValue</span>

<span class="nd">@inlineCallbacks</span>
<span class="k">def</span> <span class="nf">getUsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">responseBody</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/users&quot;</span><span class="p">)</span>
    <span class="n">returnValue</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">responseBody</span><span class="p">))</span>
</pre></div>
</div>
<p>a couple of things are happening here:</p>
<ol class="arabic simple">
<li><p>instead of calling <code class="docutils literal notranslate"><span class="pre">addCallback</span></code> on the <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> returned by <code class="docutils literal notranslate"><span class="pre">makeRequest</span></code>, we <em>yield</em> it.
This causes Twisted to return the <code class="docutils literal notranslate"><span class="pre">Deferred</span></code>‘s result to us.</p></li>
<li><p>we use <code class="docutils literal notranslate"><span class="pre">returnValue</span></code> to propagate the final result of our function.
Because this function is a generator, we cannot use the return statement; that would be a syntax error.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 15.0.</span></p>
</div>
<p>On Python 3, instead of writing <code class="docutils literal notranslate"><span class="pre">returnValue(json.loads(responseBody))</span></code> you can instead write <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">json.loads(responseBody)</span></code>.
This can be a significant readability advantage, but unfortunately if you need compatibility with Python 2, this isn’t an option.</p>
</div>
<p>Both versions of <code class="docutils literal notranslate"><span class="pre">getUsers</span></code> present exactly the same API to their callers: both return a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> that fires with the parsed JSON body of the request.
Though the <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> version looks like synchronous code, which blocks while waiting for the request to finish, each <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement allows other code to run while waiting for the <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> being yielded to fire.</p>
<p><code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code> become even more powerful when dealing with complex control flow and error handling.
For example, what if <code class="docutils literal notranslate"><span class="pre">makeRequest</span></code> fails due to a connection error?
For the sake of this example, let’s say we want to log the exception and return an empty list.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getUsers</span><span class="p">():</span>
   <span class="n">d</span> <span class="o">=</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/users&quot;</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">connectionError</span><span class="p">(</span><span class="n">failure</span><span class="p">):</span>
       <span class="n">failure</span><span class="o">.</span><span class="n">trap</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">)</span>
       <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&quot;makeRequest failed due to connection error&quot;</span><span class="p">,</span>
                   <span class="n">failure</span><span class="p">)</span>
       <span class="k">return</span> <span class="p">[]</span>

   <span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">connectionError</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code>, we can rewrite this as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@inlineCallbacks</span>
<span class="k">def</span> <span class="nf">getUsers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">responseBody</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">makeRequest</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/users&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
       <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&quot;makeRequest failed due to connection error&quot;</span><span class="p">)</span>
       <span class="n">returnValue</span><span class="p">([])</span>

    <span class="n">returnValue</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">responseBody</span><span class="p">))</span>
</pre></div>
</div>
<p>Our exception handling is simplified because we can use Python’s familiar <code class="docutils literal notranslate"><span class="pre">try</span></code> / <code class="docutils literal notranslate"><span class="pre">except</span></code> syntax for handling <code class="docutils literal notranslate"><span class="pre">ConnectionError</span></code>s.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">¶</a></h2>
<p>You have been introduced to asynchronous code and have seen how to use <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>s to:</p>
<ul class="simple">
<li><p>Do something after an asynchronous operation completes successfully</p></li>
<li><p>Use the result of a successful asynchronous operation</p></li>
<li><p>Catch errors in asynchronous operations</p></li>
<li><p>Do one thing if an operation succeeds, and a different thing if it fails</p></li>
<li><p>Do something after an error has been handled successfully</p></li>
<li><p>Wrap multiple asynchronous operations with one error handler</p></li>
<li><p>Do something after an asynchronous operation, regardless of whether it succeeded or failed</p></li>
<li><p>Write code without callbacks using <code class="docutils literal notranslate"><span class="pre">inlineCallbacks</span></code></p></li>
<li><p>Write coroutines that interact with Deferreds using <code class="docutils literal notranslate"><span class="pre">Deferred.fromCoroutine</span></code></p></li>
</ul>
<p>These are very basic uses of <code class="xref py py-class docutils literal notranslate"><span class="pre">Deferred</span></code>.
For detailed information about how they work, how to combine multiple Deferreds, and how to write code that mixes synchronous and asynchronous APIs, see the <a class="reference internal" href="defer.html"><span class="doc">Deferred reference</span></a>.
Alternatively, read about how to write functions that <a class="reference internal" href="gendefer.html"><span class="doc">generate Deferreds</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="defer.html" class="btn btn-neutral float-right" title="Deferred Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="process.html" class="btn btn-neutral float-left" title="Using Processes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>