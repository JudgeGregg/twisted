

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Using Processes &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction to Deferreds" href="defer-intro.html" />
    <link rel="prev" title="UDP Networking" href="udp.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="servers.html">Writing Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using Processes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-another-process">Running Another Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-processprotocol">Writing a ProcessProtocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#things-that-can-happen-to-your-processprotocol">Things that can happen to your ProcessProtocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#things-you-can-do-from-your-processprotocol">Things you can do from your ProcessProtocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verbose-example">Verbose Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#doing-it-the-easy-way">Doing it the Easy Way</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mapping-file-descriptors">Mapping File Descriptors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3"><a class="reference internal" href="logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Using Processes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/core/howto/process.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-processes">
<h1>Using Processes<a class="headerlink" href="#using-processes" title="Permalink to this heading">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>Along with connection to servers across the internet, Twisted also
connects to local processes with much the same API. The API is described in
more detail in the documentation of:</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.interfaces.IReactorProcess</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.interfaces.IProcessTransport</span></code></p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.interfaces.IProcessProtocol</span></code></p></li>
</ul>
</div>
<div class="section" id="running-another-process">
<h2>Running Another Process<a class="headerlink" href="#running-another-process" title="Permalink to this heading">¶</a></h2>
<p>Processes are run through the reactor,
using <code class="docutils literal notranslate"><span class="pre">reactor.spawnProcess</span></code> . Pipes are created to the child process,
and added to the reactor core so that the application will not block while
sending data into or pulling data out of the new
process. <code class="docutils literal notranslate"><span class="pre">reactor.spawnProcess</span></code> requires two arguments,
<code class="docutils literal notranslate"><span class="pre">processProtocol</span></code> and <code class="docutils literal notranslate"><span class="pre">executable</span></code> , and optionally takes
several more: <code class="docutils literal notranslate"><span class="pre">args</span></code> , <code class="docutils literal notranslate"><span class="pre">environment</span></code> ,
<code class="docutils literal notranslate"><span class="pre">path</span></code> , <code class="docutils literal notranslate"><span class="pre">userID</span></code> , <code class="docutils literal notranslate"><span class="pre">groupID</span></code> ,
<code class="docutils literal notranslate"><span class="pre">usePTY</span></code> , and <code class="docutils literal notranslate"><span class="pre">childFDs</span></code> . Not all of these are
available on Windows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="n">processProtocol</span> <span class="o">=</span> <span class="n">MyProcessProtocol</span><span class="p">()</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">spawnProcess</span><span class="p">(</span><span class="n">processProtocol</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">program</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">],</span>
                     <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;HOME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]},</span> <span class="n">path</span><span class="p">,</span>
                     <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">usePTY</span><span class="p">,</span> <span class="n">childFDs</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">processProtocol</span></code> should be an instance of a subclass of
<code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.ProcessProtocol</span></code> . The
interface is described below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">executable</span></code> is the full path of the program to run. It
will be connected to processProtocol.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code> is a list of command line arguments to be passed to
the process. <code class="docutils literal notranslate"><span class="pre">args[0]</span></code> should be the name of the process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env</span></code> is a dictionary containing the environment to pass
through to the process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path</span></code> is the directory to run the process in. The child
will switch to the given directory just before starting the new program.
The default is to stay in the current directory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uid</span></code> and <code class="docutils literal notranslate"><span class="pre">gid</span></code> are the user ID and group ID to
run the subprocess as. Of course, changing identities will be more likely
to succeed if you start as root.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">usePTY</span></code> specifies whether the child process should be run
with a pty, or if it should just get a pair of pipes.  Whether a program
needs to be run with a PTY or not depends on the particulars of that
program.  Often, programs which primarily interact with users via a terminal
do need a PTY.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">childFDs</span></code> lets you specify how the child’s file
descriptors should be set up. Each key is a file descriptor number (an
integer) as seen by the child. 0, 1, and 2 are usually stdin, stdout, and
stderr, but some programs may be instructed to use additional fds through
command-line arguments or environment variables. Each value is either an
integer specifying one of the parent’s current file descriptors, the
string “r” which creates a pipe that the parent can read from, or the
string “w” which creates a pipe that the parent can write to. If
<code class="docutils literal notranslate"><span class="pre">childFDs</span></code> is not provided, a default is used which creates the
usual stdin-writer, stdout-reader, and stderr-reader pipes.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">args</span></code> and <code class="docutils literal notranslate"><span class="pre">env</span></code> have empty default values, but
many programs depend upon them to be set correctly. At the very least,
<code class="docutils literal notranslate"><span class="pre">args[0]</span></code> should probably be the same as <code class="docutils literal notranslate"><span class="pre">executable</span></code> .
If you just provide <code class="docutils literal notranslate"><span class="pre">os.environ</span></code> for <code class="docutils literal notranslate"><span class="pre">env</span></code> , the child
program will inherit the environment from the current process, which is
usually the civilized thing to do (unless you want to explicitly clean the
environment as a security precaution). The default is to give an empty <code class="docutils literal notranslate"><span class="pre">env</span></code> to the child.</p>
<p><code class="docutils literal notranslate"><span class="pre">reactor.spawnProcess</span></code> returns an instance that implements <code class="xref py py-class docutils literal notranslate"><span class="pre">IProcessTransport</span></code>.</p>
</div>
<div class="section" id="writing-a-processprotocol">
<h2>Writing a ProcessProtocol<a class="headerlink" href="#writing-a-processprotocol" title="Permalink to this heading">¶</a></h2>
<p>The ProcessProtocol you pass to <code class="docutils literal notranslate"><span class="pre">spawnProcess</span></code> is your
interaction with the process. It has a very similar signature to a regular
Protocol, but it has several extra methods to deal with events specific to
a process. In our example, we will interface with ‘wc’ to create a word count
of user-given text. First, we’ll start by importing the required modules, and
writing the initialization for our ProcessProtocol.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span>
<span class="k">class</span> <span class="nc">WCProcessProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ProcessProtocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
</pre></div>
</div>
<p>When the ProcessProtocol is connected to the protocol, it has the
connectionMade method called. In our protocol, we will write our text to the
standard input of our process and then close standard input, to let the
process know we are done writing to it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">closeStdin</span><span class="p">()</span>
</pre></div>
</div>
<p>At this point, the process has received the data, and it’s time for us
to read the results. Instead of being received in <code class="docutils literal notranslate"><span class="pre">dataReceived</span></code> ,
data from standard output is received in <code class="docutils literal notranslate"><span class="pre">outReceived</span></code> . This is
to distinguish it from data on standard error.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">outReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">fieldLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">fieldLength</span><span class="p">])</span>
        <span class="n">words</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">fieldLength</span><span class="p">:</span><span class="n">fieldLength</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">fieldLength</span><span class="o">*</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiveCounts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">chars</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the process has parsed the output, and ended the connection to the
process. Then it sends the results on to the final method, receiveCounts.
This is for users of the class to override, so as to do other things with
the data. For our demonstration, we will just print the results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">receiveCounts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received counts from wc.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lines:&#39;</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Words:&#39;</span><span class="p">,</span> <span class="n">words</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Characters:&#39;</span><span class="p">,</span> <span class="n">chars</span><span class="p">)</span>
</pre></div>
</div>
<p>We’re done! To use our WCProcessProtocol, we create an instance, and pass
it to spawnProcess.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="n">wcProcess</span> <span class="o">=</span> <span class="n">WCProcessProtocol</span><span class="p">(</span><span class="s2">&quot;accessing protocols through Twisted is fun!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">spawnProcess</span><span class="p">(</span><span class="n">wcProcess</span><span class="p">,</span> <span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;wc&#39;</span><span class="p">])</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="things-that-can-happen-to-your-processprotocol">
<h2>Things that can happen to your ProcessProtocol<a class="headerlink" href="#things-that-can-happen-to-your-processprotocol" title="Permalink to this heading">¶</a></h2>
<p>These are the methods that you can usefully override in your subclass of
<code class="docutils literal notranslate"><span class="pre">ProcessProtocol</span></code> :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.connectionMade()</span></code> : This is called when the program is
started, and makes a good place to write data into the stdin pipe (using
<code class="docutils literal notranslate"><span class="pre">self.transport.write</span></code> ).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.outReceived(data)</span></code> : This is called with data that was
received from the process’ stdout pipe. Pipes tend to provide data in
larger chunks than sockets (one kilobyte is a common buffer size), so you
may not experience the “random dribs and drabs” behavior typical of
network sockets, but regardless you should be prepared to deal if you
don’t get all your data in a single call. To do it properly,
<code class="docutils literal notranslate"><span class="pre">outReceived</span></code> ought to simply accumulate the data and put off
doing anything with it until the process has finished.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.errReceived(data)</span></code> : This is called with data from the
process’ stderr pipe. It behaves just like <code class="docutils literal notranslate"><span class="pre">outReceived</span></code> .</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.inConnectionLost</span></code> : This is called when the reactor notices
that the process’ stdin pipe has closed. Programs don’t typically close
their own stdin, so this will probably get called when your
ProcessProtocol has shut down the write side with <code class="docutils literal notranslate"><span class="pre">self.transport.loseConnection</span></code> .</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.outConnectionLost</span></code> : This is called when the program closes
its stdout pipe. This usually happens when the program terminates.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.errConnectionLost</span></code> : Same as
<code class="docutils literal notranslate"><span class="pre">outConnectionLost</span></code> , but for stderr instead of stdout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.processExited(status)</span></code> : This is called when the child
process has been reaped, and receives information about the process’ exit
status. The status is passed in the form of a <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> instance, created with a
<code class="docutils literal notranslate"><span class="pre">.value</span></code> that either holds a <code class="xref py py-class docutils literal notranslate"><span class="pre">ProcessDone</span></code> object if the process
terminated normally (it died of natural causes instead of receiving a
signal, and if the exit code was 0), or a <code class="xref py py-class docutils literal notranslate"><span class="pre">ProcessTerminated</span></code> object (with an
<code class="docutils literal notranslate"><span class="pre">.exitCode</span></code> attribute) if something went wrong.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.processEnded(status)</span></code> : This is called when all the file
descriptors associated with the child process have been closed and the
process has been reaped.  This means it is the last callback which will be
made onto a <code class="docutils literal notranslate"><span class="pre">ProcessProtocol</span></code> .  The <code class="docutils literal notranslate"><span class="pre">status</span></code> parameter
has the same meaning as it does for <code class="docutils literal notranslate"><span class="pre">processExited</span></code> .</p></li>
</ul>
<p>The base-class definitions of most of these functions are no-ops. This will
result in all stdout and stderr being thrown away. Note that it is important
for data you don’t care about to be thrown away: if the pipe were not read,
the child process would eventually block as it tried to write to a full
pipe.</p>
</div>
<div class="section" id="things-you-can-do-from-your-processprotocol">
<h2>Things you can do from your ProcessProtocol<a class="headerlink" href="#things-you-can-do-from-your-processprotocol" title="Permalink to this heading">¶</a></h2>
<p>The following are the basic ways to control the child process:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.write(data)</span></code> : Stuff some data in the stdin
pipe. Note that this <code class="docutils literal notranslate"><span class="pre">write</span></code> method will queue any data that can’t
be written immediately. Writing will resume in the future when the pipe
becomes writable again.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.closeStdin</span></code> : Close the stdin pipe. Programs
which act as filters (reading from stdin, modifying the data, writing to
stdout) usually take this as a sign that they should finish their job and
terminate. For these programs, it is important to close stdin when you’re
done with it, otherwise the child process will never quit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.closeStdout</span></code> : Not usually called, since you’re
putting the process into a state where any attempt to write to stdout will
cause a SIGPIPE error. This isn’t a nice thing to do to the poor
process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.closeStderr</span></code> : Not usually called, same reason
as <code class="docutils literal notranslate"><span class="pre">closeStdout</span></code> .</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.loseConnection</span></code> : Close all three pipes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.signalProcess('KILL')</span></code> : Kill the child
process. This will eventually result in <code class="docutils literal notranslate"><span class="pre">processEnded</span></code> being
called.</p></li>
</ul>
</div>
<div class="section" id="verbose-example">
<h2>Verbose Example<a class="headerlink" href="#verbose-example" title="Permalink to this heading">¶</a></h2>
<p>Here is an example that is rather verbose about exactly when all the
methods are called. It writes a number of lines into the <code class="docutils literal notranslate"><span class="pre">wc</span></code>
program and then parses the output.</p>
<p><a class="reference download internal" download="" href="../../_downloads/17b3972ecc57899bfb8e2c7b395f20c8/process.py"><code class="xref download docutils literal notranslate"><span class="pre">process.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="c1"># See LICENSE for details.</span>


<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>


<span class="k">class</span> <span class="nc">MyPP</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ProcessProtocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verses</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verses</span> <span class="o">=</span> <span class="n">verses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;connectionMade!&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verses</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;Aleph-null bottles of beer on the wall,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Aleph-null bottles of beer,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Take one down and pass it around,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Aleph-null bottles of beer on the wall.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">closeStdin</span><span class="p">()</span>  <span class="c1"># tell them we&#39;re done</span>

    <span class="k">def</span> <span class="nf">outReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;outReceived! with </span><span class="si">%d</span><span class="s2"> bytes!&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">errReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;errReceived! with </span><span class="si">%d</span><span class="s2"> bytes!&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">inConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inConnectionLost! stdin is closed! (we probably did it)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">outConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;outConnectionLost! The child closed their stdout!&quot;</span><span class="p">)</span>
        <span class="c1"># now is the time to examine what they wrote</span>
        <span class="c1"># print(&quot;I saw them write:&quot;, self.data)</span>
        <span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I saw </span><span class="si">%s</span><span class="s2"> lines&quot;</span> <span class="o">%</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">errConnectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;errConnectionLost! The child closed their stderr.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">processExited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processExited, status </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exitCode</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">processEnded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processEnded, status </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exitCode</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;quitting&quot;</span><span class="p">)</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="n">pp</span> <span class="o">=</span> <span class="n">MyPP</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">spawnProcess</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="s2">&quot;wc&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;wc&quot;</span><span class="p">],</span> <span class="p">{})</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The exact output of this program depends upon the relative timing of some
un-synchronized events. In particular, the program may observe the child
process close its stderr pipe before or after it reads data from the stdout
pipe. One possible transcript would look like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">% </span>./process.py
<span class="go">connectionMade!</span>
<span class="go">inConnectionLost! stdin is closed! (we probably did it)</span>
<span class="go">errConnectionLost! The child closed their stderr.</span>
<span class="go">outReceived! with 24 bytes!</span>
<span class="go">outConnectionLost! The child closed their stdout!</span>
<span class="go">I saw 40 lines</span>
<span class="go">processEnded, status 0</span>
<span class="go">quitting</span>
<span class="go">Main loop terminated.</span>
<span class="gp">%</span>
</pre></div>
</div>
</div>
<div class="section" id="doing-it-the-easy-way">
<h2>Doing it the Easy Way<a class="headerlink" href="#doing-it-the-easy-way" title="Permalink to this heading">¶</a></h2>
<p>Frequently, one just needs a simple way to get all the output from a
program. In the blocking world, you might use <code class="docutils literal notranslate"><span class="pre">commands.getoutput</span></code> from the standard library, but
using that in an event-driven program will cause everything else to stall
until the command finishes. (in addition, the SIGCHLD handler used by that
function does not play well with Twisted’s own signal handling). For these
cases, the <code class="xref py py-func docutils literal notranslate"><span class="pre">twisted.internet.utils.getProcessOutput()</span></code>
function can be used. Here is a simple example:</p>
<p><a class="reference download internal" download="" href="../../_downloads/8317d306f698ed7ca84f64d74bc78d01/quotes.py"><code class="xref download docutils literal notranslate"><span class="pre">quotes.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">failure</span>


<span class="k">class</span> <span class="nc">FortuneQuoter</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="n">fortune</span> <span class="o">=</span> <span class="s2">&quot;/usr/games/fortune&quot;</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fortune</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writeResponse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noResponse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">noResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">Factory</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FortuneQuoter</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">listenTCP</span><span class="p">(</span><span class="mi">10999</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>If you only need the final exit code (like <code class="docutils literal notranslate"><span class="pre">commands.getstatusoutput(cmd)[0]</span></code> ), the <code class="xref py py-func docutils literal notranslate"><span class="pre">twisted.internet.utils.getProcessValue()</span></code> function is
useful. Here is an example:</p>
<p><a class="reference download internal" download="" href="../../_downloads/d97e663c0d589210a72625f3b83271c7/trueandfalse.py"><code class="xref download docutils literal notranslate"><span class="pre">trueandfalse.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">utils</span>


<span class="k">def</span> <span class="nf">printTrueValue</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/bin/true exits with rc=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessValue</span><span class="p">(</span><span class="s2">&quot;/bin/false&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">printFalseValue</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">printFalseValue</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;/bin/false exits with rc=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>


<span class="n">output</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessValue</span><span class="p">(</span><span class="s2">&quot;/bin/true&quot;</span><span class="p">)</span>
<span class="n">output</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">printTrueValue</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-file-descriptors">
<h2>Mapping File Descriptors<a class="headerlink" href="#mapping-file-descriptors" title="Permalink to this heading">¶</a></h2>
<p>“stdin” , “stdout” , and “stderr” are just conventions.
Programs which operate as filters generally accept input on fd0, write their
output on fd1, and emit error messages on fd2. This is common enough that
the standard C library provides macros like “stdin” to mean fd0, and
shells interpret the pipe character “|” to mean “redirect fd1 from one command into fd0 of the next command” .</p>
<p>But these are just conventions, and programs are free to use additional
file descriptors or even ignore the standard three entirely. The”childFDs” argument allows you to specify exactly what kind of files
descriptors the child process should be given.</p>
<p>Each child FD can be put into one of three states:</p>
<ul class="simple">
<li><p>Mapped to a parent FD: this causes the child’s reads and writes to
come from or go to the same source/destination as the parent.</p></li>
<li><p>Feeding into a pipe which can be read by the parent.</p></li>
<li><p>Feeding from a pipe which the parent writes into.</p></li>
</ul>
<p>Mapping the child FDs to the parent’s is very commonly used to send the
child’s stderr output to the same place as the parent’s. When you run a
program from the shell, it will typically leave fds 0, 1, and 2 mapped to
the shell’s 0, 1, and 2, allowing you to see the child program’s output on
the same terminal you used to launch the child. Likewise, inetd will
typically map both stdin and stdout to the network socket, and may map
stderr to the same socket or to some kind of logging mechanism. This allows
the child program to be implemented with no knowledge of the network: it
merely speaks its protocol by doing reads on fd0 and writes on fd1.</p>
<p>Feeding into a parent’s read pipe is used to gather output from the
child, and is by far the most common way of interacting with child
processes.</p>
<p>Feeding from a parent’s write pipe allows the parent to control the
child. Programs like “bc” or “ftp” can be controlled this way, by
writing commands into their stdin stream.</p>
<p>The “childFDs” dictionary maps file descriptor numbers (as will be
seen by the child process) to one of these three states. To map the fd to
one of the parent’s fds, simply provide the fd number as the value. To map
it to a read pipe, use the string “r” as the value. To map it to a
write pipe, use the string “w” .</p>
<p>For example, the default mapping sets up the standard stdin/stdout/stderr
pipes. It is implemented with the following dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">childFDs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span> <span class="p">}</span>
</pre></div>
</div>
<p>To launch a process which reads and writes to the same places that the
parent python program does, use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">childFDs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
</pre></div>
</div>
<p>To write into an additional fd (say it is fd number 4), use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">childFDs</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span> <span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="processprotocols-with-extra-file-descriptors">
<h3>ProcessProtocols with extra file descriptors<a class="headerlink" href="#processprotocols-with-extra-file-descriptors" title="Permalink to this heading">¶</a></h3>
<p>When you provide a “childFDs” dictionary with more than the normal
three fds, you need additional methods to access those pipes. These methods
are more generalized than the <code class="docutils literal notranslate"><span class="pre">.outReceived</span></code> ones described above.
In fact, those methods (<code class="docutils literal notranslate"><span class="pre">outReceived</span></code> and
<code class="docutils literal notranslate"><span class="pre">errReceived</span></code> ) are actually just wrappers left in for
compatibility with older code, written before this generalized fd mapping was
implemented. The new list of things that can happen to your ProcessProtocol
is as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.connectionMade</span></code> : This is called when the program is
started.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.childDataReceived(childFD,</span> <span class="pre">data)</span></code> : This is called with
data that was received from one of the process’ output pipes (i.e. where
the childFDs value was “r” . The actual file number (from the point of
view of the child process) is in “childFD” . For compatibility, the
default implementation of <code class="docutils literal notranslate"><span class="pre">.childDataReceived</span></code> dispatches to
<code class="docutils literal notranslate"><span class="pre">.outReceived</span></code> or <code class="docutils literal notranslate"><span class="pre">.errReceived</span></code> when “childFD”
is 1 or 2.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.childConnectionLost(childFD)</span></code> : This is called when the
reactor notices that one of the process’ pipes has been closed. This
either means you have just closed down the parent’s end of the pipe (with
<code class="docutils literal notranslate"><span class="pre">.transport.closeChildFD</span></code> ), the child closed the pipe
explicitly (sometimes to indicate EOF), or the child process has
terminated and the kernel has closed all of its pipes. The “childFD”
argument tells you which pipe was closed. Note that you can only find out
about file descriptors which were mapped to pipes: when they are mapped to
existing fds the parent has no way to notice when they’ve been closed. For
compatibility, the default implementation dispatches to
<code class="docutils literal notranslate"><span class="pre">.inConnectionLost</span></code> , <code class="docutils literal notranslate"><span class="pre">.outConnectionLost</span></code> , or
<code class="docutils literal notranslate"><span class="pre">.errConnectionLost</span></code> .</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.processEnded(status)</span></code> : This is called when the child
process has been reaped, and all pipes have been closed. This insures that
all data written by the child prior to its death will be received before
<code class="docutils literal notranslate"><span class="pre">.processEnded</span></code> is invoked.</p></li>
</ul>
<p>In addition to those methods, there are other methods available to
influence the child process:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.writeToChild(childFD,</span> <span class="pre">data)</span></code> : Stuff some
data into an input pipe. <code class="docutils literal notranslate"><span class="pre">.write</span></code> simply writes to
childFD=0.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">self.transport.closeChildFD(childFD)</span></code> : Close one of the
child’s pipes. Closing an input pipe is a common way to indicate EOF to
the child process. Closing an output pipe is neither very friendly nor
very useful.</p></li>
</ul>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h3>
<p>GnuPG, the encryption program, can use additional file descriptors to
accept a passphrase and emit status output. These are distinct from stdin
(used to accept the crypttext), stdout (used to emit the plaintext), and
stderr (used to emit human-readable status/warning messages). The passphrase
FD reads until the pipe is closed and uses the resulting string to unlock
the secret key that performs the actual decryption. The status FD emits
machine-parseable status messages to indicate the validity of the signature,
which key the message was encrypted to, etc.</p>
<p>gpg accepts command-line arguments to specify what these fds are, and
then assumes that they have been opened by the parent before the gpg process
is started. It simply performs reads and writes to these fd numbers.</p>
<p>To invoke gpg in decryption/verification mode, you would do something
like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GPGProtocol</span><span class="p">(</span><span class="n">ProcessProtocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crypttext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crypttext</span> <span class="o">=</span> <span class="n">crypttext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">writeToChild</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passphrase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">closeChildFD</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">writeToChild</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crypttext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">closeChildFD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">childDataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">childFD</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">childFD</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">plaintext</span> <span class="o">+=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">childFD</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">processEnded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exitCode</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="o">.</span><span class="n">errback</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">crypttext</span><span class="p">):</span>
    <span class="n">gp</span> <span class="o">=</span> <span class="n">GPGProtocol</span><span class="p">(</span><span class="n">crypttext</span><span class="p">)</span>
    <span class="n">gp</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gpg&quot;</span><span class="p">,</span> <span class="s2">&quot;--decrypt&quot;</span><span class="p">,</span> <span class="s2">&quot;--passphrase-fd&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;--status-fd&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--batch&quot;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">spawnProcess</span><span class="p">(</span><span class="n">gp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">childFDs</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;r&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">gp</span><span class="o">.</span><span class="n">deferred</span>
</pre></div>
</div>
<p>In this example, the status output could be parsed after the fact. It
could, of course, be parsed on the fly, as it is a simple line-oriented
protocol. Methods from LineReceiver could be mixed in to make this parsing
more convenient.</p>
<p>The stderr mapping (“2:2” ) used will cause any GPG errors to be
emitted by the parent program, just as if those errors had caused in the
parent itself. This is sometimes desirable (it roughly corresponds to
letting exceptions propagate upwards), especially if you do not expect to
encounter errors in the child process and want them to be more visible to
the end user. The alternative is to map stderr to a read-pipe and handle any
such output from within the ProcessProtocol (roughly corresponding to
catching the exception locally).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="defer-intro.html" class="btn btn-neutral float-right" title="Introduction to Deferreds" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="udp.html" class="btn btn-neutral float-left" title="UDP Networking" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>