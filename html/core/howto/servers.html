

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Writing Servers &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Writing Clients" href="clients.html" />
    <link rel="prev" title="The Vision For Twisted" href="vision.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing Servers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#protocols">Protocols</a></li>
<li class="toctree-l4"><a class="reference internal" href="#factories">Factories</a></li>
<li class="toctree-l4"><a class="reference internal" href="#putting-it-all-together">Putting it All Together</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/index.html">Twisted from Scratch, or The Evolution of Finger</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/intro.html">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="tutorial/configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="process.html">Using Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3"><a class="reference internal" href="logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Twisted Core</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Writing Servers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/core/howto/servers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-servers">
<h1>Writing Servers<a class="headerlink" href="#writing-servers" title="Permalink to this heading">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>This document explains how you can use Twisted to implement network protocol parsing and handling for TCP servers (the same code can be reused for SSL and Unix socket servers).
There is a <a class="reference internal" href="udp.html"><span class="doc">separate document</span></a> covering UDP.</p>
<p>Your protocol handling class will usually subclass <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.Protocol</span></code>.
Most protocol handlers inherit either from this class or from one of its convenience children.
An instance of the protocol class is instantiated per-connection, on demand, and will go away when the connection is finished.
This means that persistent configuration is not saved in the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>.</p>
<p>The persistent configuration is kept in a <code class="docutils literal notranslate"><span class="pre">Factory</span></code> class, which usually inherits from <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.Factory</span></code>.
The <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> is used to create a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> for each new connection.</p>
<p>It is usually useful to be able to offer the same service on multiple ports or network addresses.
This is why the <code class="docutils literal notranslate"><span class="pre">Factory</span></code> does not listen to connections, and in fact does not know anything about the network.
See <a class="reference internal" href="endpoints.html"><span class="doc">the endpoints documentation</span></a> for more information, or <code class="xref py py-meth docutils literal notranslate"><span class="pre">IReactorTCP.listenTCP</span></code> and the other <code class="docutils literal notranslate"><span class="pre">IReactor*.listen*</span></code> APIs for the lower level APIs that endpoints are based on.</p>
<p>This document will explain each step of the way.</p>
</div>
<div class="section" id="protocols">
<h2>Protocols<a class="headerlink" href="#protocols" title="Permalink to this heading">¶</a></h2>
<p>As mentioned above, this, along with auxiliary classes and functions, is where most of the code is.
A Twisted protocol handles data in an asynchronous manner.
The protocol responds to events as they arrive from the network and the events arrive as calls to methods on the protocol.</p>
<p>Here is a simple example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>This is one of the simplest protocols.
It simply writes back whatever is written to it, and does not respond to all events.
Here is an example of a Protocol responding to another event:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">QOTD</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;An apple a day keeps the doctor away</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
</pre></div>
</div>
<p>This protocol responds to the initial connection with a well known quote, and then terminates the connection.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">connectionMade</span></code> event is usually where setup of the connection object happens, as well as any initial greetings (as in the QOTD protocol above, which is actually based on <span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc865.html"><strong>RFC 865</strong></a>).
The <code class="docutils literal notranslate"><span class="pre">connectionLost</span></code> event is where tearing down of any connection-specific objects is done.
Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">factory</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">numProtocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">numProtocols</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s2">&quot;Welcome! There are currently </span><span class="si">%d</span><span class="s2"> open connections.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">numProtocols</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">numProtocols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">numProtocols</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">connectionMade</span></code> and <code class="docutils literal notranslate"><span class="pre">connectionLost</span></code> cooperate to keep a count of the active protocols in a shared object, the factory.
The factory must be passed to <code class="docutils literal notranslate"><span class="pre">Echo.__init__</span></code> when creating a new instance.
The factory is used to share state that exists beyond the lifetime of any given connection.
You will see why this object is called a “factory” in the next section.</p>
<div class="section" id="loseconnection-and-abortconnection">
<h3>loseConnection() and abortConnection()<a class="headerlink" href="#loseconnection-and-abortconnection" title="Permalink to this heading">¶</a></h3>
<p>In the code above, <code class="docutils literal notranslate"><span class="pre">loseConnection</span></code> is called immediately after writing to the transport.
The <code class="docutils literal notranslate"><span class="pre">loseConnection</span></code> call will close the connection only when all the data has been written by Twisted out to the operating system, so it is safe to use in this case without worrying about transport writes being lost.
If a <a class="reference internal" href="producers.html"><span class="doc">producer</span></a> is being used with the transport, <code class="docutils literal notranslate"><span class="pre">loseConnection</span></code> will only close the connection once the producer is unregistered.</p>
<p>In some cases, waiting until all the data is written out is not what we want.
Due to network failures, or bugs or maliciousness in the other side of the connection, data written to the transport may not be deliverable, and so even though <code class="docutils literal notranslate"><span class="pre">loseConnection</span></code> was called the connection will not be lost.
In these cases, <code class="docutils literal notranslate"><span class="pre">abortConnection</span></code> can be used: it closes the connection immediately, regardless of buffered data that is still unwritten in the transport, or producers that are still registered.
Note that <code class="docutils literal notranslate"><span class="pre">abortConnection</span></code> is only available in Twisted 11.1 and newer.</p>
</div>
<div class="section" id="using-the-protocol">
<h3>Using the Protocol<a class="headerlink" href="#using-the-protocol" title="Permalink to this heading">¶</a></h3>
<p>In this section, you will learn how to run a server which uses your <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>.</p>
<p>Here is code that will run the QOTD server discussed earlier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ServerEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">QOTDFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QOTD</span><span class="p">()</span>

<span class="c1"># 8007 is the port you want to run under. Choose something &gt;1024</span>
<span class="n">endpoint</span> <span class="o">=</span> <span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8007</span><span class="p">)</span>
<span class="n">endpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">QOTDFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>In this example, I create a protocol <code class="docutils literal notranslate"><span class="pre">Factory</span></code>.
I want to tell this factory that its job is to build QOTD protocol instances, so I set its <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code> method to return instances of the QOTD class.
Then, I want to listen on a TCP port, so I make a <code class="xref py py-class docutils literal notranslate"><span class="pre">TCP4ServerEndpoint</span></code> to identify the port that I want to bind to, and then pass the factory I just created to its <code class="docutils literal notranslate"><span class="pre">listen</span></code> method.</p>
<p><code class="docutils literal notranslate"><span class="pre">endpoint.listen()</span></code> tells the reactor to handle connections to the endpoint’s address using a particular protocol, but the reactor needs to be <em>running</em> in order for it to do anything.
<code class="docutils literal notranslate"><span class="pre">reactor.run()</span></code> starts the reactor and then waits forever for connections to arrive on the port you’ve specified.
You can stop the reactor by hitting Control-C in a terminal or calling <code class="docutils literal notranslate"><span class="pre">reactor.stop()</span></code>.</p>
<p>For more information on different ways you can listen for incoming connections, see <a class="reference internal" href="endpoints.html"><span class="doc">the documentation for the endpoints API</span></a>.
For more information on using the reactor, see <a class="reference internal" href="reactor-basics.html"><span class="doc">the reactor overview</span></a>.</p>
</div>
<div class="section" id="helper-protocols">
<h3>Helper Protocols<a class="headerlink" href="#helper-protocols" title="Permalink to this heading">¶</a></h3>
<p>Many protocols build upon similar lower-level abstractions.</p>
<p>For example, many popular internet protocols are line-based, containing text data terminated by line breaks (commonly CR-LF), rather than containing straight raw data.
However, quite a few protocols are mixed - they have line-based sections and then raw data sections.
Examples include HTTP/1.1 and the Freenet protocol.</p>
<p>For those cases, there is the <code class="xref py py-class docutils literal notranslate"><span class="pre">LineReceiver</span></code> protocol.
This protocol dispatches to two different event handlers – <code class="docutils literal notranslate"><span class="pre">lineReceived</span></code> and <code class="docutils literal notranslate"><span class="pre">rawDataReceived</span></code>.
By default, only <code class="docutils literal notranslate"><span class="pre">lineReceived</span></code> will be called, once for each line.
However, if <code class="docutils literal notranslate"><span class="pre">setRawMode</span></code> is called, the protocol will call <code class="docutils literal notranslate"><span class="pre">rawDataReceived</span></code> until <code class="docutils literal notranslate"><span class="pre">setLineMode</span></code> is called, which returns it to using <code class="docutils literal notranslate"><span class="pre">lineReceived</span></code>.
It also provides a method, <code class="docutils literal notranslate"><span class="pre">sendLine</span></code>, that writes data to the transport along with the delimiter the class uses to split lines (by default, <code class="docutils literal notranslate"><span class="pre">\r\n</span></code>).</p>
<p>Here is an example for a simple use of the line receiver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.basic</span> <span class="kn">import</span> <span class="n">LineReceiver</span>

<span class="k">class</span> <span class="nc">Answer</span><span class="p">(</span><span class="n">LineReceiver</span><span class="p">):</span>

    <span class="n">answers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;How are you?&#39;</span><span class="p">:</span> <span class="s1">&#39;Fine&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;I don&#39;t know what you mean&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="p">[</span><span class="n">line</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
</pre></div>
</div>
<p>Note that the delimiter is not part of the line.</p>
<p>Several other helpers exist, such as a <code class="xref py py-class docutils literal notranslate"><span class="pre">netstring</span> <span class="pre">based</span> <span class="pre">protocol</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">prefixed-message-length</span> <span class="pre">protocols</span></code>.</p>
</div>
<div class="section" id="state-machines">
<h3>State Machines<a class="headerlink" href="#state-machines" title="Permalink to this heading">¶</a></h3>
<p>Many Twisted protocol handlers need to write a state machine to record the state they are at.
Here are some pieces of advice which help to write state machines:</p>
<ul class="simple">
<li><p>Don’t write big state machines.
Prefer to write a state machine which deals with one level of abstraction at a time.</p></li>
<li><p>Don’t mix application-specific code with Protocol handling code.
When the protocol handler has to make an application-specific call, keep it as a method call.</p></li>
</ul>
</div>
</div>
<div class="section" id="factories">
<h2>Factories<a class="headerlink" href="#factories" title="Permalink to this heading">¶</a></h2>
<div class="section" id="simpler-protocol-creation">
<h3>Simpler Protocol Creation<a class="headerlink" href="#simpler-protocol-creation" title="Permalink to this heading">¶</a></h3>
<p>For a factory which simply instantiates instances of a specific protocol class, there is a simpler way to implement the factory.
The default implementation of the <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code> method calls the <code class="docutils literal notranslate"><span class="pre">protocol</span></code> attribute of the factory to create a <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> instance, and then sets an attribute on it called <code class="docutils literal notranslate"><span class="pre">factory</span></code> which points to the factory itself.
This lets every <code class="docutils literal notranslate"><span class="pre">Protocol</span></code> access, and possibly modify, the persistent configuration.
Here is an example that uses these features instead of overriding <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span><span class="p">,</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ServerEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">QOTD</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.factory was set by the factory&#39;s default buildProtocol:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">quote</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">QOTDFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

    <span class="c1"># This will be used by the default buildProtocol to create new protocols:</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">QOTD</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span> <span class="ow">or</span> <span class="s1">&#39;An apple a day keeps the doctor away&#39;</span>

<span class="n">endpoint</span> <span class="o">=</span> <span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8007</span><span class="p">)</span>
<span class="n">endpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">QOTDFactory</span><span class="p">(</span><span class="s2">&quot;configurable quote&quot;</span><span class="p">))</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>If all you need is a simple factory that builds a protocol without any additional behavior, Twisted 13.1 added <code class="xref py py-meth docutils literal notranslate"><span class="pre">Factory.forProtocol</span></code>, an even simpler approach.</p>
</div>
<div class="section" id="factory-startup-and-shutdown">
<h3>Factory Startup and Shutdown<a class="headerlink" href="#factory-startup-and-shutdown" title="Permalink to this heading">¶</a></h3>
<p>A Factory has two methods to perform application-specific building up and tearing down (since a Factory is frequently persisted, it is often not appropriate to do them in <code class="docutils literal notranslate"><span class="pre">__init__</span></code> or <code class="docutils literal notranslate"><span class="pre">__del__</span></code>, and would frequently be too early or too late).</p>
<p>Here is an example of a factory which allows its Protocols to write to a special log-file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.protocols.basic</span> <span class="kn">import</span> <span class="n">LineReceiver</span>


<span class="k">class</span> <span class="nc">LoggingProtocol</span><span class="p">(</span><span class="n">LineReceiver</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LogfileFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>

    <span class="n">protocol</span> <span class="o">=</span> <span class="n">LoggingProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">fileName</span>

    <span class="k">def</span> <span class="nf">startFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="putting-it-all-together">
<h2>Putting it All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">¶</a></h2>
<p>As a final example, here’s a simple chat server that allows users to choose a username and then communicate with other users.
It demonstrates the use of shared state in the factory, a state machine for each individual protocol, and communication between different protocols.</p>
<p><a class="reference download internal" download="" href="../../_downloads/b941073b15f73d3a0381abc796a24bc4/chat.py"><code class="xref download docutils literal notranslate"><span class="pre">chat.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.protocols.basic</span> <span class="kn">import</span> <span class="n">LineReceiver</span>


<span class="k">class</span> <span class="nc">Chat</span><span class="p">(</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;GETNAME&quot;</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="s2">&quot;What&#39;s your name?&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;GETNAME&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_GETNAME</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_CHAT</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_GETNAME</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="s2">&quot;Name taken, please choose another.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Welcome, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;CHAT&quot;</span>

    <span class="k">def</span> <span class="nf">handle_CHAT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">protocol</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">protocol</span><span class="o">.</span><span class="n">sendLine</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChatFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maps user names to Chat instances</span>

    <span class="k">def</span> <span class="nf">buildProtocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Chat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">)</span>


<span class="n">reactor</span><span class="o">.</span><span class="n">listenTCP</span><span class="p">(</span><span class="mi">8123</span><span class="p">,</span> <span class="n">ChatFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The only API you might not be familiar with is <code class="docutils literal notranslate"><span class="pre">listenTCP</span></code>.
<code class="xref py py-meth docutils literal notranslate"><span class="pre">listenTCP</span></code> is the method which connects a <code class="docutils literal notranslate"><span class="pre">Factory</span></code> to the network.
This is the lower-level API that <a class="reference internal" href="endpoints.html"><span class="doc">endpoints</span></a> wraps for you.</p>
<p>Here’s a sample transcript of a chat session (emphasised text is entered by the user):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="gp"> $ </span>telnet <span class="m">127</span>.0.0.1 <span class="m">8123</span>
</span><span class="go"> Trying 127.0.0.1...</span>
<span class="go"> Connected to 127.0.0.1.</span>
<span class="go"> Escape character is &#39;^]&#39;.</span>
<span class="go"> What&#39;s your name?</span>
<span class="hll"><span class="go"> test</span>
</span><span class="go"> Name taken, please choose another.</span>
<span class="hll"><span class="go"> bob</span>
</span><span class="go"> Welcome, bob!</span>
<span class="hll"><span class="go"> hello</span>
</span><span class="go"> &lt;alice&gt; hi bob</span>
<span class="hll"><span class="go"> twisted makes writing servers so easy!</span>
</span><span class="go"> &lt;alice&gt; I couldn&#39;t agree more</span>
<span class="go"> &lt;carrol&gt; yeah, it&#39;s great</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="clients.html" class="btn btn-neutral float-right" title="Writing Clients" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="vision.html" class="btn btn-neutral float-left" title="The Vision For Twisted" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>