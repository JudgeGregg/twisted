

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>The Evolution of Finger: building a simple finger service &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="The Evolution of Finger: adding features to the finger service" href="protocol.html" />
    <link rel="prev" title="Twisted from Scratch, or The Evolution of Finger" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Twisted Core</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../vision.html">The Vision For Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="../servers.html">Writing Servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../clients.html">Writing Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trial.html">Test-driven development with Twisted</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Twisted from Scratch, or The Evolution of Finger</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">The Evolution of Finger: building a simple finger service</a></li>
<li class="toctree-l4"><a class="reference internal" href="protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l4"><a class="reference internal" href="style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l4"><a class="reference internal" href="components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l4"><a class="reference internal" href="web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l4"><a class="reference internal" href="factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l4"><a class="reference internal" href="client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l4"><a class="reference internal" href="library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l4"><a class="reference internal" href="configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#contents">Contents</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The Evolution of Finger: building a simple finger service</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#refuse-connections">Refuse Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#do-nothing">Do Nothing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drop-connections">Drop Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-username-drop-connections">Read Username, Drop Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-username-output-error-drop-connections">Read Username, Output Error, Drop Connections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-from-empty-factory">Output From Empty Factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-from-non-empty-factory">Output from Non-empty Factory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-deferreds">Use Deferreds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-finger-locally">Run ‘finger’ Locally</a></li>
<li class="toctree-l4"><a class="reference internal" href="#read-status-from-the-web">Read Status from the Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-application">Use Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#twistd">twistd</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="protocol.html">The Evolution of Finger: adding features to the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="style.html">The Evolution of Finger: cleaning up the finger code</a></li>
<li class="toctree-l3"><a class="reference internal" href="components.html">The Evolution of Finger: moving to a component based architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="backends.html">The Evolution of Finger: pluggable backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="web.html">The Evolution of Finger: a web frontend</a></li>
<li class="toctree-l3"><a class="reference internal" href="pb.html">The Evolution of Finger: Twisted client support using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="factory.html">The Evolution of Finger: using a single factory for multiple protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="client.html">The Evolution of Finger: a Twisted finger client</a></li>
<li class="toctree-l3"><a class="reference internal" href="library.html">The Evolution of Finger: making a finger library</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html">The Evolution of Finger: configuration of the finger service</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quotes.html">Setting up the TwistedQuotes application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../design.html">Designing Twisted Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internet-overview.html">Overview of Twisted Internet</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reactor-basics.html">Reactor Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ssl.html">Using TLS in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="../udp.html">UDP Networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../process.html">Using Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../defer-intro.html">Introduction to Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../defer.html">Deferred Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gendefer.html">Generating Deferreds</a></li>
<li class="toctree-l3"><a class="reference internal" href="../time.html">Scheduling tasks for the future</a></li>
<li class="toctree-l3"><a class="reference internal" href="../threading.html">Using Threads in Twisted</a></li>
<li class="toctree-l3"><a class="reference internal" href="../producers.html">Producers and Consumers: Efficient High-Volume Streaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="../choosing-reactor.html">Choosing a Reactor and GUI Toolkit Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../endpoints.html">Getting Connected with Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../components.html">Components: Interfaces and Adapters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cred.html">Cred: Pluggable Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugin.html">The Twisted Plugin System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../basics.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../application.html">Using the Twisted Application Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tap.html">Writing a twistd Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../systemd.html">Deploying Twisted with systemd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logger.html">Logging with twisted.logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logging.html">Twisted’s Legacy Logging System: <code class="docutils literal notranslate"><span class="pre">twisted.python.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../constants.html">Symbolic Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rdbms.html">twisted.enterprise.adbapi: Twisted RDBMS support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../options.html">Parsing command-lines with usage.Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dirdbm.html">DirDBM: Directory-based Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../testing.html">Writing tests for Twisted code using Trial</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sendmsg.html">Extremely Low-Level Socket Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../amp.html">Asynchronous Messaging Protocol Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb.html">Overview of Twisted Spread</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-intro.html">Introduction to Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-usage.html">Using Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-clients.html">Managing Clients of Perspectives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-copyable.html">PB Copyable: Passing Complex Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-cred.html">Authentication with Perspective Broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pb-limits.html">PB Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../python3.html">Porting to Python 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="../positioning.html">Twisted Positioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Twisted Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug-with-emacs.html">Debugging Python(Twisted) with Emacs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../specifications/index.html">Specifications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Twisted Core</a> &raquo;</li>
        
          <li><a href="../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="index.html">Twisted from Scratch, or The Evolution of Finger</a> &raquo;</li>
        
      <li>The Evolution of Finger: building a simple finger service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/core/howto/tutorial/intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-evolution-of-finger-building-a-simple-finger-service">
<h1>The Evolution of Finger: building a simple finger service<a class="headerlink" href="#the-evolution-of-finger-building-a-simple-finger-service" title="Permalink to this heading">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>This is the first part of the Twisted tutorial <a class="reference internal" href="index.html"><span class="doc">Twisted from Scratch, or The Evolution of Finger</span></a> .</p>
<p>If you’re not familiar with ‘finger’ it’s probably because it’s not used as
much nowadays as it used to be. Basically, if you run <code class="docutils literal notranslate"><span class="pre">finger</span> <span class="pre">nail</span></code>
or <code class="docutils literal notranslate"><span class="pre">finger</span> <span class="pre">nail&#64;example.com</span></code> the target computer spits out some
information about the user named <code class="docutils literal notranslate"><span class="pre">nail</span></code> . For instance:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Login: nail                           Name: Nail Sharp</span>
<span class="go">Directory: /home/nail                 Shell: /usr/bin/sh</span>
<span class="go">Last login Wed Mar 31 18:32 2004 (PST)</span>
<span class="go">New mail received Thu Apr  1 10:50 2004 (PST)</span>
<span class="go">     Unread since Thu Apr  1 10:50 2004 (PST)</span>
<span class="go">No Plan.</span>
</pre></div>
</div>
<p>If the target computer does not have
the <code class="docutils literal notranslate"><span class="pre">fingerd</span></code> <a class="reference internal" href="../glossary.html#core-howto-glossary-daemon"><span class="std std-ref">daemon</span></a>
running you’ll get a “Connection Refused” error. Paranoid sysadmins
keep <code class="docutils literal notranslate"><span class="pre">fingerd</span></code> off or limit the output to hinder crackers
and harassers. The above format is the standard <code class="docutils literal notranslate"><span class="pre">fingerd</span></code>
default, but an alternate implementation can output anything it wants,
such as automated responsibility status for everyone in an
organization. You can also define pseudo “users”, which are
essentially keywords.</p>
<p>This portion of the tutorial makes use of factories and protocols as
introduced in the <a class="reference internal" href="../servers.html"><span class="doc">Writing a TCP Server howto</span></a> and
deferreds as introduced in <a class="reference internal" href="../defer.html"><span class="doc">Using Deferreds</span></a>
and <a class="reference internal" href="../gendefer.html"><span class="doc">Generating Deferreds</span></a> . Services and
applications are discussed in <a class="reference internal" href="../application.html"><span class="doc">Using the Twisted Application Framework</span></a> .</p>
<p>By the end of this section of the tutorial, our finger server will answer
TCP finger requests on port 1079, and will read data from the web.</p>
</div>
<div class="section" id="refuse-connections">
<h2>Refuse Connections<a class="headerlink" href="#refuse-connections" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/6ba224ee48188dfe78bdf6f0687971ab/finger01.py"><code class="xref download docutils literal notranslate"><span class="pre">finger01.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>This example only runs the reactor. It will consume almost no CPU
resources. As it is not listening on any port, it can’t respond to network
requests — nothing at all will happen until we interrupt the program.  At
this point if you run <code class="docutils literal notranslate"><span class="pre">finger</span> <span class="pre">nail</span></code> or <code class="docutils literal notranslate"><span class="pre">telnet</span> <span class="pre">localhost</span> <span class="pre">1079</span></code> , you’ll get a “Connection refused” error since there’s no daemon
running to respond.  Not very useful, perhaps — but this is the skeleton
inside which the Twisted program will grow.</p>
<p>As implied above, at various points in this tutorial you’ll want to
observe the behavior of the server being developed.  Unless you have a
finger program which can use an alternate port, the easiest way to do this
is with a telnet client.  <code class="docutils literal notranslate"><span class="pre">telnet</span> <span class="pre">localhost</span> <span class="pre">1079</span></code> will connect to
the local host on port 1079, where a finger server will eventually be
listening.</p>
<div class="section" id="the-reactor">
<h3>The Reactor<a class="headerlink" href="#the-reactor" title="Permalink to this heading">¶</a></h3>
<p>You don’t call Twisted, Twisted calls you. The <code class="xref py py-mod docutils literal notranslate"><span class="pre">reactor</span></code> is Twisted’s main event loop, similar to
the main loop in other toolkits available in Python (Qt, wx, and Gtk). There is
exactly one reactor in any running Twisted application. Once started it loops
over and over again, responding to network events and making scheduled calls to
code.</p>
<p>Note that there are actually several different reactors to choose
from; <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">twisted.internet</span> <span class="pre">import</span> <span class="pre">reactor</span></code> returns the
current reactor.  If you haven’t chosen a reactor class yet, it
automatically chooses the default.  See
the <a class="reference internal" href="../reactor-basics.html"><span class="doc">Reactor Basics HOWTO</span></a> for
more information.</p>
</div>
</div>
<div class="section" id="do-nothing">
<h2>Do Nothing<a class="headerlink" href="#do-nothing" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/c6b39d4b9ca624481a778f37e498c81c/finger02.py"><code class="xref download docutils literal notranslate"><span class="pre">finger02.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we use <code class="docutils literal notranslate"><span class="pre">endpoints.serverFromString</span></code> to create a Twisted endpoint. An
endpoint is a Twisted concept that encapsulates one end of a connection. There
are different endpoints for clients and servers. One of the great advantages of
endpoints is that they can be described textually using a kind of
domain-specific language. For example, here, we ask Twisted to create a TCP
endpoint for a server using the string <code class="docutils literal notranslate"><span class="pre">&quot;tcp:1079&quot;</span></code>. That, along with the
call to <code class="docutils literal notranslate"><span class="pre">serverFromString</span></code>, tells Twisted to look for a TCP endpoint, and
pass it the port 1079. The endpoint returned from that function can then have
the <code class="docutils literal notranslate"><span class="pre">listen()</span></code> method invoked on it, which causes Twisted to start listening
on port 1079. (The number 1079 is a reminder that eventually we want to run on
port 79, the standard port for finger servers.) For more detail on endpoints,
check out the <a class="reference internal" href="../endpoints.html"><span class="doc">Getting Connected With Endpoints</span></a>.</p>
<p>The factory given to the <code class="docutils literal notranslate"><span class="pre">listen()</span></code> method, <code class="docutils literal notranslate"><span class="pre">FingerFactory</span></code> , is used to
handle incoming requests on that port.  Specifically, for each request, the
reactor calls the factory’s <code class="docutils literal notranslate"><span class="pre">buildProtocol</span></code> method, which in this
case causes <code class="docutils literal notranslate"><span class="pre">FingerProtocol</span></code> to be instantiated. Since the protocol
defined here does not actually respond to any events, connections to 1079 will
be accepted, but the input ignored.</p>
<p>A Factory is the proper place for data that you want to make available to
the protocol instances, since the protocol instances are garbage collected when
the connection is closed.</p>
</div>
<div class="section" id="drop-connections">
<h2>Drop Connections<a class="headerlink" href="#drop-connections" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/b07354e5e74ac30d2d6235729de7c664/finger03.py"><code class="xref download docutils literal notranslate"><span class="pre">finger03.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we add to the protocol the ability to respond to the event of beginning
a connection — by terminating it.  Perhaps not an interesting behavior,
but it is already close to behaving according to the letter of the standard
finger protocol. After all, there is no requirement to send any data to the
remote connection in the standard.  The only problem, as far as the standard is
concerned, is that we terminate the connection too soon. A client which is slow
enough will see his <code class="docutils literal notranslate"><span class="pre">send()</span></code> of the username result in an error.</p>
</div>
<div class="section" id="read-username-drop-connections">
<h2>Read Username, Drop Connections<a class="headerlink" href="#read-username-drop-connections" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/190955a9e55d79f0206f88ce81bae901/finger04.py"><code class="xref download docutils literal notranslate"><span class="pre">finger04.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we make <code class="docutils literal notranslate"><span class="pre">FingerProtocol</span></code> inherit from <code class="xref py py-class docutils literal notranslate"><span class="pre">LineReceiver</span></code> , so that we get data-based
events on a line-by-line basis. We respond to the event of receiving the line
with shutting down the connection.</p>
<p>If you use a telnet client to interact with this server, the result will
look something like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>telnet localhost <span class="m">1079</span>
<span class="go">Trying 127.0.0.1...</span>
<span class="go">Connected to localhost.localdomain.</span>
<span class="go">alice</span>
<span class="go">Connection closed by foreign host.</span>
</pre></div>
</div>
<p>Congratulations, this is the first standard-compliant version of the code.
However, usually people actually expect some data about users to be
transmitted.</p>
</div>
<div class="section" id="read-username-output-error-drop-connections">
<h2>Read Username, Output Error, Drop Connections<a class="headerlink" href="#read-username-output-error-drop-connections" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/fcb0155db47c286821265f0cdf621bd1/finger05.py"><code class="xref download docutils literal notranslate"><span class="pre">finger05.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;No such user</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, a useful version. Granted, the usefulness is somewhat limited by
the fact that this version only prints out a “No such user” message. It
could be used for devastating effect in honey-pots (decoy servers), of
course.</p>
</div>
<div class="section" id="output-from-empty-factory">
<h2>Output From Empty Factory<a class="headerlink" href="#output-from-empty-factory" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/9f7a6250fc053c0bac483045c2c1cc45/finger06.py"><code class="xref download docutils literal notranslate"><span class="pre">finger06.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from empty factory, drop connections</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The same behavior, but finally we see what usefulness the
factory has: as something that does not get constructed for
every connection, it can be in charge of the user database.
In particular, we won’t have to change the protocol if
the user database back-end changes.</p>
</div>
<div class="section" id="output-from-non-empty-factory">
<h2>Output from Non-empty Factory<a class="headerlink" href="#output-from-non-empty-factory" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/4578da9973d0dd71ebfd91689fd56950/finger07.py"><code class="xref download docutils literal notranslate"><span class="pre">finger07.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from non-empty factory, drop connections</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">)</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">({</span><span class="sa">b</span><span class="s2">&quot;moshez&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;Happy and well&quot;</span><span class="p">}))</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, a really useful finger database. While it does not
supply information about logged in users, it could be used to
distribute things like office locations and internal office
numbers. As hinted above, the factory is in charge of keeping
the user database: note that the protocol instance has not
changed. This is starting to look good: we really won’t have
to keep tweaking our protocol.</p>
</div>
<div class="section" id="use-deferreds">
<h2>Use Deferreds<a class="headerlink" href="#use-deferreds" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/a8d79a8bedf7a12e85632170a7216dba/finger08.py"><code class="xref download docutils literal notranslate"><span class="pre">finger08.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from non-empty factory, drop connections</span>
<span class="c1"># Use deferreds, to minimize synchronicity assumptions</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">({</span><span class="sa">b</span><span class="s2">&quot;moshez&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;Happy and well&quot;</span><span class="p">}))</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>But, here we tweak it just for the hell of it. Yes, while the
previous version worked, it did assume the result of getUser is
always immediately available. But what if instead of an in-memory
database, we would have to fetch the result from a remote Oracle server?  By
allowing getUser to return a Deferred, we make it easier for the data to be
retrieved asynchronously so that the CPU can be used for other tasks in the
meanwhile.</p>
<p>As described in the <a class="reference internal" href="../defer.html"><span class="doc">Deferred HOWTO</span></a> , Deferreds
allow a program to be driven by events.  For instance, if one task in a program
is waiting on data, rather than have the CPU (and the program!) idly waiting
for that data (a process normally called ‘blocking’), the program can perform
other operations in the meantime, and waits for some signal that data is ready
to be processed before returning to that process.</p>
<p>In brief, the code in <code class="docutils literal notranslate"><span class="pre">FingerFactory</span></code> above creates a
Deferred, to which we start to attach <em>callbacks</em> .  The
deferred action in <code class="docutils literal notranslate"><span class="pre">FingerFactory</span></code> is actually a
fast-running expression consisting of one dictionary
method, <code class="docutils literal notranslate"><span class="pre">get</span></code> . Since this action can execute without
delay, <code class="docutils literal notranslate"><span class="pre">FingerFactory.getUser</span></code>
uses <code class="docutils literal notranslate"><span class="pre">defer.succeed</span></code> to create a Deferred which already has
a result, meaning its return value will be passed immediately to the
first callback function, which turns out to
be <code class="docutils literal notranslate"><span class="pre">FingerProtocol.writeResponse</span></code> .  We’ve also defined
an <em>errback</em> (appropriately
named <code class="docutils literal notranslate"><span class="pre">FingerProtocol.onError</span></code> ) that will be called instead
of <code class="docutils literal notranslate"><span class="pre">writeResponse</span></code> if something goes wrong.</p>
</div>
<div class="section" id="run-finger-locally">
<h2>Run ‘finger’ Locally<a class="headerlink" href="#run-finger-locally" title="Permalink to this heading">¶</a></h2>
<p><a class="reference download internal" download="" href="../../../_downloads/6cb4be30d7148099711d7949f136bfbe/finger09.py"><code class="xref download docutils literal notranslate"><span class="pre">finger09.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from factory interfacing to OS, drop connections</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">getProcessOutput</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">user</span><span class="p">])</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">())</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>This example also makes use of a
Deferred. <code class="docutils literal notranslate"><span class="pre">twisted.internet.utils.getProcessOutput</span></code> is a
non-blocking version of Python’s <code class="docutils literal notranslate"><span class="pre">commands.getoutput</span></code> : it
runs a shell command (<code class="docutils literal notranslate"><span class="pre">finger</span></code> , in this case) and captures
its standard output.  However, <code class="docutils literal notranslate"><span class="pre">getProcessOutput</span></code> returns a
Deferred instead of the output itself.
Since <code class="docutils literal notranslate"><span class="pre">FingerProtocol.lineReceived</span></code> is already expecting a
Deferred to be returned by <code class="docutils literal notranslate"><span class="pre">getUser</span></code> , it doesn’t need to be
changed, and it returns the standard output as the finger result.</p>
<p>Note that in this case the shell’s built-in <code class="docutils literal notranslate"><span class="pre">finger</span></code> command is
simply run with whatever arguments it is given. This is probably insecure, so
you probably don’t want a real server to do this without a lot more validation
of the user input. This will do exactly what the standard version of the finger
server does.</p>
</div>
<div class="section" id="read-status-from-the-web">
<h2>Read Status from the Web<a class="headerlink" href="#read-status-from-the-web" title="Permalink to this heading">¶</a></h2>
<p>The web. That invention which has infiltrated homes around the
world finally gets through to our invention. In this case we use the
built-in Twisted web client
via <code class="docutils literal notranslate"><span class="pre">twisted.web.client.getPage</span></code> , a non-blocking version of
Python’s <code class="xref py py-func docutils literal notranslate"><span class="pre">urllib2.urlopen(URL).read</span></code> .
Like <code class="docutils literal notranslate"><span class="pre">getProcessOutput</span></code> it returns a Deferred which will be
called back with a string, and can thus be used as a drop-in
replacement.</p>
<p>Thus, we have examples of three different database back-ends, none of which
change the protocol class. In fact, we will not have to change the protocol
again until the end of this tutorial: we have achieved, here, one truly usable
class.</p>
<p><a class="reference download internal" download="" href="../../../_downloads/fbae90c032c9bccab07dc7215ff89b2c/finger10.py"><code class="xref download docutils literal notranslate"><span class="pre">finger10.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from factory interfacing to web, drop connections</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">endpoints</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">client</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">getPage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">user</span><span class="p">)</span>


<span class="n">fingerEndpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">serverFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:1079&quot;</span><span class="p">)</span>
<span class="n">fingerEndpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">FingerFactory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;http://livejournal.com/~&quot;</span><span class="p">))</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="use-application">
<h2>Use Application<a class="headerlink" href="#use-application" title="Permalink to this heading">¶</a></h2>
<p>Up until now, we faked. We kept using port 1079, because really, who wants to
run a finger server with root privileges? Well, the common solution
is “privilege shedding” : after binding to the network, become a different,
less privileged user. We could have done it ourselves, but Twisted has a
built-in way to do it. We will create a snippet as above, but now we will define
an application object. That object will have <code class="docutils literal notranslate"><span class="pre">uid</span></code>
and <code class="docutils literal notranslate"><span class="pre">gid</span></code> attributes. When running it (later we will see how) it will
bind to ports, shed privileges and then run.</p>
<p>Read on to find out how to run this code using the twistd utility.</p>
</div>
<div class="section" id="twistd">
<h2>twistd<a class="headerlink" href="#twistd" title="Permalink to this heading">¶</a></h2>
<p>This is how to run “Twisted Applications” — files which define an
‘application’. A daemon is expected to adhere to certain behavioral standards
so that standard tools can stop/start/query them.  If a Twisted application is
run via twistd, the TWISTed Daemonizer, all this behavioral stuff will be
handled for you. twistd does everything a daemon can be expected to —
shuts down stdin/stdout/stderr, disconnects from the terminal and can even
change runtime directory, or even the root filesystems. In short, it does
everything so the Twisted application developer can concentrate on writing his
networking code.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">root% twistd -ny finger11.tac # just like before</span>
<span class="go">root% twistd -y finger11.tac # daemonize, keep pid in twistd.pid</span>
<span class="go">root% twistd -y finger11.tac --pidfile=finger.pid</span>
<span class="go">root% twistd -y finger11.tac --rundir=/</span>
<span class="go">root% twistd -y finger11.tac --chroot=/var</span>
<span class="go">root% twistd -y finger11.tac -l /var/log/finger.log</span>
<span class="go">root% twistd -y finger11.tac --syslog # just log to syslog</span>
<span class="go">root% twistd -y finger11.tac --syslog --prefix=twistedfinger # use given prefix</span>
</pre></div>
</div>
<p>There are several ways to tell twistd where your application is; here we
show how it is done using the <code class="docutils literal notranslate"><span class="pre">application</span></code> global variable in a
Python source file (a <a class="reference internal" href="../glossary.html#core-howto-glossary-tac"><span class="std std-ref">Twisted Application
Configuration</span></a> file).</p>
<p><a class="reference download internal" download="" href="../../../_downloads/27a060e475a92d170fdfdb5c8f45d04d/finger11.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger11.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read username, output from non-empty factory, drop connections</span>
<span class="c1"># Use deferreds, to minimize synchronicity assumptions</span>
<span class="c1"># Write application. Save in &#39;finger.tpy&#39;</span>

<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">FingerFactory</span><span class="p">({</span><span class="sa">b</span><span class="s2">&quot;moshez&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;Happy and well&quot;</span><span class="p">})</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">reactor</span><span class="o">=</span><span class="n">reactor</span><span class="p">)</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span>
    <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Instead of using <code class="docutils literal notranslate"><span class="pre">endpoints.serverFromString</span></code> as in the above
examples, here we are using its application-aware
counterpart, <code class="docutils literal notranslate"><span class="pre">strports.service</span></code> .  Notice that when it is
instantiated, the application object itself does not reference either
the protocol or the factory.  Any services (such as the one we created with
<code class="docutils literal notranslate"><span class="pre">strports.service</span></code>) which have the application as their parent will be
started when the application is started by twistd.  The application object is
more useful for returning an object that supports the
<code class="xref py py-class docutils literal notranslate"><span class="pre">IService</span></code> , <code class="xref py py-class docutils literal notranslate"><span class="pre">IServiceCollection</span></code> , <code class="xref py py-class docutils literal notranslate"><span class="pre">IProcess</span></code> ,
and <code class="xref py py-class docutils literal notranslate"><span class="pre">sob.IPersistable</span></code>
interfaces with the given parameters; we’ll be seeing these in the
next part of the tutorial. As the parent of the endpoint we opened, the
application lets us manage the endpoint.</p>
<p>With the daemon running on the standard finger port, you can test it with
the standard finger command: <code class="docutils literal notranslate"><span class="pre">finger</span> <span class="pre">moshez</span></code> .</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="protocol.html" class="btn btn-neutral float-right" title="The Evolution of Finger: adding features to the finger service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Twisted from Scratch, or The Evolution of Finger" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>