

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Interrupted Responses &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Logging Errors" href="logging-errors.html" />
    <link rel="prev" title="Asynchronous Responses (via Deferred)" href="asynchronous-deferred.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Twisted Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Twisted Web</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../web-overview.html">Overview of Twisted Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="../using-twistedweb.html">Configuring and Using the Twisted Web Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web-development.html">Web Application Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../twisted-templates.html">HTML Templating with twisted.web.template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xmlrpc.html">Creating XML-RPC Servers and Clients with Twisted</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Twisted Web In 60 Seconds</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="static-content.html">Serving Static Content From a Directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-content.html">Generating a Page Dynamically</a></li>
<li class="toctree-l4"><a class="reference internal" href="static-dispatch.html">Static URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-dispatch.html">Dynamic URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom-codes.html">Custom Response Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="handling-posts.html">Handling POSTs</a></li>
<li class="toctree-l4"><a class="reference internal" href="other-request-bodies.html">Other Request Bodies</a></li>
<li class="toctree-l4"><a class="reference internal" href="rpy-scripts.html">rpy scripts (or, how to save yourself some typing)</a></li>
<li class="toctree-l4"><a class="reference internal" href="asynchronous.html">Asynchronous Responses</a></li>
<li class="toctree-l4"><a class="reference internal" href="asynchronous-deferred.html">Asynchronous Responses (via Deferred)</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Interrupted Responses</a></li>
<li class="toctree-l4"><a class="reference internal" href="logging-errors.html">Logging Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="access-logging.html">Access Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="wsgi.html">WSGI</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-auth.html">HTTP Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-basics.html">Session Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-store.html">Storing Objects in the Session</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-endings.html">Session Endings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../resource-templates.html">Light Weight Templating With Resource Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client.html">Using the Twisted Web Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Twisted Web</a> &raquo;</li>
        
          <li><a href="../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="index.html">Twisted Web In 60 Seconds</a> &raquo;</li>
        
      <li>Interrupted Responses</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/web/howto/web-in-60/interrupted.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interrupted-responses">
<h1>Interrupted Responses<a class="headerlink" href="#interrupted-responses" title="Permalink to this heading">¶</a></h1>
<p>The previous example had a Resource that generates its response
asynchronously rather than immediately upon the call to its render method. When
generating responses asynchronously, the possibility is introduced that the
connection to the client may be lost before the response is generated. In such a
case, it is often desirable to abandon the response generation entirely, since
there is nothing to do with the data once it is produced. This example shows how
to be notified that the connection has been lost.</p>
<p>This example will build upon the <a class="reference internal" href="asynchronous.html"><span class="doc">asynchronous responses example</span></a> which simply (if not very realistically) generated its
response after a fixed delay. We will expand that resource so that as soon as
the client connection is lost, the delayed event is cancelled and the response
is never generated.</p>
<p>The feature this example relies on is provided by another <code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code> method: <code class="xref py py-meth docutils literal notranslate"><span class="pre">notifyFinish</span></code> . This method returns a new
Deferred which will fire with <code class="docutils literal notranslate"><span class="pre">None</span></code> if the request is successfully
responded to or with an error otherwise - for example if the connection is lost
before the response is sent.</p>
<p>The example starts in a familiar way, with the requisite Twisted imports and
a resource class with the same <code class="docutils literal notranslate"><span class="pre">_delayedRender</span></code> used previously:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
<p>Before defining the render method, we’re going to define an errback
(an errback being a callback that gets called when there’s an error),
though. This will be the errback attached to the <code class="docutils literal notranslate"><span class="pre">Deferred</span></code>
returned by <code class="docutils literal notranslate"><span class="pre">Request.notifyFinish</span></code> . It will cancel the
delayed call to <code class="docutils literal notranslate"><span class="pre">_delayedRender</span></code> .</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">_responseFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, the render method will set up the delayed call just as it
did before, and return <code class="docutils literal notranslate"><span class="pre">NOT_DONE_YET</span></code> likewise. However, it
will also use <code class="docutils literal notranslate"><span class="pre">Request.notifyFinish</span></code> to make
sure <code class="docutils literal notranslate"><span class="pre">_responseFailed</span></code> is called if appropriate.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_responseFailed</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>
</pre></div>
</div>
<p>Notice that since <code class="docutils literal notranslate"><span class="pre">_responseFailed</span></code> needs a reference to
the delayed call object in order to cancel it, we passed that object
to <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> . Any additional arguments passed
to <code class="docutils literal notranslate"><span class="pre">addErrback</span></code> (or <code class="docutils literal notranslate"><span class="pre">addCallback</span></code> ) will be
passed along to the errback after the <code class="xref py py-class docutils literal notranslate"><span class="pre">Failure</span></code> instance which is always
passed as the first argument. Passing <code class="docutils literal notranslate"><span class="pre">call</span></code> here means it
will be passed to <code class="docutils literal notranslate"><span class="pre">_responseFailed</span></code> , where it is expected
and required.</p>
<p>That covers almost all the code for this example. Here’s the entire example
without interruptions, as an <a class="reference internal" href="rpy-scripts.html"><span class="doc">rpy script</span></a> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">NOT_DONE_YET</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="k">class</span> <span class="nc">DelayedResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_delayedRender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;Sorry to keep you waiting.&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_responseFailed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
        <span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delayedRender</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">notifyFinish</span><span class="p">()</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_responseFailed</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NOT_DONE_YET</span>

<span class="n">resource</span> <span class="o">=</span> <span class="n">DelayedResource</span><span class="p">()</span>
</pre></div>
</div>
<p>Toss this into <code class="docutils literal notranslate"><span class="pre">example.rpy</span></code> , fire it up with <code class="docutils literal notranslate"><span class="pre">twistd</span> <span class="pre">-n</span> <span class="pre">web</span> <span class="pre">--path</span> <span class="pre">.</span></code> , and
hit <a class="reference external" href="http://localhost:8080/example.rpy">http://localhost:8080/example.rpy</a> . If
you wait five seconds, you’ll get the page content. If you interrupt the request
before then, say by hitting escape (in Firefox, at least), then you’ll see
perhaps the most boring demonstration ever - no page content, and nothing in the
server logs. Success!</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="logging-errors.html" class="btn btn-neutral float-right" title="Logging Errors" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="asynchronous-deferred.html" class="btn btn-neutral float-left" title="Asynchronous Responses (via Deferred)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>