

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Writing a client with Twisted Conch &mdash; Twisted 22.4.0.post0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Examples" href="../examples/index.html" />
    <link rel="prev" title="Developer Guides" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Twisted
          

          
          </a>

          
            
            
              <div class="version">
                22.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core/index.html">Twisted Core</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Twisted Conch (SSH and Telnet)</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing a client with Twisted Conch</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-an-ssh-command-endpoint">Using an SSH Command Endpoint</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-client">Writing a client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-transport">The Transport</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-authorization-client">The Authorization Client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-connection">The Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-channel">The Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-main-function">The main() function</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Twisted Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Twisted</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Twisted Conch (SSH and Telnet)</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Writing a client with Twisted Conch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/conch/howto/conch_client.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-client-with-twisted-conch">
<h1>Writing a client with Twisted Conch<a class="headerlink" href="#writing-a-client-with-twisted-conch" title="Permalink to this heading">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>In the original days of computing, rsh/rlogin were used to connect to
remote computers and execute commands. These commands had the problem
that the passwords and commands were sent in the clear. To solve this
problem, the SSH protocol was created. Twisted Conch implements the
second version of this protocol.</p>
</div>
<div class="section" id="using-an-ssh-command-endpoint">
<h2>Using an SSH Command Endpoint<a class="headerlink" href="#using-an-ssh-command-endpoint" title="Permalink to this heading">¶</a></h2>
<p>If your objective is to execute a command on a remote host over an SSH
connection, then the easiest approach may be to
use <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.conch.endpoints.SSHCommandClientEndpoint</span></code> .
If you haven’t used endpoints before, first take a look
at <a class="reference internal" href="../../core/howto/endpoints.html"><span class="doc">the endpoint howto</span></a> to
get an idea of how endpoints work in general.</p>
<p>Conch provides an endpoint implementation which establishes an SSH
connection, performs necessary authentication, opens a channel, and
launches a command in that channel.  It then associates the output of that
command with the input of a protocol you supply, and associates output
from that protocol with the input of that command.  Effectively,
this lets you ignore most of the complexity of SSH and just interact with
a remote process as though it were any other stream-oriented connection -
such as TCP or SSL.</p>
<p>Conch also provides an endpoint that is initialized with an already
established SSH connection.  This endpoint just opens a new channel on the
existing connection and launches a command in that.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint</span></code> is about as simple as using any
other stream-oriented client endpoint.  Just create the endpoint defining
where the SSH server to connect to is and a factory defining what kind of
protocol to use to interact with the command and let them get to work
using the endpoint’s <code class="docutils literal notranslate"><span class="pre">connect</span></code> method.</p>
<p><a class="reference download internal" download="" href="../../_downloads/bd138273554e9ffe590acabd773b6136/echoclient_ssh.py"><code class="xref download docutils literal notranslate"><span class="pre">echoclient_ssh.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="c1"># See LICENSE for details.</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="kn">import</span> <span class="nn">echoclient_ssh</span>

    <span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">react</span>

    <span class="n">react</span><span class="p">(</span><span class="n">echoclient_ssh</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">twisted.conch.client.knownhosts</span> <span class="kn">import</span> <span class="n">KnownHostsFile</span>
<span class="kn">from</span> <span class="nn">twisted.conch.endpoints</span> <span class="kn">import</span> <span class="n">SSHCommandClientEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.conch.ssh.keys</span> <span class="kn">import</span> <span class="n">EncryptedKeyError</span><span class="p">,</span> <span class="n">Key</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">UNIXClientEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span><span class="p">,</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">twisted.python.filepath</span> <span class="kn">import</span> <span class="n">FilePath</span>
<span class="kn">from</span> <span class="nn">twisted.python.usage</span> <span class="kn">import</span> <span class="n">Options</span>


<span class="k">class</span> <span class="nc">EchoOptions</span><span class="p">(</span><span class="n">Options</span><span class="p">):</span>
    <span class="n">optParameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;hostname of the SSH server to which to connect&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;port number of SSH server to which to connect&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;username&quot;</span><span class="p">,</span>
            <span class="s2">&quot;u&quot;</span><span class="p">,</span>
            <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
            <span class="s2">&quot;username with which to authenticate with the SSH server&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;identity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;file from which to read a private key to use for authentication&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;password to use for authentication&quot;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;knownhosts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="s2">&quot;~/.ssh/known_hosts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file containing known ssh server public key data&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="n">optFlags</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;no-agent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Disable use of key agent&quot;</span><span class="p">],</span>
    <span class="p">]</span>


<span class="k">class</span> <span class="nc">NoiseProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bif&quot;</span><span class="p">,</span> <span class="s2">&quot;pow&quot;</span><span class="p">,</span> <span class="s2">&quot;zot&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendNoise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sendNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Server says:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendNoise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">readKey</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Key</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EncryptedKeyError</span><span class="p">:</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s2"> keyphrase: &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Key</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ConnectionParameters</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">knownHosts</span><span class="p">,</span> <span class="n">agent</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="n">reactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knownHosts</span> <span class="o">=</span> <span class="n">knownHosts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromCommandLine</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">argv</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">EchoOptions</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">parseOptions</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">]:</span>
            <span class="n">keyPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">keyPath</span><span class="p">):</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">readKey</span><span class="p">(</span><span class="n">keyPath</span><span class="p">))</span>

        <span class="n">knownHostsPath</span> <span class="o">=</span> <span class="n">FilePath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;knownhosts&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">knownHostsPath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">knownHosts</span> <span class="o">=</span> <span class="n">KnownHostsFile</span><span class="o">.</span><span class="n">fromPath</span><span class="p">(</span><span class="n">knownHostsPath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">knownHosts</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;no-agent&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;SSH_AUTH_SOCK&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">agentEndpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agentEndpoint</span> <span class="o">=</span> <span class="n">UNIXClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SSH_AUTH_SOCK&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">reactor</span><span class="p">,</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
            <span class="n">keys</span><span class="p">,</span>
            <span class="n">knownHosts</span><span class="p">,</span>
            <span class="n">agentEndpoint</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">endpointForCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SSHCommandClientEndpoint</span><span class="o">.</span><span class="n">newConnection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="p">,</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
            <span class="n">agentEndpoint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span>
            <span class="n">knownHosts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">knownHosts</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">ConnectionParameters</span><span class="o">.</span><span class="n">fromCommandLine</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">endpointForCommand</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;/bin/cat&quot;</span><span class="p">)</span>

    <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">NoiseProtocol</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">proto</span><span class="p">:</span> <span class="n">proto</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>For completeness, this example includes a lot of code to support different
styles of authentication, reading (and possibly updating) existing
<em>known_hosts</em> files, and parsing command line options.  Focus on
the latter half of the <code class="docutils literal notranslate"><span class="pre">main</span></code> function to see the code that is
most directly responsible for actually doing the necessary SSH connection
setup.  <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint</span></code> accepts quite a few options, since
there is a lot of flexibility in SSH and many possible different server
configurations, but once the endpoint object itself is created, its use is
no more complicated than the use of any other endpoint: pass a factory to
its <code class="docutils literal notranslate"><span class="pre">connect</span></code> method and attach a callback to the
resulting <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> to do something with the protocol
instance. If you use an endpoint that creates new connections, the connection
attempt can be cancelled by calling <code class="docutils literal notranslate"><span class="pre">cancel()</span></code> on this
<code class="docutils literal notranslate"><span class="pre">Deferred</span></code> .</p>
<p>In this case, the connected protocol instance is only used to make the
example wait until the client has finished talking to the server, which
happens after the small amount of example data has been sent to the server
and bounced back by the <code class="docutils literal notranslate"><span class="pre">/bin/cat</span></code> process the
protocol is interacting with.</p>
<p>Several of the options accepted by <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint.newConnection</span></code> should be easy to understand.
The endpoint takes a reactor which it uses to do any and all I/O it needs to do.
It also takes a command which it executes on the remote server once the SSH connection is established and authenticated; this command is a single string, perhaps including spaces or other special shell symbols, and is interpreted by a shell on the server.
It takes a username with which it identifies itself to the server for authentication purposes.
It takes an optional password argument which will also be used for authentication - if the server supports password authentication (prefer keys instead where possible, see below).
It takes a host (either a name or an IP address) and a port number, defining where to connect.</p>
<p>Some of the other options may bear further explanation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">keys</span></code> argument gives any SSH <code class="xref py py-class docutils literal notranslate"><span class="pre">Key</span></code> objects which may be useful for authentication.
These keys are available to the endpoint for authentication, but only keys that the server indicates are useful will actually be used.
This argument is optional.
If key authentication against the server is either unnecessary or undesired, it may be omitted entirely.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">agentEndpoint</span></code> argument gives the <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint</span></code> an opportunity to connect to an SSH authentication agent.
The agent may already be loaded with keys, or may have some other way to authenticate a connection.
Using the agent can mean the process actually establishing the SSH connection doesn’t need to load any authentication material (passwords or keys) itself (often convenient in case keys are encrypted and potentially more secure, since only the agent process ever actually holds the secrets).
The value for this argument is another <code class="docutils literal notranslate"><span class="pre">IStreamClientEndpoint</span></code> .
Often in a typical <em>NIX desktop environment, the *SSH_AUTH_SOCK</em> environment variable will give the location of an AF_UNIX socket.
This explains the value <code class="docutils literal notranslate"><span class="pre">echoclient_ssh.py</span></code> assigns this parameter when <em>–no-agent</em> is not given.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">knownHosts</span></code> argument accepts a <code class="xref py py-class docutils literal notranslate"><span class="pre">KnownHostsFile</span></code> instance and controls how server keys are checked and stored.
This object has the opportunity to reject server keys if they differ from expectations.
It can also save server keys when they are first observed.</p>
<p>Finally, there is one option that is not demonstrated in the example - the <code class="docutils literal notranslate"><span class="pre">ui</span></code> argument.
This argument is closely related to the <code class="docutils literal notranslate"><span class="pre">knownHosts</span></code> argument described above.
<code class="docutils literal notranslate"><span class="pre">KnownHostsFile</span></code> may require user-input under certain circumstances - for example, to ask if it should accept a server key the first time it is observed.
The <code class="docutils literal notranslate"><span class="pre">ui</span></code> object is how this user-input is obtained.
By default, a <code class="xref py py-class docutils literal notranslate"><span class="pre">ConsoleUI</span></code> instance associated with <em>/dev/tty</em> will be used.
This gives about the same behavior as is seen in a standard command-line ssh client.
See <code class="xref py py-meth docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint.newConnection</span></code> for details about how edge cases are handled for this default value.
For use of <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint</span></code> that is intended to be completely autonomous, applications will probably want to specify a custom <code class="docutils literal notranslate"><span class="pre">ui</span></code> object which can make the necessary decisions without user-input.</p>
<p>It is also possible to run commands (one or more) over an
already-established connection.  This is done using the alternate
constructor <code class="docutils literal notranslate"><span class="pre">SSHCommandClientEndpoint.existingConnection</span></code> .  The
<code class="docutils literal notranslate"><span class="pre">connection</span></code> argument to that function can be obtained by accessing
<code class="docutils literal notranslate"><span class="pre">transport.conn</span></code> on an already connected protocol.</p>
<p><a class="reference download internal" download="" href="../../_downloads/db301810ed9e551127dc12fda8181b36/echoclient_shared_ssh.py"><code class="xref download docutils literal notranslate"><span class="pre">echoclient_shared_ssh.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright (c) Twisted Matrix Laboratories.</span>
<span class="c1"># See LICENSE for details.</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="kn">import</span> <span class="nn">echoclient_shared_ssh</span>

    <span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">react</span>

    <span class="n">react</span><span class="p">(</span><span class="n">echoclient_shared_ssh</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="kn">from</span> <span class="nn">echoclient_ssh</span> <span class="kn">import</span> <span class="n">ConnectionParameters</span>

<span class="kn">from</span> <span class="nn">twisted.conch.endpoints</span> <span class="kn">import</span> <span class="n">SSHCommandClientEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span><span class="p">,</span> <span class="n">gatherResults</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span><span class="p">,</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">twisted.internet.task</span> <span class="kn">import</span> <span class="n">cooperate</span>


<span class="k">class</span> <span class="nc">PrinterProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got some data:&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lost my connection&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">ConnectionParameters</span><span class="o">.</span><span class="n">fromCommandLine</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">endpointForCommand</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;/bin/cat&quot;</span><span class="p">)</span>

    <span class="n">done</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">Protocol</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gotConnection</span><span class="p">(</span><span class="n">proto</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">proto</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">conn</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
            <span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">PrinterProtocol</span>
            <span class="n">factory</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
            <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

            <span class="n">e</span> <span class="o">=</span> <span class="n">SSHCommandClientEndpoint</span><span class="o">.</span><span class="n">existingConnection</span><span class="p">(</span>
                <span class="n">conn</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;/bin/echo </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">gotConnection</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">work</span><span class="p">:</span> <span class="n">cooperate</span><span class="p">(</span><span class="n">work</span><span class="p">)</span><span class="o">.</span><span class="n">whenDone</span><span class="p">())</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ignored</span><span class="p">:</span> <span class="n">gatherResults</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-a-client">
<h2>Writing a client<a class="headerlink" href="#writing-a-client" title="Permalink to this heading">¶</a></h2>
<p>In case the endpoint is missing some necessary functionality, or in case you
want to interact with a different part of an SSH server - such as one of
its <em>subsystems</em> (for example, SFTP), you may need to use the
lower-level Conch client interface.  This is described below.</p>
<p>Writing a client with Conch involves sub-classing 4 classes: <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.conch.ssh.transport.SSHClientTransport</span></code> , <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.conch.ssh.userauth.SSHUserAuthClient</span></code> , <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.conch.ssh.connection.SSHConnection</span></code> , and <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.conch.ssh.channel.SSHChannel</span></code> . We’ll start out
with <code class="docutils literal notranslate"><span class="pre">SSHClientTransport</span></code> because it’s the base
of the client.</p>
</div>
<div class="section" id="the-transport">
<h2>The Transport<a class="headerlink" href="#the-transport" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.conch</span> <span class="kn">import</span> <span class="n">error</span>
<span class="kn">from</span> <span class="nn">twisted.conch.ssh</span> <span class="kn">import</span> <span class="n">transport</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">class</span> <span class="nc">ClientTransport</span><span class="p">(</span><span class="n">transport</span><span class="o">.</span><span class="n">SSHClientTransport</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">verifyHostKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pubKey</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fingerprint</span> <span class="o">!=</span> <span class="s1">&#39;b1:94:6a:c9:24:92:d2:34:7c:62:35:b4:d2:61:11:84&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">ConchError</span><span class="p">(</span><span class="s1">&#39;bad key&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectionSecure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestService</span><span class="p">(</span><span class="n">ClientUserAuth</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">ClientConnection</span><span class="p">()))</span>
</pre></div>
</div>
<p>See how easy it is? <code class="docutils literal notranslate"><span class="pre">SSHClientTransport</span></code>
handles the negotiation of encryption and the verification of keys
for you. The one security element that you as a client writer need to
implement is <code class="docutils literal notranslate"><span class="pre">verifyHostKey()</span></code> . This method
is called with two strings: the public key sent by the server and its
fingerprint. You should verify the host key the server sends, either
by checking against a hard-coded value as in the example, or by asking
the user. <code class="docutils literal notranslate"><span class="pre">verifyHostKey</span></code> returns a <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.defer.Deferred</span></code> which gets a callback
if the host key is valid, or an errback if it is not. Note that in the
above, replace ‘user’ with the username you’re attempting to ssh with,
for instance a call to <code class="docutils literal notranslate"><span class="pre">os.getlogin()</span></code> for the
current user.</p>
<p>The second method you need to implement is <code class="docutils literal notranslate"><span class="pre">connectionSecure()</span></code> . It is called when the
encryption is set up and other services can be run. The example requests
that the <code class="docutils literal notranslate"><span class="pre">ClientUserAuth</span></code> service be started.
This service will be discussed next.</p>
</div>
<div class="section" id="the-authorization-client">
<h2>The Authorization Client<a class="headerlink" href="#the-authorization-client" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.conch.ssh</span> <span class="kn">import</span> <span class="n">keys</span><span class="p">,</span> <span class="n">userauth</span>

<span class="c1"># these are the public/private keys from test_conch</span>

<span class="n">publicKey</span> <span class="o">=</span> <span class="s1">&#39;ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAGEArzJx8OYOnJmzf4tfBEvLi8DVPrJ3</span><span class="se">\</span>
<span class="s1">/c9k2I/Az64fxjHf9imyRJbixtQhlH9lfNjUIx+4LmrJH5QNRsFporcHDKOTwTTYLh5KmRpslkYHR</span><span class="se">\</span>
<span class="s1">ivcJSkbh/C+BR3utDS555mV&#39;</span>

<span class="n">privateKey</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;-----BEGIN RSA PRIVATE KEY-----</span>
<span class="s2">MIIByAIBAAJhAK8ycfDmDpyZs3+LXwRLy4vA1T6yd/3PZNiPwM+uH8Yx3/YpskSW</span>
<span class="s2">4sbUIZR/ZXzY1CMfuC5qyR+UDUbBaaK3Bwyjk8E02C4eSpkabJZGB0Yr3CUpG4fw</span>
<span class="s2">vgUd7rQ0ueeZlQIBIwJgbh+1VZfr7WftK5lu7MHtqE1S1vPWZQYE3+VUn8yJADyb</span>
<span class="s2">Z4fsZaCrzW9lkIqXkE3GIY+ojdhZhkO1gbG0118sIgphwSWKRxK0mvh6ERxKqIt1</span>
<span class="s2">xJEJO74EykXZV4oNJ8sjAjEA3J9r2ZghVhGN6V8DnQrTk24Td0E8hU8AcP0FVP+8</span>
<span class="s2">PQm/g/aXf2QQkQT+omdHVEJrAjEAy0pL0EBH6EVS98evDCBtQw22OZT52qXlAwZ2</span>
<span class="s2">gyTriKFVoqjeEjt3SZKKqXHSApP/AjBLpF99zcJJZRq2abgYlf9lv1chkrWqDHUu</span>
<span class="s2">DZttmYJeEfiFBBavVYIF1dOlZT0G8jMCMBc7sOSZodFnAiryP+Qg9otSBjJ3bQML</span>
<span class="s2">pSTqy7c3a2AScC/YyOwkDaICHnnD3XyjMwIxALRzl0tQEKMXs6hH8ToUdlLROCrP</span>
<span class="s2">EhQ0wahUTCk1gKA4uPD6TMTChavbh4K63OvbKg==</span>
<span class="s2">-----END RSA PRIVATE KEY-----&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ClientUserAuth</span><span class="p">(</span><span class="n">userauth</span><span class="o">.</span><span class="n">SSHUserAuthClient</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">getPassword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>
        <span class="c1"># this says we won&#39;t do password authentication</span>

    <span class="k">def</span> <span class="nf">getPublicKey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">keys</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">publicKey</span><span class="p">)</span><span class="o">.</span><span class="n">blob</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getPrivateKey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">privateKey</span><span class="p">)</span><span class="o">.</span><span class="n">keyObject</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, fairly simple. The <code class="docutils literal notranslate"><span class="pre">SSHUserAuthClient</span></code> takes care of most
of the work, but the actual authentication data needs to be
supplied. <code class="docutils literal notranslate"><span class="pre">getPassword()</span></code> asks for a
password, <code class="docutils literal notranslate"><span class="pre">getPublicKey()</span></code> and <code class="docutils literal notranslate"><span class="pre">getPrivateKey()</span></code> get public and private keys,
respectively. <code class="docutils literal notranslate"><span class="pre">getPassword()</span></code> returns
a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> that is called back with
the password to use.</p>
<p><code class="docutils literal notranslate"><span class="pre">getPublicKey()</span></code> returns the SSH key data for the public key to use.
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Key.fromString()</span></code> will take a key in OpenSSH, LSH or any supported format, as a string, and generate a new <code class="xref py py-class docutils literal notranslate"><span class="pre">Key</span></code>.
Alternatively, <code class="docutils literal notranslate"><span class="pre">keys.Key.fromFile()</span></code> can be used instead, which
will take the filename of a key in the supported format, and  and generate a new  <code class="xref py py-class docutils literal notranslate"><span class="pre">Key</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">getPrivateKey()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> which is called back with the private <code class="xref py py-class docutils literal notranslate"><span class="pre">Key</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">getPassword()</span></code> and <code class="docutils literal notranslate"><span class="pre">getPrivateKey()</span></code> return <code class="docutils literal notranslate"><span class="pre">Deferreds</span></code> because they may need to ask the user for input.</p>
<p>Once the authentication is complete, <code class="docutils literal notranslate"><span class="pre">SSHUserAuthClient</span></code> takes care of starting the <code class="docutils literal notranslate"><span class="pre">SSHConnection</span></code> object given to it. Next, we’ll
look at how to use the <code class="docutils literal notranslate"><span class="pre">SSHConnection</span></code>.</p>
</div>
<div class="section" id="the-connection">
<h2>The Connection<a class="headerlink" href="#the-connection" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.conch.ssh</span> <span class="kn">import</span> <span class="n">connection</span>

<span class="k">class</span> <span class="nc">ClientConnection</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">SSHConnection</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">serviceStarted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openChannel</span><span class="p">(</span><span class="n">CatChannel</span><span class="p">(</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SSHConnection</span></code> is the easiest,
as it’s only responsible for starting the channels. It has
other methods, those will be examined when we look at <code class="docutils literal notranslate"><span class="pre">SSHChannel</span></code> .</p>
</div>
<div class="section" id="the-channel">
<h2>The Channel<a class="headerlink" href="#the-channel" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.conch.ssh</span> <span class="kn">import</span> <span class="n">channel</span><span class="p">,</span> <span class="n">common</span>

<span class="k">class</span> <span class="nc">CatChannel</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">SSHChannel</span><span class="p">):</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;session&#39;</span>

    <span class="k">def</span> <span class="nf">channelOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">sendRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">NS</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">),</span>
                                  <span class="n">wantReply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cbSendRequest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catData</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_cbSendRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignored</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;This data will be echoed back to us by &quot;cat.&quot;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">sendEOF</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dataReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catData</span> <span class="o">+=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;We got this from &quot;cat&quot;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">catData</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that we’ve spent all this time getting the server and
client connected, here is where that work pays off. <code class="docutils literal notranslate"><span class="pre">SSHChannel</span></code> is the interface between you and the
other side. This particular channel opens a session and plays with the
‘cat’ program, but your channel can implement anything, so long as the
server supports it.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">channelOpen()</span></code> method is
where everything gets started. It gets passed a chunk of data;
however, this chunk is usually nothing and can be ignored.
Our <code class="docutils literal notranslate"><span class="pre">channelOpen()</span></code> initializes our
channel, and sends a request to the other side, using the <code class="docutils literal notranslate"><span class="pre">sendRequest()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">SSHConnection</span></code> object. Requests are used to send
events to the other side. We pass the method self so that it knows to
send the request for this channel. The 2nd argument of ‘exec’ tells the
server that we want to execute a command. The third argument is the data
that accompanies the request. <code class="xref py py-func docutils literal notranslate"><span class="pre">common.NS</span></code> encodes
the data as a length-prefixed string, which is how the server expects
the data. We also say that we want a reply saying that the process has a
been started. <code class="docutils literal notranslate"><span class="pre">sendRequest()</span></code> then returns a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> which we add a callback for.</p>
<p>Once the callback fires, we send the data. <code class="docutils literal notranslate"><span class="pre">SSHChannel</span></code> supports the <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.interfaces.ITransport</span></code>
interface, so
it can be given to Protocols to run them over the secure
connection. In our case, we just write the data directly. <code class="docutils literal notranslate"><span class="pre">sendEOF()</span></code> does not follow the interface,
but Conch uses it to tell the other side that we will write no
more data. <code class="docutils literal notranslate"><span class="pre">loseConnection()</span></code> shuts
down our side of the connection, but we will still receive data
through <code class="docutils literal notranslate"><span class="pre">dataReceived()</span></code> . The <code class="docutils literal notranslate"><span class="pre">closed()</span></code> method is called when both sides of the
connection are closed, and we use it to display the data we received
(which should be the same as the data we sent.)</p>
<p>Finally, let’s actually invoke the code we’ve set up.</p>
</div>
<div class="section" id="the-main-function">
<h2>The main() function<a class="headerlink" href="#the-main-function" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">()</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ClientTransport</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>We call <code class="docutils literal notranslate"><span class="pre">connectTCP()</span></code> to connect to
localhost, port 22 (the standard port for ssh), and pass it an instance
of <code class="xref py py-class docutils literal notranslate"><span class="pre">twisted.internet.protocol.ClientFactory</span></code> .
This instance has the attribute <code class="docutils literal notranslate"><span class="pre">protocol</span></code>
set to our earlier <code class="docutils literal notranslate"><span class="pre">ClientTransport</span></code>
class. Note that the protocol attribute is set to the class <code class="docutils literal notranslate"><span class="pre">ClientTransport</span></code> , not an instance of <code class="docutils literal notranslate"><span class="pre">ClientTransport</span></code> ! When the <code class="docutils literal notranslate"><span class="pre">connectTCP</span></code> call completes, the protocol will be
called to create a <code class="docutils literal notranslate"><span class="pre">ClientTransport()</span></code> object
- this then invokes all our previous work.</p>
<p>It’s worth noting that in the example <code class="docutils literal notranslate"><span class="pre">main()</span></code>
routine, the <code class="docutils literal notranslate"><span class="pre">reactor.run()</span></code> call never returns.
If you want to make the program exit, call <code class="docutils literal notranslate"><span class="pre">reactor.stop()</span></code> in the earlier <code class="docutils literal notranslate"><span class="pre">closed()</span></code> method.</p>
<p>If you wish to observe the interactions in more detail, adding a call
to <code class="docutils literal notranslate"><span class="pre">log.startLogging(sys.stdout,</span> <span class="pre">setStdout=0)</span></code>
before the <code class="docutils literal notranslate"><span class="pre">reactor.run()</span></code> call will send all
logging to stdout.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../examples/index.html" class="btn btn-neutral float-right" title="Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Developer Guides" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Twisted Matrix Labs. Ver 22.4.0.post0. Built on 2022-09-04.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>