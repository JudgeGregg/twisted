<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Session Endings &mdash; Twisted 22.8.0.post0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/js/custom.js"></script>
        <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" defer hack=""></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Light Weight Templating With Resource Templates" href="../resource-templates.html" />
    <link rel="prev" title="Storing Objects in the Session" href="session-store.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Twisted
          </a>
              <div class="version">
                22.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installing Twisted</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/index.html">Twisted Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../conch/index.html">Twisted Conch (SSH and Telnet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mail/index.html">Twisted Mail (SMTP, POP, and IMAP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../names/index.html">Twisted Names (DNS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pair/index.html">Twisted Pair</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Twisted Web</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../web-overview.html">Overview of Twisted Web</a></li>
<li class="toctree-l3"><a class="reference internal" href="../using-twistedweb.html">Configuring and Using the Twisted Web Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web-development.html">Web Application Development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../twisted-templates.html">HTML Templating with twisted.web.template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xmlrpc.html">Creating XML-RPC Servers and Clients with Twisted</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Twisted Web In 60 Seconds</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="static-content.html">Serving Static Content From a Directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-content.html">Generating a Page Dynamically</a></li>
<li class="toctree-l4"><a class="reference internal" href="static-dispatch.html">Static URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic-dispatch.html">Dynamic URL Dispatch</a></li>
<li class="toctree-l4"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom-codes.html">Custom Response Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="handling-posts.html">Handling POSTs</a></li>
<li class="toctree-l4"><a class="reference internal" href="other-request-bodies.html">Other Request Bodies</a></li>
<li class="toctree-l4"><a class="reference internal" href="rpy-scripts.html">rpy scripts (or, how to save yourself some typing)</a></li>
<li class="toctree-l4"><a class="reference internal" href="asynchronous.html">Asynchronous Responses</a></li>
<li class="toctree-l4"><a class="reference internal" href="asynchronous-deferred.html">Asynchronous Responses (via Deferred)</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupted.html">Interrupted Responses</a></li>
<li class="toctree-l4"><a class="reference internal" href="logging-errors.html">Logging Errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="access-logging.html">Access Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="wsgi.html">WSGI</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-auth.html">HTTP Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-basics.html">Session Basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="session-store.html">Storing Objects in the Session</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Session Endings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../resource-templates.html">Light Weight Templating With Resource Templates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client.html">Using the Twisted Web Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../words/index.html">Twisted Words (IRC and XMPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/index.html">Development of Twisted</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../historic/index.html">Historical Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Quick links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html">Report a security issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-procedure-for-developers">Security Procedure for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security.html#security-audit">Security Audit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community.html">Twisted Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/twisted/twisted">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/twisted">PyPI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Twisted</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Twisted Web</a> &raquo;</li>
          <li><a href="../index.html">Developer Guides</a> &raquo;</li>
          <li><a href="index.html">Twisted Web In 60 Seconds</a> &raquo;</li>
      <li>Session Endings</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/web/howto/web-in-60/session-endings.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="session-endings">
<h1>Session Endings<a class="headerlink" href="#session-endings" title="Permalink to this heading"></a></h1>
<p>The previous two examples introduced Twisted Web’s session APIs. This
included accessing the session object, storing state on it, and retrieving it
later, as well as the idea that the <code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code> object has a lifetime which is tied to
the notional session it represents. This example demonstrates how to exert some
control over that lifetime and react when it expires.</p>
<p>The lifetime of a session is controlled by the <code class="docutils literal notranslate"><span class="pre">sessionTimeout</span></code>
attribute of the <code class="docutils literal notranslate"><span class="pre">Session</span></code> class. This attribute gives the number of
seconds a session may go without being accessed before it expires. The default
is 15 minutes. In this example we’ll change that to a different value.</p>
<p>One way to override the value is with a subclass:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">ShortSession</span><span class="p">(</span><span class="n">Session</span><span class="p">):</span>
    <span class="n">sessionTimeout</span> <span class="o">=</span> <span class="mi">60</span>
</pre></div>
</div>
<p>To have Twisted Web actually make use of this session class, rather
than the default, it is also necessary to override
the <code class="docutils literal notranslate"><span class="pre">sessionFactory</span></code> attribute of <code class="xref py py-class docutils literal notranslate"><span class="pre">Site</span></code> . We could do this with another
subclass, but we could also do it to just one instance
of <code class="docutils literal notranslate"><span class="pre">Site</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Site</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">rootResource</span><span class="p">)</span>
<span class="n">factory</span><span class="o">.</span><span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">ShortSession</span>
</pre></div>
</div>
<p>Sessions given out for requests served by this <code class="docutils literal notranslate"><span class="pre">Site</span></code> will
use <code class="docutils literal notranslate"><span class="pre">ShortSession</span></code> and only last one minute without activity.</p>
<p>You can have arbitrary functions run when sessions expire,
too. This can be useful for cleaning up external resources associated
with the session, tracking usage statistics, and more. This
functionality is provided via <code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.notifyOnExpire</span></code> . It accepts a
single argument: a function to call when the session expires. Here’s a
trivial example which prints a message whenever a session expires:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>

<span class="k">class</span> <span class="nc">ExpirationLogger</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">notifyOnExpire</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expired</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;has expired.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</pre></div>
</div>
<p>Keep in mind that using a method as the callback will keep the instance (in
this case, the <code class="docutils literal notranslate"><span class="pre">ExpirationLogger</span></code> resource) in memory until the
session expires.</p>
<p>With those pieces in hand, here’s an example that prints a message whenever a
session expires, and uses sessions which last for 5 seconds:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.web.server</span> <span class="kn">import</span> <span class="n">Site</span><span class="p">,</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">twisted.web.resource</span> <span class="kn">import</span> <span class="n">Resource</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">endpoints</span>

<span class="k">class</span> <span class="nc">ShortSession</span><span class="p">(</span><span class="n">Session</span><span class="p">):</span>
    <span class="n">sessionTimeout</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">class</span> <span class="nc">ExpirationLogger</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
    <span class="n">sessions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">render_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">notifyOnExpire</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expired</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Session&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;has expired.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

<span class="n">rootResource</span> <span class="o">=</span> <span class="n">Resource</span><span class="p">()</span>
<span class="n">rootResource</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;logme&quot;</span><span class="p">,</span> <span class="n">ExpirationLogger</span><span class="p">())</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">Site</span><span class="p">(</span><span class="n">rootResource</span><span class="p">)</span>
<span class="n">factory</span><span class="o">.</span><span class="n">sessionFactory</span> <span class="o">=</span> <span class="n">ShortSession</span>

<span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoints</span><span class="o">.</span><span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>
<span class="n">endpoint</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">Site</span></code> customization is required, this example can’t be
rpy-based, so it brings back the manual <code class="docutils literal notranslate"><span class="pre">endpoints.TCP4ServerEndpoint</span></code>
and <code class="docutils literal notranslate"><span class="pre">reactor.run</span></code> calls. Run it and visit <code class="docutils literal notranslate"><span class="pre">/logme</span></code> to see
it in action. Keep visiting it to keep your session active. Stop visiting it for
five seconds to see your session expiration message.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="session-store.html" class="btn btn-neutral float-left" title="Storing Objects in the Session" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../resource-templates.html" class="btn btn-neutral float-right" title="Light Weight Templating With Resource Templates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Twisted Matrix Labs. Ver 22.8.0.post0. Built on 2022-09-09.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>